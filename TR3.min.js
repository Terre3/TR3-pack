"use strict";var TR3=new Object,THREE=new Object;function isMobile(){var e,t=!1;return e=navigator.userAgent||navigator.vendor||window.opera,t=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))?!0:t}function isTouch(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}}function isIE(){var e=navigator.userAgent.toLowerCase();return-1!=e.indexOf("msie")?parseInt(e.split("msie")[1]):100}function isLandscape(){return window.innerWidth>window.innerHeight}TR3.version="rev:2.121.10",TR3.imgOri=!1,TR3.imgDesty=!1,TR3.lock3d=!1,TR3.config=new Object,"undefined"!=typeof IIIkel?TR3.config=IIIkel.config.TR3:TR3.config={unic:!0,src:!1,flag3d:!0,rotate:!1,lookAt:!1,magni:"auto",spritesDskMvl:1,zoomMapDskMvl:0},TR3.setLoader=function(e,t){TR3.config.src=e=void 0===e?"":e,THREE=t.THREE||THREE,TR3.OrbitControls=t.OrbitControls||OrbitControls||THREE.OrbitControls,TR3.TransformControls=t.TransformControls||TransformControls||THREE.TransformControls,TR3.SkeletonUtilsClone=t.SkeletonUtilsClone||SkeletonUtilsClone||THREE.SkeletonUtilsClone,TR3.GLTFExporter=t.GLTFExporter||GLTFExporter||THREE.GLTFExporter,TR3.GLTFLoader=t.GLTFLoader||GLTFLoader||THREE.GLTFLoader,TR3.IFCLoader=t.IFCLoader||IFCLoader||THREE.IFCLoader,TR3.FontLoader=t.FontLoader||FontLoader||THREE.FontLoader,TR3.TextGeometry=t.TextGeometry||TextGeometry||THREE.TextGeometry,TR3.Sky=t.Sky||Sky||THREE.Sky},TR3.setPanel=function(){return'\t\t\t\t<div id="3doptions" style="border: solid;margin: 5px; padding: 5px; display: none;float:left">\t\t\t\t\t<label id="lblSroOpt" style="font-weight: bold;margin-bottom: 5px;border: solid 2px royalblue;text-align: center;color: royalblue;cursor: pointer">▲ Herramientas 3D ▲</label>\t\t\t\t\t<div id="sroOpt" style="display:none">\t\t\t\t\t\t<div id="magnificationSliderValue">Exagerar x</div>\t\t\t\t\t\t<input type="button" class="magniStep" style="float:left" value="&nbsp;-&nbsp;"><div id="magnificationSlider" style="float:left;width:95px;margin:4px"></div><input type="button" class="magniStep" style="float:left" value="+">\t\t\t\t\t\t<label style="width:150px;float:left"><input class="changeOpt" id="cursorCheck" type="checkbox"><span id="cursorCheck_spm">▲ 3D Cursor ▲</span></label><br>\t\t\t\t\t\t<div id="cursorCheck_div" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%">\t\t\t\t\t\t\t<input id="newLine" style="float:left;" type="button" value=" Línea " class="">\t\t\t\t\t\t\t<input id="newPolig" style="float:left;" type="button" value=" Polígono " class="">\t\t\t\t\t\t\t<div><input id="metrics" type="checkbox" style="margin:3px 0 3px 3px">Medir</div>\t\t\t\t\t\t\t<input id="calcMetrics" type="button" value="Calcular Métricas"><br>\t\t\t\t\t\t\t<input id="PickDrawStereo" type="text" style="width: 75px;height: 29px"; value="#ff6161">\t\t\t\t\t\t\t<input id="del_vGeom" type="button" value="Borrar Todo" class="">\t\t\t\t\t\t\t\x3c!--<span>Valor de Z: </span><input id="setZ" type="text" style="width: 50px;" value=""><span id="helpSetZ" style="color:royalblue;text-decoration:underline;cursor:pointer">Ayuda</span>--\x3e\t\t\t\t\t\t</div>\t\t\t\t\t\t<label style="width:150px;float:left"><input class="changeOpt" id="anaglyphCheck" type="checkbox"><span id="anaglyphCheck_spm">▲ Stereo 3D ▲</span></label>\t\t\t\t\t\t<div id="anaglyphType" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%">\t\t\t\t\t\t\t<span>&nbsp;-&nbsp;Modo: </span><select id="anaglyph-type" onchange="TR3.changeAnaglyphType()">\t\t\t\t\t\t\t\t<option value="optimiced">Optimizado</option>\t\t\t\t\t\t\t\t<option value="normal">Normal</option>\t\t\t\t\t\t\t\t<option value="half">Intermedio</option>\t\t\t\t\t\t\t\t<option value="gray">Gris</option>\t\t\t\t\t\t\t\t<option value="interlaced">Entrelazado</option>\t\t\t\t\t\t\t</select>\t\t\t\t\t\t\t<a target="_blank" href="'+TR3.config.src+'docStereo.pdf">Gafas 3d</a>\t\t\t\t\t\t</div>\t\t\t\t\t\t<label style="width:150px;float:left"><input class="" id="geomCheck" type="checkbox"><span id="geomCheck_spm">▲ Gemoetrías ▲</span></label>\t\t\t\t\t\t<div id="geomCheck_div" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%">\t\t\t\t\t\t\t<span>&nbsp;-&nbsp;Geometry: </span><select id="geometry-type" onchange="TR3.geometryBySelect()">\t\t\t\t\t\t\t\t<option value="Width,Height,Depth">Box</option>\t\t\t\t\t\t\t\t<option value="RadiusUnique,Segments,ThetaStart,ThetaLength">Circle</option>\t\t\t\t\t\t\t\t<option value="RadiusUnique,Height,Segments,ThetaStart,ThetaLength,OpenEnded">Cone</option>\t\t\t\t\t\t\t\t<option value="RadiusTop,RadiusBottom,Height,Segments,ThetaStart,ThetaLength,OpenEnded">Cylinder</option>\t\t\t\t\t\t\t\t<option value="Width,Height">Plane</option>\t\t\t\t\t\t\t\t<option value="RadiusUnique,Wsegments,Hsegments,ThetaStart,ThetaLength,PhiStart,PhiLength">Sphere</option>\t\t\t\t\t\t\t\t<option value="RadiusUnique,Wsegments,Hsegments">SemiSphere</option>\t\t\t\t\t\t\t</select>\t\t\t\t\t\t\t<div id="geoOpts_div">\t\t\t\t\t\t\t\t<div id="geomDepth_div" style="display: block;">\t\t\t\t\t\t\t\t\t<label>Width: </label>\t\t\t\t\t\t\t\t\t<input id="geomDepth_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomHeight_div" style="display: block;">\t\t\t\t\t\t\t\t\t<label>Height: </label>\t\t\t\t\t\t\t\t\t<input id="geomHeight_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomWidth_div" style="display: block;">\t\t\t\t\t\t\t\t\t<label>Depth: </label>\t\t\t\t\t\t\t\t\t<input id="geomWidth_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomRadiusUnique_div" style="display: none;">\t\t\t\t\t\t\t\t\t<label>Radius: </label>\t\t\t\t\t\t\t\t\t<input id="geomRadiusUnique_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomRadiusTop_div" style="display: none;">\t\t\t\t\t\t\t\t\t<label>RadiusTop: </label>\t\t\t\t\t\t\t\t\t<input id="geomRadiusTop_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomRadiusBottom_div" style="display: none;">\t\t\t\t\t\t\t\t\t<label>RadiusBottom: </label>\t\t\t\t\t\t\t\t\t<input id="geomRadiusBottom_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomSegments_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomSegments_value">Segments: 32</div>\t\t\t\t\t\t\t\t\t<div id="geomSegments_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomWsegments_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomWsegments_value">WidthSegments: 32</div>\t\t\t\t\t\t\t\t\t<div id="geomWsegments_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomHsegments_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomHsegments_value">HeightSegments: 32</div>\t\t\t\t\t\t\t\t\t<div id="geomHsegments_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomPhiStart_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomPhiStart_value">PhiStart: 0</div>\t\t\t\t\t\t\t\t\t<div id="geomPhiStart_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomPhiLength_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomPhiLength_value">PhiLength: 6.283</div>\t\t\t\t\t\t\t\t\t<div id="geomPhiLength_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomThetaStart_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomThetaStart_value">ThetaStart: 0</div>\t\t\t\t\t\t\t\t\t<div id="geomThetaStart_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomThetaLength_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomThetaLength_value">ThetaLength: 6.283</div>\t\t\t\t\t\t\t\t\t<div id="geomThetaLength_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomOpenEnded_div" style="display: none;">\t\t\t\t\t\t\t\t\t<label>OpenEnded: </label>\t\t\t\t\t\t\t\t\t<input id="geomOpenEnded_value" type="checkbox">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t<input id="newGeom" type="button" value=" Insertar Geometría " style="margin:0px 0px 5px 10px" class=""></br>\t\t\t\t\t\t</div>\t\t\t\t\t\t<label style="width:150px;float:left"><input class="" id="physicsCheck" type="checkbox"><span id="physics_spm">▲ Físicas ▲</span></label>\t\t\t\t\t\t<div id="physicsDiv" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%;height:150px;overflow:auto;">\t\t\t\t\t\t\t<hr><p style="margin:5px"><b>▼ Dispersión ▼</b></p><hr>\t\t\t\t\t\t\t<span>Cobertura: </span><input id="coverZone" type="text" style="width: 65px;" value="5">\t\t\t\t\t\t\t<span>Tamaño: </span><input id="sizePtlZone" type="text" style="width: 65px;" value="1">\t\t\t\t\t\t\t<span>Masa: </span><input id="massPtlZone" type="text" style="width: 65px;" value="150">\t\t\t\t\t\t\t<span>Dirección: </span><input id="dirPtlZone" type="text" style="width: 65px;" value="0,0,0">\t\t\t\t\t\t\t<span>Impulso: </span><input id="impulsePtlZone" type="text" style="width: 65px;" value="15">\t\t\t\t\t\t\t<input id="rainPhy" type="button" value=" Dispersar " style="margin:5px 15px" class="">\t\t\t\t\t\t\t<hr><p style="margin:5px"><b>▼ Puntos de brote ▼</b></p><hr>\t\t\t\t\t\t\t<span>Cantidad: </span><input id="manyPtlEmisor" type="text" style="width: 65px;" value="1">\t\t\t\t\t\t\t<span>Impulso: </span><input id="impulsePtlEmisor" type="text" style="width: 65px;" value="30">\t\t\t\t\t\t\t<span>Tamaño: </span><input id="sizePtlEmisor" type="text" style="width: 65px;" value="1">\t\t\t\t\t\t\t<span>Masa: </span><input id="massPtlEmisor" type="text" style="width: 65px;" value="150">\t\t\t\t\t\t\t<input id="setEmisor" type="button" value="Insertar" style="margin:5px 0px 0px 5px;padding: 0px;" class="">\t\t\t\t\t\t\t<input id="goEmisor" type="button" value="Emitir" style="padding: 0px;" class="">\t\t\t\t\t\t\t<input id="stopGoEmisor" type="button" value="Parar" style="padding: 0px;" class="">\t\t\t\t\t\t\t<input id="removeEmisors" type="button" value="Borrar Todos" style="padding: 0px;" class="">\t\t\t\t\t\t\t<hr><p style="margin:5px"><b>▼ Bola ▼</b></p><hr>\t\t\t\t\t\t\t<span>Impulso: </span><input id="impulsePtlBall" type="text" style="width: 65px;" value="30">\t\t\t\t\t\t\t<span>Tamaño: </span><input id="sizePtlBall" type="text" style="width: 65px;" value="1">\t\t\t\t\t\t\t<span>Masa: </span><input id="massPtlBall" type="text" style="width: 65px;" value="150">\t\t\t\t\t\t\t<input id="goPscBall" type="button" value=" Emitir " style="margin:5px 15px" class="">\t\t\t\t\t\t\t<hr><p style="margin:5px"><b>▼ General ▼</b></p><hr>\t\t\t\t\t\t\t<span>Gravedad: </span><input id="gravityZone" type="text" style="width: 65px;" value="9.8">\t\t\t\t\t\t\t<input id="clearPscsObjs" type="button" value=" Limpiar Partículas " style="margin:5px 0px 0px 10px;" class="">\t\t\t\t\t\t\t<input id="updateGround" type="button" value=" Actualizar Terreno " style="margin-left:10px" class="">\t\t\t\t\t\t\t<input id="updatePscs" type="button" value=" Actualizar Físicas " style="margin-left:10px" class=""><hr>\t\t\t\t\t\t</div>\t\t\t\t\t\t<label style="width:150px;float:left"><input class="" id="textIntoCheck" type="checkbox"><span id="textInto_spm">▲ Texto ▲</span></label>\t\t\t\t\t\t<div id="textIntoDiv" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%;">\t\t\t\t\t\t\t<input id="minicolorText" type="text" style="width: 75%;height: 29px"; value="#ff6161">\t\t\t\t\t\t\t<input id="inputTextInto" type="text" style="width: 100%;" placeholder="Añadir texto">\t\t\t\t\t\t\t<input id="buttonTextInto" type="button" value="Insertar" style="" class="">\t\t\t\t\t\t\t<input id="selectText" type="button" value="Seleccionar" style="" class="">\t\t\t\t\t\t\t<input id="updateText" type="button" value="Actualizar" style="" class="">\t\t\t\t\t\t</div>\t\t\t\t\t\t<label style="width:150px;float:left"><input class="" id="lightIntoCheck" type="checkbox"><span id="lightInto_spm">▲ Punto de Luz ▲</span></label>\t\t\t\t\t\t<div id="lightIntoDiv" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%;">\t\t\t\t\t\t\t<input id="minicolorLight" type="text" style="width: 75%;height: 29px"; value="#ff6161">\t\t\t\t\t\t\t<span>Intensidad: </span><input id="intensLight" type="text" style="width: 65px;" value="1">\t\t\t\t\t\t\t<span>Distancia: </span><input id="distLight" type="text" style="width: 65px;" value="100">\t\t\t\t\t\t\t<input id="buttonLightInto" type="button" value="Insertar" style="" class="">\t\t\t\t\t\t\t<input id="selectLight" type="button" value="Seleccionar" style="" class="">\t\t\t\t\t\t\t<input id="updateLight" type="button" value="Actualizar" style="" class="">\t\t\t\t\t\t</div>\t\t\t\t\t\t<div style="float:left">\t\t\t\t\t\t\t<input id="file_3d" type="file" accept=".glb,.ifc" style="opacity: 0; position: absolute; width: 100px;">\t\t\t\t\t\t\t<input id="file_3d_fake" style="color: gray; width: 100px;" value=" Explorar GLB/IFC... ">\t\t\t\t\t\t\t<span id="help3dObj" style="color:coral;text-decoration:underline;cursor:pointer"> ¡Ayuda!</span><br>\t\t\t\t\t\t\t<span>&nbsp;- Exportación ⇩ </span><select id="exporter-type" >\t\t\t\t\t\t\t\t<option value="terrain">Terreno</option>\t\t\t\t\t\t\t\t<option value="scene">Todo</option>\t\t\t\t\t\t\t\t<option value="selected">Seleccionado</option>\t\t\t\t\t\t\t</select>\t\t\t\t\t\t\t<input id="exportation" type="button" value="Exportar" onclick="TR3.changeExportType()">\t\t\t\t\t\t\t<label id="size3dObj"></label>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t\t<div id="orbitalMoves" style="text-align: center; box-shadow: rgb(136, 136, 136) 1px 1px 5px; border: medium outset #eee; float: left;">\t\t\t\t\t\t<img id="imgOrbitalMoves" src="'+TR3.config.src+'img/eartharrow.png" draggable="false" style="margin: 5px;cursor:pointer"><br>\t\t\t\t\t\t<input id="makeScene" type="button" value=" Restablecer " style="margin-bottom:5px" class=""><br>\t\t\t\t\t\t<input id="pWalking" type="button" value=" Caminar " style="" class="">\t\t\t\t\t\t<input id="pFlying" type="button" value=" &nbsp;Volar&nbsp; " style="" class="">\t\t\t\t\t\t<input id="orbitPoint" type="button" value=" Orbitar " style="" class="">\t\t\t\t\t\t<div id="exploreDiv" style="display:none">\t\t\t\t\t\t\t<div id="personFlySliderDiv" style="display:none">\t\t\t\t\t\t\t\t<div id="heightSliderValue">Altitud: </div>\t\t\t\t\t\t\t\t<div id="heightSlider" style="margin:5px"></div></div>\t\t\t\t\t\t\t<input id="lessV" type="button" value="- Velocidad"><input id="moreV" type="button" value="+ Velocidad">\t\t\t\t\t\t\t<label style="font-weight: bold; margin: 5px;color: brown;">Camina y Vuela con las flechas de teclado</label>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div style="text-align: left; margin: 5px">\t\t\t\t\t\t\t<input id="autoRotate" type="checkbox" class="changeOpt"> Rotación \t\t\t\t\t\t\t<input id="malla" type="checkbox" class="changeOpt"> Malla<br>\t\t\t\t\t\t\t<input id="tentative" type="checkbox" class="changeOpt" checked> Tentativo\t\t\t\t\t\t\t<input id="terrain" type="checkbox" class="changeOpt"> Terreno\t\t\t\t\t\t</div>\t\t\t\t\t</div>'+'<div id="advices"></div></div><img id="imgErrTR3evt" src onerror="TR3.setEvtPanel()">'},TR3.setEvtPanel=function(){$("#magnificationSlider").slider({min:1,max:15,slide:function(e,t){var o=TR3.formatMeasure(TR3.tPixMesh);$("#magnificationSliderValue").html("Exagerar <b>x"+t.value+"</b> (malla: "+o[0]+o[1]+")"),TR3.setMagniValues(t.value)}}),$("#geomSegments_slider").slider({min:0,max:64,value:32,slide:function(e,t){$("#geomSegments_value").html("Segments: "+t.value)}}),$("#geomWsegments_slider").slider({min:0,max:64,value:32,slide:function(e,t){$("#geomWsegments_value").html("WidthSegments: "+t.value)}}),$("#geomHsegments_slider").slider({min:0,max:64,value:32,slide:function(e,t){$("#geomHsegments_value").html("HeightSegments: "+t.value)}}),$("#geomPhiStart_slider").slider({min:0,max:2*Math.PI,step:.001,value:0,slide:function(e,t){$("#geomPhiStart_value").html("PhiStart: "+t.value)}}),$("#geomPhiLength_slider").slider({min:0,max:2*Math.PI,step:.001,value:2*Math.PI,slide:function(e,t){$("#geomPhiLength_value").html("PhiLength: "+t.value)}}),$("#geomThetaStart_slider").slider({min:0,max:2*Math.PI,step:.001,value:0,slide:function(e,t){$("#geomThetaStart_value").html("ThetaStart: "+t.value)}}),$("#geomThetaLength_slider").slider({min:0,max:2*Math.PI,step:.001,value:2*Math.PI,slide:function(e,t){$("#geomThetaLength_value").html("ThetaLength: "+t.value)}}),$("#heightSlider").slider({min:0,max:1e3,slide:function(e,t){$("#heightSlider").slider("option","max",Math.round((TR3.zMax-TR3.zMed)*TR3.valuesSet.magnification)),$("#heightSlider").slider("option","min",Math.round((TR3.zMin-TR3.zMed)*TR3.valuesSet.magnification)),TR3.changeHeight(t.value,!0,!1),$("#heightSliderValue").html("Altitud: "+Math.round(t.value/TR3.valuesSet.magnification+TR3.zMed)+" m")}}),document.getElementById("lightIntoCheck").addEventListener("click",function(){var e=document.getElementById("lightInto_spm").innerHTML;this.checked?(document.getElementById("lightIntoDiv").style.display="block",document.getElementById("lightInto_spm").innerHTML=e.replaceAll("▲","▼")):(document.getElementById("lightIntoDiv").style.display="none",document.getElementById("lightInto_spm").innerHTML=e.replaceAll("▼","▲"))}),document.getElementById("textIntoCheck").addEventListener("click",function(){var e=document.getElementById("textInto_spm").innerHTML;this.checked?(document.getElementById("textIntoDiv").style.display="block",document.getElementById("textInto_spm").innerHTML=e.replaceAll("▲","▼")):(document.getElementById("textIntoDiv").style.display="none",document.getElementById("textInto_spm").innerHTML=e.replaceAll("▼","▲"))}),document.getElementById("anaglyphCheck").addEventListener("click",function(){var e=document.getElementById("anaglyphCheck_spm").innerHTML;this.checked?(document.getElementById("anaglyphType").style.display="block",document.getElementById("anaglyphCheck_spm").innerHTML=e.replaceAll("▲","▼")):(document.getElementById("anaglyphType").style.display="none",document.getElementById("anaglyphCheck_spm").innerHTML=e.replaceAll("▼","▲"))}),document.getElementById("physicsCheck").addEventListener("click",function(){var e=document.getElementById("physics_spm").innerHTML;this.checked?(document.getElementById("physicsDiv").style.display="block",document.getElementById("physics_spm").innerHTML=e.replaceAll("▲","▼"),TR3.pscs.updateGround()):(document.getElementById("physicsDiv").style.display="none",document.getElementById("physics_spm").innerHTML=e.replaceAll("▼","▲"),TR3.pscs.emiter=!1)}),document.getElementById("cursorCheck").addEventListener("click",function(){var e=document.getElementById("cursorCheck_spm").innerHTML;this.checked?(document.getElementById("cursorCheck_div").style.display="block",document.getElementById("cursorCheck_spm").innerHTML=e.replaceAll("▲","▼"),TR3.lock3d("cursor3d")):(document.getElementById("cursorCheck_div").style.display="none",document.getElementById("cursorCheck_spm").innerHTML=e.replaceAll("▼","▲"),document.getElementById("metrics").checked=!1,TR3.vGeom.measure=!1,TR3.endDraw(),TR3.unlock3d("cursor3d"))},!1),document.getElementById("geomCheck").addEventListener("click",function(){var e=document.getElementById("geomCheck_spm").innerHTML,t=2*TR3.tPixMesh;document.getElementById("geomWidth_value").value=t,document.getElementById("geomHeight_value").value=t,document.getElementById("geomDepth_value").value=t,document.getElementById("geomRadiusUnique_value").value=t,document.getElementById("geomRadiusTop_value").value=t,document.getElementById("geomRadiusBottom_value").value=t,this.checked?(document.getElementById("geomCheck_div").style.display="block",document.getElementById("geomCheck_spm").innerHTML=e.replaceAll("▲","▼"),TR3.lock3d("cursor3d")):(document.getElementById("geomCheck_div").style.display="none",document.getElementById("geomCheck_spm").innerHTML=e.replaceAll("▼","▲"))},!1),document.getElementById("lblSroOpt").addEventListener("click",function(){var e=document.getElementById("sroOpt").style.display,t=document.getElementById("lblSroOpt"),o=t.innerHTML;"none"==e?(document.getElementById("sroOpt").style.display="block",t.innerHTML=o.replaceAll("▲","▼")):(document.getElementById("sroOpt").style.display="none",t.innerHTML=o.replaceAll("▼","▲"))},!1);for(var e={animationSpeed:50,animationEasing:"swing",change:null,changeDelay:0,control:"hue",defaultValue:"",format:"rgb",showSpeed:100,hideSpeed:100,inline:!1,keywords:"",letterCase:"lowercase",opacity:!1,position:"bottom left",theme:"default TR3PickColor",swatches:[]},t=($("#PickDrawStereo").minicolors(e),$("#minicolorText").minicolors(e),$("#minicolorLight").minicolors(e),document.getElementsByClassName("changeOpt")),o=0;o<t.length;o++)t[o].addEventListener("click",TR3.setOpts,!1);document.getElementById("buttonLightInto").addEventListener("click",function(){TR3.vGeom.newLight=!0,TR3.canvasDest.style.cursor="crosshair"},!1),document.getElementById("buttonTextInto").addEventListener("click",function(){TR3.vGeom.newText=!0,TR3.canvasDest.style.cursor="crosshair"},!1),document.getElementById("newGeom").addEventListener("click",function(){TR3.setOpts({cursor3d:!1}),TR3.newGeom=!0,TR3.canvasDest.style.cursor="crosshair"},!1),document.getElementById("stopGoEmisor").addEventListener("click",function(){TR3.pscs.emiter=!1,TR3.canvasDest.style.cursor="default"},!1),document.getElementById("terrain").addEventListener("click",function(){TR3.makeZmesh()},!1),document.getElementById("goPscBall").addEventListener("click",function(){var e=[];e.keyCode="66",TR3.camera.visible=!0,TR3.keyDown(e)},!1),document.getElementById("rainPhy").addEventListener("click",function(){TR3.pscs.rainPhy()},!1),document.getElementById("setEmisor").addEventListener("click",function(){TR3.canvasDest.style.cursor="crosshair",TR3.pscs.emiter=!0},!1),document.getElementById("goEmisor").addEventListener("click",function(){TR3.pscs.emiter=!1,TR3.pscs.goEmisor()},!1),document.getElementById("removeEmisors").addEventListener("click",function(){TR3.pscs.emiter=!1,TR3.pscs.removeEmisors()},!1),document.getElementById("updateGround").addEventListener("click",function(){TR3.pscs.updateGround()},!1),document.getElementById("updatePscs").addEventListener("click",function(){TR3.pscs.getPscsValues()},!1),document.getElementById("clearPscsObjs").addEventListener("click",function(){TR3.pscs.clearPscsObjs()},!1),document.getElementById("makeScene").addEventListener("click",function(){TR3.lightBtn(this.id),TR3.setValuesSliderMagn("auto"),TR3.moving=!1,TR3.initPosCamera(!0),TR3.cursor.helper.scale.set(1,1,1),document.getElementById("exploreDiv").style.display="none",document.getElementById("personFlySliderDiv").style.display="none",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("orbitPoint").addEventListener("click",function(){TR3.lightBtn(this.id),TR3.moving=!1,TR3.orbitalViewFn(),document.getElementById("exploreDiv").style.display="none",document.getElementById("personFlySliderDiv").style.display="none",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("pWalking").addEventListener("click",function(){TR3.lightBtn(this.id),this.blur(),TR3.moveKey.walkClicked=!0,TR3.canvasDest.style.cursor="crosshair",(TR3.optionsSet.imgControl?document.getElementById("imgOrbitalMoves"):document.getElementById("canvasDest")).focus(),document.getElementById("exploreDiv").style.display="block",document.getElementById("personFlySliderDiv").style.display="none",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("pFlying").addEventListener("click",function(){TR3.lightBtn(this.id),TR3.moving=!0;var e=(TR3.zMax-TR3.zMin)/2*TR3.valuesSet.magnification;TR3.personViewFn(e),TR3.setValuesSliderHeight(e),TR3.moveKey.walk=!1,(TR3.optionsSet.imgControl?document.getElementById("imgOrbitalMoves"):document.getElementById("canvasDest")).focus(),document.getElementById("exploreDiv").style.display="block",document.getElementById("personFlySliderDiv").style.display="block",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("metrics").addEventListener("click",function(){document.getElementById("metrics").checked?TR3.vGeom.measure=!0:TR3.vGeom.measure=!1},!1);for(var n=document.getElementById("imgOrbitalMoves"),a=(n.addEventListener("mouseover",function(){n.src=TR3.config.src+"img/eartharrow_over.png"},!1),n.addEventListener("mouseout",function(){n.src=TR3.config.src+"img/eartharrow.png"},!1),document.getElementById("moreV").addEventListener("click",function(){(TR3.optionsSet.imgControl?n:TR3.canvasDest).focus(),TR3.controls.keyPanSpeed=3*TR3.controls.keyPanSpeed},!1),document.getElementById("lessV").addEventListener("click",function(){(TR3.optionsSet.imgControl?n:TR3.canvasDest).focus(),TR3.controls.keyPanSpeed=TR3.controls.keyPanSpeed/3},!1),document.getElementById("newLine").addEventListener("click",function(){TR3.vGeom.polig=!1,TR3.newVgeom()},!1),document.getElementById("newPolig").addEventListener("click",function(){TR3.vGeom.polig=!0,TR3.newVgeom()},!1),document.getElementById("calcMetrics").addEventListener("click",function(){TR3.updateVgeom()},!1),document.getElementById("del_vGeom").addEventListener("click",function(){TR3.del_vGeom(!1,"item"),TR3.del_vGeom(!1,"sprites"),document.getElementById("metrics").checked=!1},!1),document.getElementById("selectText").addEventListener("click",function(){var e=TR3.vGeom.sprites.length,e=Math.floor(Math.random()*e)+0;TR3.transCtrlsEnabled(TR3.vGeom.sprites[e])},!1),document.getElementById("updateText").addEventListener("click",function(){var e,t=TR3.transformControls.object;t&&(e=t.position,TR3.del3dObj(t,TR3.vGeom.sprites),t=document.getElementById("inputTextInto").value,(t=TR3.formatedText(t||"hey!",$("#minicolorText").val(),e)).position.set(e.x,e.y,e.z),TR3.scene.add(t),TR3.transCtrlsEnabled(t),TR3.onCreateItem(t))},!1),document.getElementById("selectLight").addEventListener("click",function(){var e=TR3.vGeom.lights.length,e=Math.floor(Math.random()*e)+0;0<TR3.vGeom.lights.length&&TR3.transCtrlsEnabled(TR3.vGeom.lights[e][0])},!1),document.getElementById("updateLight").addEventListener("click",function(){var e,t,o,n=TR3.transformControls.object;n&&(e=n.position,TR3.del3dObj(n,TR3.vGeom.lights),n=$("#minicolorLight").val()||"#ffffff",t=document.getElementById("intensLight").value||1,o=document.getElementById("distLight").value||100,(n=TR3.setLight(n,t,o))[0].position.set(e.x,e.y,e.z),TR3.scene.add(n[0]),TR3.scene.add(n[1]),TR3.transCtrlsEnabled(n[0]),TR3.onCreateItem(n[0]))},!1),document.getElementById("file_3d").addEventListener("change",function(e){TR3.handleFileSelect(e)},!1),$("#advices").dialog({position:{my:"left center",at:"left center",of:window},title:"Información",autoOpen:!1,width:400}),document.getElementById("help3dObj").addEventListener("click",function(){document.getElementById("advices").innerHTML='<div id="infohelp3dObj" style="padding:10px">\t\t\t\t\t\t<div align="center"><u>Operaciones y Transformaciones:</u></div><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(87)" value="W"> Trasladar | <input type="button" onclick="TR3.UpdateKeys3D(69)" value="E"> Rotar | <input type="button" onclick="TR3.UpdateKeys3D(82)" value="R"> Escalar <I>·objeto·</I><br />\t\t\t\t\t\t<br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(107)" value="+"> Aumentar | <input type="button" onclick="TR3.UpdateKeys3D(109)" value="-"> Disminuir <I>·ejes·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(27)" value="Esc"> Desactiva herramienta<br />\t\t\t\t\t\t<br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(46)" value="Supr"> Elimina <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(32)" value="Space"> Deselecciona <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(76)" value="L"> Información geométrica del <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(71)" value="G"> Ver geometría de Malla <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(70)" value="F"> Influir sobre el terreno con el <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(88)" value="X"> El <I>·objeto·</I> es eferencia en métricas de volumen<br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(86)" value="V"> Visibilidad <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(84)" value="T"> Transparencia <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(79)" value="O"> Baja al suelo el <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(65)" value="A"> Clona <I>·objeto·</I> <br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(67)" value="C"> Recorta <I>·objeto·</I> + Rueda ratón <br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(73)" value="I"> Impulsar <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(77)" value="M"> Dotar de masa <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(90)" value="z"> Animar <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(83)" value="s"> Cambiar material <I>·objeto·</I><br />\t\t\t\t\t\t<br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(85)" value="U"> Sube en primera persona <br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(68)" value="D"> Baja en primera persona <br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(80)" value="P"> Target de movimientos en cursor <br />\t\t\t\t\t</div>',$("#advices").dialog("open")},!1),document.getElementsByClassName("magniStep")),r=$("#magnificationSlider").slider("option","min"),s=$("#magnificationSlider").slider("option","max"),o=0;o<a.length;o++)a[o].addEventListener("click",function(e){var e=e.target.value,t=TR3.valuesSet.magnification;-1!=e.indexOf("+")?TR3.setValuesSliderMagn(t=s<(t+=1)?s:t):TR3.setValuesSliderMagn(t=(t-=1)<r?r:t)})},TR3.lightBtn=function(e){for(var t=document.getElementsByClassName("btnDrawOn"),o=0;o<t.length;o++)t[o].style.border="",t[o].className="";"makeScene"==e&&(e="orbitPoint"),document.getElementById(e).className="btnDrawOn",document.getElementById(e).style.border="solid 2px"},TR3.setStart=function(e){TR3.params=e,TR3.dfd_setMap=$.Deferred();var t=!!(e=void 0===e?{}:e).hasOwnProperty("oriImg")&&e.oriImg,o=!!e.hasOwnProperty("oriDTM")&&e.oriDTM,n=(TR3.map=!!e.hasOwnProperty("desty")&&e.desty,!!e.hasOwnProperty("bbox")&&e.bbox),e=(TR3.srsImg=e.hasOwnProperty("projCode")?e.projCode:"EPSG:3857",TR3.LyrFeatFromOri=!!e.hasOwnProperty("LyrFeat")&&e.LyrFeat,TR3.cameraDist=e.hasOwnProperty("cameraDist")?e.cameraDist:1,"object"==typeof t||(t=document.getElementById(t))||alert("invalid Origin"),"object"!=typeof TR3.map&&(TR3.map=document.getElementById(TR3.map),TR3.map||alert("invalid Destiny")),TR3.getOptions()),a=TR3.getValues();return TR3.setValues(a),TR3.setMeshMap(t,o,n,e,{magnification:a.magnification,lookAt:TR3.config.lookAt}),TR3.config.lookAt=!1,TR3.setValuesSliderMagn(a),TR3.config.magni="auto",TR3.vGeom.measure=!1,TR3.startAnimation(),document.getElementById("metrics").checked=!1,document.getElementById("exploreDiv").style.display="none",document.getElementById("personFlySliderDiv").style.display="none",TR3.dfd_setMap.promise()},TR3.getOptions=function(){var e="none"!=document.getElementById("imgOrbitalMoves").style.display,t=!!document.getElementById("cursorCheck")&&document.getElementById("cursorCheck").checked,o=!!document.getElementById("anaglyphCheck")&&document.getElementById("anaglyphCheck").checked,n=!!document.getElementById("autoRotate")&&document.getElementById("autoRotate").checked;return{imgControl:e,cursor3d:t,anaglyph:o,autoRotate:n=1==TR3.config.rotate?!(TR3.config.rotate=0):n,wireframeMesh:!!document.getElementById("malla")&&document.getElementById("malla").checked,tentative:!!document.getElementById("tentative")&&document.getElementById("tentative").checked,terrain:!!document.getElementById("terrain")&&document.getElementById("terrain").checked}},TR3.setOpts=function(e){var t=TR3.getOptions();e&&(null!=e.imgControl&&(t.imgControl=e.imgControl),null!=e.cursor3d&&(t.cursor3d=e.cursor3d),null!=e.anaglyph&&(t.anaglyph=e.anaglyph),null!=e.autoRotate&&(t.autoRotate=e.autoRotate),null!=e.wireframeMesh&&(t.wireframeMesh=e.wireframeMesh),null!=e.tentative&&(t.tentative=e.tentative),null!=e.terrain)&&(t.terrain=e.terrain),TR3.setOptions(t.imgControl,t.cursor3d,t.anaglyph,t.autoRotate,t.wireframeMesh,t.tentative,t.terrain)},TR3.setOptions=function(e,t,o,n,a,r,s){var i,l;document.getElementById("imgOrbitalMoves").style.display=1==e?"inline":"none",document.getElementById("cursorCheck").checked=1==t,document.getElementById("malla").checked=1==a,document.getElementById("autoRotate").checked=1==n,document.getElementById("anaglyphCheck").checked=1==o,document.getElementById("tentative").checked=1==r,document.getElementById("terrain").checked=1==s,TR3.canvasDest&&(i=document.getElementById("infoGeo3d"),l=document.getElementById("cursorCheck_div"),s!==TR3.optionsSet.terrain&&TR3.setStart(TR3.params),t!==TR3.optionsSet.cursor3d&&(1==t?(l.style.display="block",i.style.display="block",TR3.canvasDest.style.cursor="none",TR3.cursor.helper.visible=!0,TR3.controls.enableZoom=!1):(l.style.display="none",(i.style.display="none")===TR3.canvasDest.style.cursor&&(TR3.canvasDest.style.cursor="default"),TR3.cursor.helper.visible=!1,TR3.controls.enableZoom=!0)),a!==TR3.optionsSet.wireframeMesh&&(TR3.mesh.material.wireframe=1==a),n!==TR3.optionsSet.autoRotate&&(TR3.controls.autoRotate=1==n),o!==TR3.optionsSet.anaglyph&&1==o&&(l=TR3.getRayCaster(!1),0<(i=TR3.getIntersect(l,[TR3.mesh])).length)&&i[0][0]&&i[0][0].point&&(l=TR3.camera.position,TR3.zeroParallax=l.distanceTo(i[0][0].point)),TR3.optionsSet={imgControl:e,cursor3d:t,anaglyph:o,autoRotate:n,wireframeMesh:a,tentative:r,terrain:s}),TR3.optionsSet.terrain=s},TR3.setValues=function(values){var magni,magnific;values.magnification&&(magni=values.magnification,magnific="auto","number"!=typeof Number(magni)||isNaN(magni)||(magnific=eval(magni)),TR3.config.magni=magnific,TR3.setValuesSliderMagn(magnific)),values.reducDTM&&(TR3.reducDTM=values.reducDTM)},TR3.getValues=function(){var e=new Object;return e.magnification=TR3.config.magni,e},TR3.changeAnaglyphType=function(){TR3.anaglyphType=document.getElementById("anaglyph-type").value,TR3.anaglyphRenderer.updateAnaglyphType(TR3.scene,TR3.camera)},TR3.changeExportType=function(){var e=document.getElementById("exporter-type").value;"null"!=e&&TR3.exportGLTF(e)},TR3.setValuesSliderMagn=function(e){e&&0<e&&e<51?TR3.setMagniValues(e):e="auto"==e?TR3.setMagniValues():TR3.valuesSet.magnification,$("#magnificationSlider").slider("value",e);var t=TR3.formatMeasure(TR3.tPixMesh);$("#magnificationSliderValue").html("Exagerar <b>x"+e+"</b> (malla: "+t[0]+" "+t[1]+")")},TR3.setValuesSliderHeight=function(e){$("#heightSlider").slider("value",e),$("#heightSlider").slider("option","max",Math.round((TR3.zMax-TR3.zMed)*TR3.valuesSet.magnification)),$("#heightSlider").slider("option","min",Math.round((TR3.zMin-TR3.zMed)*TR3.valuesSet.magnification)),$("#heightSliderValue").html("Altitud: "+Math.round(e/TR3.valuesSet.magnification+TR3.zMed)+" m")},TR3.geometryBySelect=function(){for(var e=$("#geometry-type")[0].value.split(","),t=$("#geoOpts_div")[0].children,o=0;o<t.length;o++){t[o].style.display="none";for(var n=0;n<e.length;n++)-1!=t[o].id.indexOf(e[n])&&(t[o].style.display="block")}},TR3.setGeomBySelect=function(){for(var e,t=$("#geometry-type")[0],o=new Object,n=0;n<t.length;n++)!0===t[n].selected&&(e=t[n].innerHTML);for(var a=$("#geoOpts_div")[0].children,n=0;n<a.length;n++){var r,s=a[n].children;0<s.length&&("DIV"===a[n].tagName&&s[1].value?o[(r=s[0].innerHTML.replaceAll(":","").replaceAll(" ","")).charAt(0).toLowerCase()+r.slice(1)]=+s[1].value:o[(r=s[0].innerHTML.split(":"))[0].charAt(0).toLowerCase()+r[0].slice(1)]=+r[1])}o.geometry=e,o.openEnded=$("#geomOpenEnded_value")[0].checked;var i=TR3.setGeometry(o,"",{transform:!0,slctItem:!0}),l=(o.height||(o.height=0),i.position.set(TR3.cursor.coordClick.x,TR3.cursor.coordClick.y+o.height/2*TR3.adjustScale,TR3.cursor.coordClick.z),i.scale.set(TR3.adjustScale,TR3.adjustScale,TR3.adjustScale),TR3.getSizeObj(i));document.getElementById("size3dObj").innerHTML="<b>X:</b>"+(+l[0][0]/TR3.adjustScale).toFixed(2)+l[0][1]+" <b>Y:</b>"+(+l[2][0]/TR3.adjustScale).toFixed(2)+l[2][1]+" <b>Z:</b>"+(+l[1][0]/TR3.adjustScale).toFixed(2)+l[1][1],TR3.scene.add(i)};var Detector={isMobile:isMobile(),isTablet:!isMobile()&&isTouch(),isTouch:isTouch(),isIE:isIE(),isLandscape:isLandscape(),canvas:!!window.CanvasRenderingContext2D,webgl:function(){if(-1!=window.navigator.userAgent.indexOf("Windows NT 5")||isIE()<10)return!1;try{var e=document.createElement("canvas");return!!window.WebGLRenderingContext&&(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=(window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.']:['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.']).join("\n")),e},addGetWebGLMessage:function(e){var t,o=void 0!==(e=e||{}).parent?e.parent:document.body,e=void 0!==e.id?e.id:"oldie";(t=Detector.getWebGLErrorMessage()).id=e,o.appendChild(t)}},wmsMap=new Object,Datum_axis=(wmsMap.transCoord=function(){},{ED50:[6378388,6356911.946],WGS84:[6378137,6356752.314],ETRS89:[6378137,6356752.314],WGS72:[6378135,6356750.52],OSGB36:[6377563.396,6356256.909]}),datToDat={ETRS89toED50Pen:{tx:131.032,ty:100.251,tz:163.354,s:-939e-8,rx:-3455e-7,ry:-54166e-10,rz:-.0003176666},ED50toETRS89Pen:{tx:-131.032,ty:-100.251,tz:-163.354,s:939e-8,rx:3455e-7,ry:54166e-10,rz:.0003176666},ETRS89toED50Bal:{tx:181.4609,ty:90.2931,tz:187.1902,s:-1757e-8,rx:39861e-9,ry:136722e-9,rz:-109306e-9},ED50toETRS89Bal:{tx:-181.4609,ty:-90.2931,tz:-187.1902,s:1757e-8,rx:-39861e-9,ry:-136722e-9,rz:109306e-9},ETRS89toED50NWP:{tx:178.383,ty:83.172,tz:221.293,s:-212e-7,rx:150028e-9,ry:-14775e-8,rz:-35083e-9},ED50toETRS89NWP:{tx:-178.383,ty:-83.172,tz:-221.293,s:212e-7,rx:-150028e-9,ry:14775e-8,rz:35083e-9},WGS84toED50:{tx:89.5,ty:93.8,tz:123.1,s:-12e-7,rx:0,ry:0,rz:-433e-7},ED50toWGS84:{tx:-89.5,ty:-93.8,tz:-123.1,s:12e-7,rx:0,ry:0,rz:433e-7},OSGB36toWGS84:{tx:446.448,ty:-124.157,tz:542.06,s:-204894e-10,rx:4172222e-11,ry:6861111e-11,rz:.00023391666}};function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function spaces(e){for(var t=" ",o=0;o<e-1;o++)t+=" ";return t}wmsMap.transCoord.getElipsoide=function(e){var t=Datum_axis[e][0],e=Datum_axis[e][1];return{a:t,b:e,e2:(t*t-e*e)/(t*t)}},wmsMap.transCoord.srsChange=function(e,t,o,n){var a,r,s,o=this.getDatum(o),n=this.getDatum(n);return o.datum==n.datum?o.huso==n.huso?{c1:e,c2:t}:""==o.huso?{c1:(a=this.geoToUTM(e,t,o.datum,n.huso)).x,c2:a.y}:""==n.huso?{c1:(a=this.utmToGeo(e,t,o.datum,o.huso)).lon,c2:a.lat}:(s=this.utmToGeo(e,t,o.datum,o.huso),{c1:(a=this.geoToUTM(s.lon,s.lat,o.datum,n.huso)).x,c2:a.y}):""==o.huso&&""==n.huso?{c1:(a=this.changeDatum(e,t,o.datum,n.datum)).lon,c2:a.lat}:""==o.huso&&""!=n.huso?(a=this.changeDatum(e,t,o.datum,n.datum),{c1:(r=this.geoToUTM(a.lon,a.lat,n.datum,n.huso)).x,c2:r.y}):""!=o.huso&&""==n.huso?(a=this.utmToGeo(e,t,o.datum,o.huso),{c1:(r=this.changeDatum(a.lon,a.lat,o.datum,n.datum)).lon,c2:r.lat}):(a=this.utmToGeo(e,t,o.datum,o.huso),r=this.changeDatum(a.lon,a.lat,o.datum,n.datum),{c1:(s=this.geoToUTM(r.lon,r.lat,n.datum,n.huso)).x,c2:s.y})},wmsMap.transCoord.getDatum=function(e){var t,o,n=e.length,a="",r="";return 10==n?(t="UTM",326==(o=e.slice(5,8))?a="WGS84":230==o?a="ED50":258==o&&(a="ETRS89"),r=e.slice(-2)):9==n&&(t="Lon-Lat",4326==(o=e.slice(5,9))?a="WGS84":4230==o?a="ED50":4258==o&&(a="ETRS89")),{datum:a,huso:r,proy:t}},wmsMap.transCoord.getEPSG=function(e,t,o){var n,a;return"UTM"==e?n="":"Lon-Lat"==e&&(n="4",o=""),"ETRS89"==t?a="258":"ED50"==t?a="230":"WGS84"==t&&(a="326"),{EPSG:"EPSG:"+n+a+o}},wmsMap.transCoord.isGeo=function(e){return"Lon-Lat"==wmsMap.transCoord.getDatum(e).proy},wmsMap.transCoord.isUTM=function(e){return"UTM"==wmsMap.transCoord.getDatum(e).proy},wmsMap.transCoord.geoToUTM=function(e,t,o,n){var o=this.getElipsoide(o),a=o.a,o=o.e2,r=t*(Math.PI/180),s=e*(Math.PI/180);n=n||Math.floor((e+180)/6)+1,56<=t&&t<64&&3<=e&&e<12&&(n=32),72<=t&&t<84&&(0<=e&&e<9?n=31:9<=e&&e<21?n=33:21<=e&&e<33?n=35:33<=e&&e<42&&(n=37));var e=(6*(n-1)-180+3)*(Math.PI/180),n=(ePrimeSquared=o/(1-o),a/Math.sqrt(1-o*Math.sin(r)*Math.sin(r))),i=Math.tan(r)*Math.tan(r),l=ePrimeSquared*Math.cos(r)*Math.cos(r),s=Math.cos(r)*(s-e),e=a*((1-o/4-3*o*o/64-5*o*o*o/256)*r-(3*o/8+3*o*o/32+45*o*o*o/1024)*Math.sin(2*r)+(15*o*o/256+45*o*o*o/1024)*Math.sin(4*r)-35*o*o*o/3072*Math.sin(6*r)),a=.9996*n*(s+(1-i+l)*Math.pow(s,3)/6+(5-18*i+i*i+72*l-58*ePrimeSquared)*Math.pow(s,5)/120)+5e5,o=.9996*(e+n*Math.tan(r)*(s*s/2+(5-i+9*l+4*l*l)*Math.pow(s,4)/24+(61-58*i+i*i+600*l-330*ePrimeSquared)*Math.pow(s,6)/720));return t<0&&(o+=1e7),{x:a,y:o}},wmsMap.transCoord.utmToGeo=function(e,t,o,n){var o=this.getElipsoide(o),a=o.a,o=o.e2,r=o/(1-o),s=(1-Math.sqrt(1-o))/(1+Math.sqrt(1-o)),e=e-5e5,n=6*(n-1)-180+3,t=(t=t)/.9996/(a*(1-o/4-3*o*o/64-5*Math.pow(o,3)/256)),s=t+(3*s/2-27*Math.pow(s,3)/32)*Math.sin(2*t)+(21*s*s/16-55*Math.pow(s,4)/32)*Math.sin(4*t)+151*Math.pow(s,3)/96*Math.sin(6*t),t=a/Math.sqrt(1-o*Math.sin(s)*Math.sin(s)),i=Math.tan(s)*Math.tan(s),l=r*Math.cos(s)*Math.cos(s),a=a*(1-o)/Math.pow(1-o*Math.sin(s)*Math.sin(s),1.5),o=e/(.9996*t),e=(s-t*Math.tan(s)/a*(o*o/2-(5+3*i+10*l-4*l*l-9*r)*Math.pow(o,4)/24+(61+90*i+298*l+45*i*i-252*r-3*l*l)*Math.pow(o,6)/720))*(180/Math.PI);return{lon:n+(o-(1+2*i+l)*Math.pow(o,3)/6+(5-2*l+28*i-3*l*l+8*r+24*i*i)*Math.pow(o,5)/120)/Math.cos(s)*(180/Math.PI),lat:e}},wmsMap.transCoord.GeoToGeocentric=function(e,t,o){var o=this.getElipsoide(o),n=o.a,o=(o.b,o.e2),t=wmsMap.oper.degToRad(t),e=wmsMap.oper.degToRad(e),n=n/Math.sqrt(1-o*wmsMap.oper.sin2(t));return{x:(0+n)*Math.cos(t)*Math.cos(e),y:(0+n)*Math.cos(t)*Math.sin(e),z:((1-o)*n+0)*Math.sin(t)}},wmsMap.transCoord.GeocentricToGeo=function(e,t,o,n){elipsoide=this.getElipsoide(n),a=elipsoide.a,b=elipsoide.b,excen=elipsoide.e2;for(var n=wmsMap.oper.radToDeg(Math.atan(t/e)),r=Math.sqrt(e*e+t*t),s=Math.atan(o/(r*(1-excen))),i=1;i<10;i++)v=a/Math.sqrt(1-excen*wmsMap.oper.sin2(s)),s=phiN1=Math.atan((o+excen*v*Math.sin(s))/r);return{lon:n,lat:wmsMap.oper.radToDeg(s)}},wmsMap.transCoord.bursaWolf=function(e,t,o,n){var a=n.tx,r=n.ty,s=n.tz,i=n.s,l=wmsMap.oper.degToRad(n.rx),c=wmsMap.oper.degToRad(n.ry),n=wmsMap.oper.degToRad(n.rz),T=Math.sin(c),c=Math.cos(c),d=Math.sin(l),l=Math.cos(l),R=Math.sin(n),n=Math.cos(n),i=1+i,m=[[],[],[]];return m[0][0]=i*(c*n),m[1][0]=i*(-c*R),m[2][0]=i*T,m[0][1]=i*(d*T*n+l*R),m[1][1]=i*(-d*T*R+l*n),m[2][1]=i*(-d*c),m[0][2]=i*(-l*T*n+d*R),m[1][2]=i*(l*T*R+d*n),m[2][2]=i*(l*c),{x:m[0][0]*e+m[0][1]*t+m[0][2]*o+a,y:m[1][0]*e+m[1][1]*t+m[1][2]*o+r,z:m[2][0]*e+m[2][1]*t+m[2][2]*o+s}},wmsMap.transCoord.changeDatum=function(e,t,o,n){return"ETRS89"==o&&"WGS84"==n||"ETRS89"==n&&"WGS84"==o?{lon:e,lat:t}:(gcIn=wmsMap.transCoord.GeoToGeocentric(e,t,o),o=this.getParam(o,n,e,t),gcOut=wmsMap.transCoord.bursaWolf(gcIn.x,gcIn.y,gcIn.z,o),{lon:(gOut=wmsMap.transCoord.GeocentricToGeo(gcOut.x,gcOut.y,gcOut.z,n)).lon,lat:gOut.lat})},wmsMap.transCoord.getParam=function(e,t,o,n){var a,o=-9.416<o&&o<-4.5&&41.5<n&&n<43.833?(a=datToDat.ETRS89toED50NWP,datToDat.ED50toETRS89NWP):1<o&&o<4.5&&38.5<n&&n<40.3?(a=datToDat.ETRS89toED50Bal,datToDat.ED50toETRS89Bal):-10<o&&o<3.833&&35.5<n&&n<44.833?(a=datToDat.ETRS89toED50Pen,datToDat.ED50toETRS89Pen):(a=datToDat.WGS84toED50,datToDat.ED50toWGS84);return"ETRS89"==e&&"ED50"==t?a:"ED50"==e&&"ETRS89"==t?o:"WGS84"==e&&"ED50"==t?datToDat.WGS84toED50:"ED50"==e&&"WGS84"==t?datToDat.ED50toWGS84:"OSGB36"==e&&"WGS84"==t?datToDat.OSGB36toWGS84:void 0},wmsMap.transCoord.getGradMinSeg=function(e,t){var o=60*(Math.floor(e)-e),n=60*(Math.floor(t)-t),a=Math.floor(60*(o-Math.floor(o))),r=Math.floor(60*(n-Math.floor(n))),o=(e=0<=e?Math.floor(e)+"&ordm;"+Math.floor(Math.abs(o))+"'"+Math.abs(a-59)+"''":"-"+Math.abs(Math.ceil(e))+"&ordm;"+Math.floor(60+o)+"'"+a+"''",Math.floor(t)+"&ordm;"+Math.floor(Math.abs(n))+"'"+Math.abs(r-59)+"''");return{lon:e,lat:o}},wmsMap.transCoord.getGradDeci=function(e,t,o){return(e=e||0)+(t=t||0)/60+(o=o||0)/3600},wmsMap.transCoord.getSuperficie=function(matrix,datum){for(var c,vect=[],matrixAux=[],i=0;i<matrix.length;i++){var c=wmsMap.transCoord.geoToUTM(eval(matrix[i][0]),eval(matrix[i][1]),datum,30),vect=[];vect[0]=c.x,vect[1]=c.y,matrixAux.push(vect)}var superf=0,n=matrixAux.length;if(matrixAux[0][0]==matrixAux[n-1][0]&&matrixAux[0][1]==matrixAux[n-1][1])for(var j=0;j<n-1;j++)superf+=-matrixAux[j][0]*matrixAux[j+1][1]+matrixAux[j+1][0]*matrixAux[j][1];else{for(var j=0;j<n-1;j++)superf+=-matrixAux[j][0]*matrixAux[j+1][1]+matrixAux[j+1][0]*matrixAux[j][1];superf+=-matrixAux[n-1][0]*matrixAux[0][1]+matrixAux[0][0]*matrixAux[n-1][1]}return Math.abs(superf/2)},wmsMap.transCoord.normalizeDegrees=function(e){var t=[360,180];return e[0]<-t[0]&&(e[0]+=t[0],e[2]+=t[0]),e[2]>t[0]&&(e[2]-=t[0],e[0]-=t[0]),e[1]<-t[1]&&(e[1]+=t[1],e[3]+=t[1]),e[3]>t[1]&&(e[3]-=t[1],e[1]-=t[1]),e},wmsMap.transCoord.geoZone=function(e,t,o){return o="UTM"==this.getDatum(o).proy?this.srsChange(e,t,o,"EPSG:4258"):{c1:e,c2:t},Math.floor((o.c1+180)/6)+1},wmsMap.transCoord.tw2c=function(e,t,o,n,a){var r,s,i,l={},c={};return n.x00?(i=e-parseFloat(n["x0"+a]),r=t-parseFloat(n["y0"+a]),s=o-parseFloat(n["z0"+a]),daux=-parseFloat(n["df"+a])/(parseFloat(n["r"+a][2])*i+parseFloat(n["r"+a][5])*r+parseFloat(n["r"+a][8])*s),l.x=(parseFloat(n["r"+a][0])*i+parseFloat(n["r"+a][3])*r+parseFloat(n["r"+a][6])*s)*daux,l.y=(parseFloat(n["r"+a][1])*i+parseFloat(n["r"+a][4])*r+parseFloat(n["r"+a][7])*s)*daux,c=wmsMap.tAfinDirect(l,n["tx"+a],n["ty"+a],n.r),(i=YAHOO.util.Dom.getStyle("contIzq","height"))&&(c.y=parseInt(i)-c.y)):(c.x=(n[0+8*a]*e*100+n[1+8*a])/(100*o+n[2+8*a])+n[3+8*a],c.y=(n[4+8*a]*t*100+n[5+8*a])/(100*o+n[6+8*a])+n[7+8*a]),c},wmsMap.tAfinDirect=function(e,t,o,n){var a={};return a.x=parseFloat(n[0])*e.x+parseFloat(n[1])*e.y+parseFloat(t),a.y=parseFloat(n[2])*e.x+parseFloat(n[3])*e.y+parseFloat(o),a},wmsMap.tAfinInver=function(e,t,o,n){var a=e.x,e=e.y,r={},s=n[0]*n[3]-n[2]*n[1];return s&&(r.x=(parseFloat(n[3])*a-parseFloat(n[1])*e-parseFloat(n[3])*t+parseFloat(n[1])*o)/s,r.y=(-parseFloat(n[2])*a+parseFloat(n[0])*e-parseFloat(n[0])*o+parseFloat(n[2])*t)/s),r},TR3.requestDTMwcs=!1,TR3.scene,TR3.renderer,TR3.camera,TR3.controls,TR3.mesh,TR3.fov=30,TR3.sourceFile=!1,TR3.blobs=new Array,TR3.params,TR3.geo2UTM,TR3.bboxImgOri=[],TR3.srsImg,TR3.widthImg,TR3.heightImg,TR3.tPixImg,TR3.texture,TR3.maxResolMesh=5,TR3.reducDTM=1,TR3.zMin,TR3.zMed,TR3.zMax,TR3.arrayZ=[],TR3.zone=[],TR3.centerZone=[],TR3.reducMeshW,TR3.reducMeshH,TR3.timeoutReq=[],TR3.timeoutReq[1]=0,TR3.newMap=!1,TR3.cameraDist=1,TR3.pscs=[],TR3.pscs.physicsWorld,TR3.pscs.transformAux1=!1,TR3.pscs.dynamicObjects=[],TR3.pscs.plasmaBalls=[],TR3.pscs.emiter=!1,TR3.pscs.emiters=[],TR3.pscs.bricks=[],TR3.pscs.rain=[],TR3.loadedFiles=[],TR3.newGeom=!1,TR3.cloneObj=!1,TR3.map,TR3.canvasDest,TR3.loadingDiv,TR3.canvasDestW,TR3.canvasDestH,TR3.optionsSet={imgControl:!0,cursor3d:!1,anaglyph:!1,autoRotate:!1,wireframeMesh:!1,tentative:!1,terrain:!1},TR3.valuesSet={magnification:"auto",height:0},TR3.cursor={helper:!1,setZterr:!1,setkCde:!1,causeLock:"",event:!1,coordClick:!1,mouseDownID:!1},TR3.slctBox=new Array,TR3.newMeshMap=1,TR3.oneMeshMap=2,TR3.zeroParallax,TR3.moveKey={is:!1,size:1.7,walk:!1,azOriAng:0,walkClicked:!1},TR3.CtrlDargClick=!1,TR3.cameraPositionFar,TR3.lookAt,TR3.oscillate=[],TR3.rotate=[],TR3.scalate=[],TR3.rotatePart=[],TR3.lookAtCamera=[],TR3.idAnimation=-1,TR3.mixer=new Array,TR3.newDraw=-1,TR3.vGeom=[],TR3.vGeom.positions,TR3.vGeom.measure=!1,TR3.vGeom.polig=!1,TR3.vGeom.newText=!1,TR3.vGeom.newLight=!1,TR3.vGeom.item=[],TR3.vGeom.item.magni,TR3.vGeom.item.nPoint=0,TR3.vGeom.sprites=[],TR3.vGeom.lights=[],TR3.vGeom.obj3d=[],TR3.vGeom.build=[],TR3.animate=function(){TR3.idAnimation=requestAnimationFrame(TR3.animate),TR3.controls.update(),TR3.renderScene(),1==TR3.moveKey.is&&TR3.moveKeyFn();var e=TR3.clock.getDelta(),t=TR3.clock.getElapsedTime();if(TR3.pscs.updatePhysics(e),TR3.mixer)for(var o=0;o<TR3.mixer.length;o++)TR3.mixer[o].update(e);for(o=0;o<TR3.oscillate.length;o++){var n=TR3.oscillate[o],a=n[0].position,r=0,s=n[3]||0;s+=Math.sin(t*n[1]+r)*n[2],a.y=s}for(o=0;o<TR3.rotatePart.length;o++){var i=TR3.rotatePart[o],l=i[0].rotation,r=0,s=i[3]||0;s+=Math.sin(t*i[1]+r)*i[2],l.y=s}for(o=0;o<TR3.rotate.length;o++){var c=TR3.rotate[o];c[0].rotation.y+=c[1]||.02}for(o=0;o<TR3.lookAtCamera.length;o++)TR3.lookAtCamera[o].lookAt(TR3.camera.position);for(o=0;o<TR3.scalate.length;o++){var T=TR3.scalate[o],d=T[0].scale,R=T[3]||0;R+=Math.sin(t*T[1])*T[2],d.x=R,d.y=R,d.z=R}if(0<TR3.pscs.plasmaBalls.length&&1==TR3.camera.visible)for(o=0;o<TR3.pscs.plasmaBalls.length;o++){var m,p,u,g=TR3.pscs.plasmaBalls[o];g.colision||(g.translateZ(m=-50*e),25<g.cont&&!g.distFrames&&(p=TR3.getRayCaster([g.pos,g.vector],"point-vector"),(u=TR3.getSelectableObj()).push(TR3.mesh),(p=TR3.getIntersect(p,u)[0][0])?(u=p.distance,g.distFrames||(g.distFrames=-u/m)):g.distFrames="infinite"),g.distFrames&&"infinite"!=g.distFrames&&g.distFrames<g.cont*parseInt(6.25)&&(p?(g.colision=!0,g.position.set(p.point.x,p.point.y,p.point.z)):g.distFrames=!1),g.cont++)}var h=TR3.sky.material.uniforms.rayleigh.value,y=Math.round(10*TR3.oscillator(.07*t+.4,1,.3,0,.4))/10;Math.round(.07*t*200)%9==0&&h!=y&&(TR3.sky.material.uniforms.rayleigh.value=y)},TR3.startAnimation=function(e){TR3.idAnimation=window.requestAnimationFrame(TR3.animate)},TR3.stopAnimation=function(e){window.cancelAnimationFrame(TR3.idAnimation)},TR3.renderScene=function(){TWEEN.update(),TR3.optionsSet.anaglyph&&Detector.webgl?TR3.anaglyphRenderer.render(TR3.scene,TR3.camera,TR3.zeroParallax):TR3.renderer.render(TR3.scene,TR3.camera)},TR3.exportGLTF=function(e){var t=new Array;if("selected"==e&&TR3.transformControls.object)t=TR3.transformControls.object;else if("scene"==e)for(var o=0;o<TR3.scene.children.length;o++){var n=TR3.scene.children[o];"Mesh"!==n.type&&"Group"!==n.type&&"Object3D"!==n.type&&"Sprite"!==n.type||"TransformControls"!==n.name&&"G-hills"!==n.name&&"cursor"!==n.name&&"planetary"!==n.name&&"starField"!==n.name&&"Sky"!==n.name&&"Compass"!==n.name&&"N"!==n.name&&"S"!==n.name&&"E"!==n.name&&"W"!==n.name&&t.push(function(e){e="Scene"!=e.type&&"Group"!=e.type&&e.scene||e;return TR3.SkeletonUtilsClone(e)}(n))}else"terrain"==e&&(t=TR3.mesh);(new TR3.GLTFExporter).parse(t,function(e){var t;e instanceof ArrayBuffer?(t="TR3_scene.glb",r(new Blob([e],{type:"application/octet-stream"}),t)):(t=JSON.stringify(e,null,2),e="TR3_scene.gltf",r(new Blob([t],{type:"text/plain"}),e))},"",{trs:!0,onlyVisible:!0,binary:!0,animations:!1,maxTextureSize:1024});var a=document.createElement("a");function r(e,t){a.href=URL.createObjectURL(e),a.download=t,a.click()}a.style.display="none",document.body.appendChild(a)},TR3.AnaglyphEffect=function(l,e,t){var c,T,d,R,m,p=new THREE.Matrix4,u=new THREE.Matrix4,g=200,h=new THREE.PerspectiveCamera,y=(h.matrixAutoUpdate=!1,new THREE.PerspectiveCamera),v=(y.matrixAutoUpdate=!1,new THREE.OrthographicCamera(-1,1,1,-1,0,1)),f=new THREE.Scene,o={minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat},b=new THREE.WebGLRenderTarget(e=void 0===e?512:e,t=void 0===t?512:t,o),E=new THREE.WebGLRenderTarget(e,t,o),n=(this.getAnaglyphColors=function(){var e="",t={lr1:"0.0",lg1:"0.7",lb1:"0.3",rr2:"0.0",rg2:"1.0",rb2:"0.0",rr3:"0.0",rg3:"0.0",rb3:"1.0"};switch(e=TR3?TR3.anaglyphType:e){case"normal":t={lr1:"1.0",lg1:"0.0",lb1:"0.0",rr2:"0.0",rg2:"1.0",rb2:"0.0",rr3:"0.0",rg3:"0.0",rb3:"1.0"};break;case"half":t={lr1:"0.299",lg1:"0.587",lb1:"0.114",rr2:"0.0",rg2:"1.0",rb2:"0.0",rr3:"0.0",rg3:"0.0",rb3:"1.0"};break;case"gray":t={lr1:"0.299",lg1:"0.587",lb1:"0.114",rr2:"0.299",rg2:"0.587",rb2:"0.114",rr3:"0.299",rg3:"0.587",rb3:"0.114"}}return t},this.getFragmentShader=function(){var e=this.getAnaglyphColors(),e=["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","\tvec4 colorL, colorR;","\tvec2 uv = vUv;","\tcolorL = texture2D( mapLeft, uv );","\tcolorR = texture2D( mapRight, uv );","\tgl_FragColor = vec4( colorL.r * "+e.lr1+" + colorL.g * "+e.lg1+" + colorL.b * "+e.lb1+", colorR.r * "+e.rr2+" + colorR.g * "+e.rg2+" + colorR.b * "+e.rb2+", colorR.r * "+e.rr3+" + colorR.g * "+e.rg3+" + colorR.b * "+e.rb3+", colorL.a + colorR.a ) * 1.1;","}"].join("\n");return TR3&&"interlaced"==TR3.anaglyphType?e=["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","\tvec2 uv = vUv;","\tif ( ( mod( gl_FragCoord.y, 2.0 ) ) < 1.00 ) {","\t\tgl_FragColor = texture2D( mapRight, uv );","\t} else {","\t\tgl_FragColor = texture2D( mapLeft, uv );","\t}","}"].join("\n"):TR3&&"interlaced swap"==TR3.anaglyphType&&(e=["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","\tvec2 uv = vUv;","\tif ( ( mod( gl_FragCoord.y, 2.0 ) ) < 1.00 ) {","\t\tgl_FragColor = texture2D( mapLeft, uv );","\t} else {","\t\tgl_FragColor = texture2D( mapRight, uv );","\t}","}"].join("\n")),e},new THREE.ShaderMaterial({uniforms:{mapLeft:{type:"t",value:b},mapRight:{type:"t",value:E}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = vec2( uv.x, uv.y );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:this.getFragmentShader()})),e=new THREE.Mesh(new THREE.PlaneGeometry(2,2),n);f.add(e),this.setSize=function(e,t){b&&b.dispose(),E&&E.dispose(),b=new THREE.WebGLRenderTarget(e,t,o),E=new THREE.WebGLRenderTarget(e,t,o),n.uniforms.mapLeft.value=b.texture,n.uniforms.mapRight.value=E.texture,l.setSize(e,t)},this.render=function(e,t,o){var n,a,r,s,i=l.getRenderTarget();e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),T===t.aspect&&d===t.near&&R===t.far&&m===t.fov&&g===o||(T=t.aspect,d=t.near,R=t.far,m=t.fov,c=g=o,o=t.projectionMatrix.clone(),n=(r=c/30*.5)*d/c,a=d*Math.tan(THREE.MathUtils.degToRad(.5*m)),p.elements[12]=r,u.elements[12]=-r,r=-a*T+n,s=a*T+n,o.elements[0]=2*d/(s-r),o.elements[8]=(s+r)/(s-r),h.projectionMatrix.copy(o),r=-a*T-n,s=a*T-n,o.elements[0]=2*d/(s-r),o.elements[8]=(s+r)/(s-r),y.projectionMatrix.copy(o)),h.matrixWorld.copy(t.matrixWorld).multiply(u),h.position.copy(t.position),h.near=t.near,h.far=t.far,l.setRenderTarget(b),l.clear(),l.render(e,h),y.matrixWorld.copy(t.matrixWorld).multiply(p),y.position.copy(t.position),y.near=t.near,y.far=t.far,l.setRenderTarget(E),l.clear(),l.render(e,y),l.setRenderTarget(null),l.render(f,v),l.setRenderTarget(i)},this.dispose=function(){b&&b.dispose(),E&&E.dispose()},this.updateAnaglyphType=function(e,t){this.getAnaglyphColors();n.fragmentShader=this.getFragmentShader(),n.needsUpdate=!0,this.render(e,t,g)}},TR3.getIntersect=function(e,t){for(var o=!1,n=16777215,a=new Array,r=0;r<t.length;r++){var s=t[r],i=s;if(s.scene?i=s.scene:s.parent&&s.parent.scene&&(i=s.parent.scene),(a=i?e.intersectObject(i,!0):a).length,0<a.length&&0===TR3.slctBox.length){if(o=a,TR3.intersectEvOver(s),TR3.optionsSet.tentative&&i.TR3&&i.TR3.hitbox){var s=i.TR3.hitbox,l=i.TR3.box,c=i.scale,T=i.position,d=i.quaternion,i=(void 0!==i.TR3.floorMesh&&"number"==typeof i.TR3.floorMesh&&(n=7829367),void 0!==i.TR3.transformMesh&&"number"==typeof i.TR3.transformMesh&&(n=255),void 0!==i.TR3.mass&&"number"==typeof i.TR3.mass&&(n=65280),new THREE.BoxGeometry(s.x*c.x,s.y*c.y,s.z*c.z)),s=new THREE.EdgesGeometry(i),i=new THREE.LineBasicMaterial({color:n}),s=new THREE.LineSegments(s,i);s.position.set(T.x+(l.max.x+l.min.x)*c.x/2,T.y+(l.max.y+l.min.y)*c.y/2,T.z+(l.max.z+l.min.z)*c.z/2),s.quaternion.set(d.x,d.y,d.z,d.w),TR3.slctBox.push(s);for(var R=0;R<TR3.slctBox.length;R++)TR3.scalate.push([TR3.slctBox[R],6,.1,1]),TR3.scene.add(TR3.slctBox[R])}r=t.length}else if(a.length<1){if(0<TR3.slctBox.length){for(R=0;R<TR3.slctBox.length;R++)TR3.scene.remove(TR3.slctBox[R]);TR3.slctBox=new Array}}else(o=o||a)[0].point.y<a[0].point.y&&(o=a)}return[o]},TR3.getRayCaster=function(e,t,o,n){var a,r,n=n||13e5,o=o||0;return t?"point-point"==t?(a=e[0],r=(new THREE.Vector3).copy(e[1]).sub(a)):"point-camera"==t?(a=e[0],r=new THREE.Vector3,TR3.camera.getWorldDirection(r)):"point-vector"==t&&(a=e[0],r=(new THREE.Vector3).copy(e[1])):(a=(t=function(e){var t=TR3.map,o=t.offsetTop,n=t.offsetLeft;for(;t.parentElement;)t=t.parentElement,o+=t.offsetTop,n+=t.offsetLeft;e&&e.touches&&0<e.touches.length?(a=e.touches[0].clientX,r=e.touches[0].clientY):e?(a=e.clientX,r=e.clientY):(a=.5*TR3.canvasDestW,r=.5*TR3.canvasDestH,o=n=0);var e=(a-n)/TR3.canvasDestW*2-1,a=2*-((r-o)/TR3.canvasDestH)+1,r=new THREE.Vector3(e,a,TR3.camera.near),e=(r.unproject(TR3.camera),TR3.camera.position);return[e,r.sub(e)]}(e))[0],r=t[1]),new THREE.Raycaster(a,r.normalize(),o,n)},TR3.onIntersect=function(e){var t,o,n,a;TR3.optionsSet.cursor3d?(o=TR3.getRayCaster(e),0<(n=TR3.getIntersect(o,[TR3.mesh])[0]).length&&(a=(t=n[0].point).y,TR3.cursor.helper.position.set(t.x,a,t.z),TR3.redrawInfo(t.x,t.y,t.z,!1))):0<(a=TR3.getSelectableObj()).length&&TR3.optionsSet.tentative&&(o=TR3.getRayCaster(e),n=TR3.getIntersect(o,a)),TR3.cursor.event=e},TR3.getSelectableObj=function(){for(var e=TR3.vGeom.obj3d,t=new Array,o=0;o<e.length;o++)(e[o].scene&&e[o].scene.TR3&&e[o].scene.TR3.slctItem||e[o]&&e[o].TR3&&e[o].TR3.slctItem)&&t.push(e[o]);return t},TR3.redrawInfo=function(e,t,o,n){var e=TR3.getCoordsByXYmod(e,o,!1),o=e[0],a=e[1],e=e[2],r=0,s=TR3.formatMeasure(TR3.tPixMesh),n=(n&&(r=n-e),TR3.XYZ2Clip=[o.toFixed(3),a.toFixed(3),e.toFixed(2)],"<b>Project: "+proj4.Proj(TR3.srsImg).projName+" - Datum:"+proj4.Proj(TR3.srsImg).title+"</b><br><b>X:</b> "+TR3.XYZ2Clip[0]+"<br><b>Y:</b> "+TR3.XYZ2Clip[1]+"<br><b>Z:</b> "+TR3.XYZ2Clip[2]+"&nbsp;&nbsp;&nbsp;<b>±Zcur:</b> "+(r*TR3.adjustScale).toFixed(2)+" m&nbsp;&nbsp;&nbsp;<b>Malla:</b> "+(+s[0]/TR3.adjustScale).toFixed(2)+" "+s[1]);document.getElementById("infoGeo3d").innerHTML=n},TR3.zCursor=function(e){var t=TR3.cursor.helper.position,e=TR3.zM2T(t.y)+e*TR3.getSizePix(),o=TR3.zM2T(e,!0);t.set(t.x,o,t.z),TR3.redrawInfo(t.x,t.y,t.z,e),TR3.optionsSet.cursor3d=!1,setTimeout(function(){TR3.optionsSet.cursor3d=!0},3e3)},TR3.click_Obj3d=function(e){var t=!0,o=TR3.getRayCaster(e),n=TR3.getIntersect(o,[TR3.mesh]),a=TR3.camera.position;if(TR3.cursor.coordClick=new THREE.Vector3,0<n.length&&n[0].length?(r=n[0][0],TR3.cursor.coordClick.x=r.point.x,TR3.cursor.coordClick.y=r.point.y,TR3.cursor.coordClick.z=r.point.z):(TR3.cursor.coordClick=!1,console.log("Fail Position!")),!TR3.CtrlDargClick&&TR3.optionsSet.tentative){var r=TR3.getSelectableObj();if(0<r.length){var o=TR3.getRayCaster(e),e=TR3.getIntersect(o,r);if(e[0]&&TR3.cursor.mouseDownID===e[0][0].object.uuid)return o={intersect:e[0]},TR3.intersectEvClick(o),!0===TR3.optionsSet.anaglyph&&(TR3.zeroParallax=a.distanceTo(e[0][0].point),t=!1),!0}}TR3.CtrlDargClick=!1,t&&!0===TR3.optionsSet.anaglyph&&0==TR3.transformControls.visible&&(TR3.zeroParallax=a.distanceTo(n[0][0].point)),1==TR3.newGeom&&(TR3.setGeomBySelect(),TR3.canvasDest.style.cursor="default",TR3.newGeom=!1),TR3.sourceFile&&(TR3.loadFile({slctItem:!0}),TR3.canvasDest.style.cursor="default"),1==TR3.pscs.emiter&&TR3.pscs.setEmisor(),1==TR3.cloneObj&&((r=TR3.transformControls.object)?TR3.setCloneObj(r):(TR3.cloneObj=!1,TR3.canvasDest.style.cursor="default")),1==TR3.moveKey.walkClicked&&(TR3.moving=!0,TR3.personViewFn(),TR3.moveKey.walk=!0,TR3.moveKey.walkClicked=!1,TR3.canvasDest.style.cursor="default"),1==TR3.vGeom.newText&&""!=(o=document.getElementById("inputTextInto").value)&&(e=TR3.formatedText(o),TR3.scene.add(e),TR3.vGeom.newText=!1,TR3.transCtrlsEnabled(e),TR3.onCreateItem(e),TR3.canvasDest.style.cursor="default"),1==TR3.vGeom.newLight&&(t=$("#minicolorLight").val()||"#ffffff",a=document.getElementById("intensLight").value||1,n=document.getElementById("distLight").value||100,(r=TR3.setLight(t,a,n))[0].position.set(TR3.cursor.coordClick.x,TR3.cursor.coordClick.y,TR3.cursor.coordClick.z),TR3.scene.add(r[0]),TR3.scene.add(r[1]),TR3.transCtrlsEnabled(r[0]),TR3.onCreateItem(r[0]),TR3.vGeom.newLight=!1,TR3.canvasDest.style.cursor="default"),TR3.cursor.helper.visible&&TR3.vGeom.positions&&-1!=TR3.newDraw&&0<TR3.vGeom.item.length&&TR3.addPoint(),TR3.controls.active=!1,TR3.setOpts({autoRotate:!1})},TR3.setCoods2clip=function(e){e.preventDefault(),TR3.XYZ2Clip&&((e=document.getElementById("inputTextInto")).value=TR3.XYZ2Clip.toString(),e.select(),document.execCommand("copy"))},TR3.decorations=function(e,t,o,n){0!=e&&TR3.setHills(),0!=t&&TR3.setStarField(13e5),0!=o&&TR3.setPlanets(13e5),0!=n&&TR3.setCompass()},TR3.setHills=function(){var e={src:TR3.config.src+"hills.glb",scale:[.8*Math.abs(TR3.zone[2]-TR3.zone[0]),.8*Math.abs(TR3.zone[2]-TR3.zone[0]),.8*Math.abs(TR3.zone[3]-TR3.zone[1])],pos:[TR3.centerZone[0],TR3.centerZone[1],TR3.zMed],aRotate:!1,name:"Decoration",slctItem:!1};TR3.loadFile(e).then(function(e){e[0].scene.name="hills";var t=TR3.getSizeObj(e[0].scene),t=(e[0].scene.position.y=-t[4].y/2,e[0].scene.rotateY(Math.PI),new THREE.Group);t.name="G-hills",t.add(e[0].scene),TR3.scene.add(t)})},TR3.setStarField=function(e){TR3.txtObject("N","#888888",3e4,[0,2e5,0-e],0).then(function(e){TR3.scene.add(e)}),TR3.txtObject("S","#888888",3e4,[0,2e5,0+e],Math.PI).then(function(e){TR3.scene.add(e)}),TR3.txtObject("E","#888888",3e4,[0+e,2e5,0],-Math.PI/2).then(function(e){TR3.scene.add(e)}),TR3.txtObject("W","#888888",3e4,[0-e,2e5,0],Math.PI/2).then(function(e){TR3.scene.add(e)});for(var t=new THREE.BufferGeometry,o=[],n=0;n<600;n++){var a=new THREE.Vector3,r=THREE.MathUtils.randFloat(0,2*Math.PI),s=THREE.MathUtils.randFloat(-Math.PI/2,Math.PI/2);a.x=e*Math.sin(r)*Math.cos(s),a.y=e*Math.sin(r)*Math.sin(s),a.z=e*Math.cos(r),o.push(a)}t.setFromPoints(o);var i=new THREE.PointsMaterial({color:"#cccc88",size:15e3}),t=new THREE.Points(t,i);t.name="starField",TR3.scene.add(t)},TR3.setPlanets=function(e){var t=new THREE.BoxGeometry(.01,.01,.01),o=new THREE.MeshBasicMaterial({}),t=new THREE.Mesh(t,o),o=(t.name="planetary",t.rotateX(Math.PI/20),new THREE.IcosahedronGeometry(5e4,3)),n=new THREE.MeshLambertMaterial({color:11184733}),n=new THREE.Mesh(o,n),a=(n.position.x=e-5e4,new THREE.RingGeometry(6e4,9e4,32)),r=new THREE.MeshLambertMaterial({color:13421772,side:THREE.DoubleSide}),r=new THREE.Mesh(a,r),r=(r.rotateX(Math.PI/1.5),n.add(r),t.add(n),TR3.rotate.push([n,.01]),new THREE.MeshLambertMaterial({color:13421772})),n=new THREE.Mesh(o,r),o=(n.position.x=5e4-e,new THREE.MeshLambertMaterial({color:11184733,side:THREE.DoubleSide})),r=new THREE.Mesh(a,o);r.rotateX(Math.PI/1.5),n.add(r),t.add(n),TR3.rotate.push([n,.01]),TR3.rotate.push([t,.001]),TR3.scene.add(t)},TR3.setCompass=function(){var e=TR3.getCoordsDistance([TR3.zone[0],TR3.zone[1]],[TR3.zone[2],TR3.zone[3]])/1.5,t=TR3.zM2T(TR3.zMin,!0),o=new THREE.RingGeometry(e/1.1,e,32),n=new THREE.MeshBasicMaterial({color:15918847,transparent:!0,opacity:.5}),n=new THREE.Mesh(o,n),a=(n.name="Compass",TR3.setGeometry({geometry:"semisphere",radius:e/1.1},new THREE.MeshBasicMaterial({color:16777215,side:THREE.BackSide}))),a=(n.add(a),n.position.y=t*TR3.valuesSet.magnification-5,n.rotateX(3*Math.PI/2),n.rotateZ(.92),TR3.txtObject("- N -","#888888",e/15,[0,t,0-e],0).then(function(e){TR3.scene.add(e)}),TR3.txtObject("- S -","#888888",e/15,[0,t,0+e],Math.PI).then(function(e){TR3.scene.add(e)}),TR3.txtObject("- E -","#888888",e/15,[0+e,t,0],-Math.PI/2).then(function(e){TR3.scene.add(e)}),TR3.txtObject("-W-","#888888",e/15,[0-e,t,0],Math.PI/2).then(function(e){TR3.scene.add(e)}),new THREE.WireframeGeometry(o)),e=new THREE.LineBasicMaterial({color:13421772}),t=new THREE.Line(a,e);n.add(t),TR3.scene.add(n)},TR3.updateVgeom=function(){for(var e=TR3.vGeom.item[TR3.vGeom.item.length-1],t=TR3.getMetrics(e),o=0;o<t.length;o++){var n=t[o][1]||TR3.cursor.coordClick,n=(n.inv=!0,{text:t[o][0],pos:n}),a=TR3.makeTextSprite(n);TR3.scene.add(a)}TR3.MeasureEvEnd(t,a)},TR3.addPoint=function(){var e=TR3.cursor.coordClick,t=TR3.vGeom.item[TR3.vGeom.item.length-1],o=t.nPoint,n=TR3.vGeom.positions;n[3*o+0]=e.x,n[3*o+1]=e.y,n[3*o+2]=e.z,t.nPoint++,t.geometry.setDrawRange(0,t.nPoint),t.geometry.attributes.position.needsUpdate=!0,1<o&&TR3.vGeom.measure&&TR3.updateVgeom()},TR3.newVgeom=function(e){TR3.newDraw++;var t=new THREE.BufferGeometry,o=new Float32Array(450),o=(t.setAttribute("position",new THREE.BufferAttribute(o,3)),TR3.vGeom.positions=o,new THREE.LineBasicMaterial({color:$("#PickDrawStereo").val()})),t=new(1==TR3.vGeom.polig?THREE.LineLoop:(TR3.distAlt=0,TR3.dist2D=0,TR3.dist3D=0,TR3.distTerr=0,THREE.Line))(t,o);if(t.frustumCulled=!1,t.nPoint=0,t.magni=TR3.valuesSet.magnification,t.name="handMade",TR3.scene.add(t),TR3.vGeom.sprites&&TR3.vGeom.sprites.length)for(var n=0;n<TR3.vGeom.sprites.length;n++)1==TR3.vGeom.sprites[n].reload&&(TR3.vGeom.sprites[n].reload=!1);if(TR3.vGeom.item&&TR3.vGeom.item.length)for(n=0;n<TR3.vGeom.item.length;n++)1==TR3.vGeom.item[n].reload&&(TR3.vGeom.item[n].reload=!1);TR3.vGeom.item||(TR3.vGeom.item=new Array(0)),TR3.vGeom.item.push(t),TR3.vGeom.item[0].reload=!1},TR3.endDraw=function(e){TR3.newDraw=-1},TR3.getMetrics=function(e){var t=new Array;if(t.length=0,TR3.vGeom.sprites&&TR3.vGeom.sprites.length)for(var o=0;o<TR3.vGeom.sprites.length;o++)1==TR3.vGeom.sprites[o].reload&&(TR3.scene.remove(TR3.vGeom.sprites[o]),TR3.vGeom.sprites.splice(o,1),o--);if(TR3.vGeom.item&&TR3.vGeom.item.length)for(o=0;o<TR3.vGeom.item.length;o++)1==TR3.vGeom.item[o].reload&&(TR3.scene.remove(TR3.vGeom.item[o]),TR3.vGeom.item.splice(o,1),o--);if(1==TR3.vGeom.polig&&2<e.nPoint){for(var n,a=e.geometry.getAttribute("position"),r=new Array,o=(n=e.nPoint)-1;-1<o;o--){var s=TR3.getCoordsByXYmod(a.getX(o),a.getZ(o),!1);r.unshift(s)}var i=TR3.getSurf(r,e);t.push([TR3.txtMetric([i[0],i[1],i[2]]),new THREE.Vector3(a.getX(0),a.getY(0),a.getZ(0))]),t.push([TR3.txtMetric([i[6]]),new THREE.Vector3(a.getX(n-1),a.getY(n-1),a.getZ(n-1))]),t.push([TR3.txtMetric([i[3],i[4],i[5]]),new THREE.Vector3(a.getX(Math.floor(n/2)),a.getY(Math.floor(n/2)),a.getZ(Math.floor(n/2)))])}return TR3.vGeom.polig&&0!=TR3.vGeom.polig||(a=e.geometry.getAttribute("position"),n=e.nPoint,i=TR3.getCoordsByXYmod(a.getX(n-1),a.getZ(n-1),!1),e=TR3.getCoordsByXYmod(a.getX(n-2),a.getZ(n-2),!1),e=TR3.getDist(e[0],e[1],a.getY(n-2),i[0],i[1],a.getY(n-1)),t.push([TR3.txtMetric(e)])),t},TR3.txtMetric=function(e){for(var t="",o=0;o<e.length;o++)e[o]?t+=" "+e[o].name+": "+e[o].val+" "+e[o].unit+"\n":(e.splice(o,1),o--);return t=t&&2<t.length?t.slice(0,-1):t},TR3.assignZgeometries=function(){},TR3.makeTextSprite=function(e){var t=!!(e=void 0===e?{}:e).hasOwnProperty("center")&&e.center,o=e.hasOwnProperty("pos")?e.pos:{x:44e4,y:444e4,z:900,inv:!1},n=e.hasOwnProperty("text")?e.text:"",a=!!e.hasOwnProperty("isPixSize")&&e.isPixSize,r=e.hasOwnProperty("extraData")?e.extraData:new Array,s=(void 0===e.font&&(e.font={}),e.font.hasOwnProperty("fontFace")?e.font.fontFace:"Arial"),i=e.font.hasOwnProperty("fontSize")?e.font.fontSize:24,l=!e.font.hasOwnProperty("bold")||e.font.bold,c=e.font.hasOwnProperty("textColor")?e.font.textColor:{r:0,g:0,b:0,a:1},T=(void 0===e.canvas&&(e.canvas={}),e.canvas.hasOwnProperty("backgroundColor")?e.canvas.backgroundColor:{r:255,g:100,b:100,a:.8}),d=(e.canvas.hasOwnProperty("borderColor")&&e.canvas.borderColor,e.canvas.hasOwnProperty("borderThickness")?e.canvas.borderThickness:4),R=e.canvas.hasOwnProperty("rounded")?e.canvas.rounded:6,m=e.canvas.hasOwnProperty("borderColor")?e.canvas.borderColor:{r:255,g:0,b:0,a:1},p=!!e.canvas.hasOwnProperty("text_Height")&&e.canvas.text_Height,u=!!e.canvas.hasOwnProperty("text_Width")&&e.canvas.text_Width,g=!!e.canvas.hasOwnProperty("scale")&&e.canvas.scale,h=!e.canvas.hasOwnProperty("depthTest")||e.canvas.depthTest,y=document.createElement("canvas"),v=y.getContext("2d"),l=l?"Bold ":"";v.font=l+i+"px "+s,v.fillStyle="rgba("+T.r+","+T.g+","+T.b+","+T.a+")",v.strokeStyle="rgba("+m.r+","+m.g+","+m.b+","+m.a+")";var f=(n=(n=null==n?"":n).replace(new RegExp("---","g")," ")).split("\n"),b=(f=f.length<=1?n.split("+++"):f).length,E=i+d,l=p||(1.2*i+d)*b,s=v.measureText(n),T=u||s.width/b*1.2;146<l&&(l=146),292<T&&(T=292),v.lineWidth=d,TR3.roundRect(v,d/2,d/2,T+d,l,R),v.fillStyle="rgba("+c.r+","+c.g+","+c.b+","+c.a+")";for(var M=0;M<b;++M)v.fillText(f[M],d,E*(M+1));m=new THREE.Texture(y),m.needsUpdate=!0,p=new THREE.SpriteMaterial({map:m,alphaTest:.6,depthTest:h}),i=new THREE.Sprite(p),i.TR3=new Object,i.TR3.extraData=r,i.TR3.source=JSON.parse(JSON.stringify(e)),i.reload=!0,n=new THREE.Vector3,o.inv?(n.x=o.x,n.y=o.y,n.z=o.z):(u=TR3.coordM2T(o.x,o.y,o.z,!0),n.x=u[0],n.y=u[1],n.z=u[2]),a&&(n.y="$"+o.z+"$P"),i.position.set(n.x,n.y,n.z),s=TR3.config.spritesDskMvl,g?a?i.scale.set(g*TR3.getSizePix()*s,g/2*TR3.getSizePix()*s,1):i.scale.set(g,g/2,1):i.scale.set(100*TR3.getSizePix()*s,50*TR3.getSizePix()*s,1),T=TR3.rectaValue(1,.7,4,.05,b);return t?i.center.set(.5,.5):i.center.set(0,T),TR3.vGeom.sprites||(TR3.vGeom.sprites=new Array(0)),TR3.vGeom.sprites.push(i),i},TR3.formatedText=function(e,t,o){for(var n=e,a="",r="",s=(25<n.length&&(n=e.slice(0,25)+"-\n ",25<(a=e.slice(25)).length)&&(a=e.slice(25,50)+"-\n ",r=e.slice(50,75)),(n+a+r).split("-\n")),i="",l=0;l<s.length;l++){var c=s[l];i+=spaces(25-c.length)+c+"-\n"}e=i.slice(0,-2);n=t||$("#minicolorText").val()||"#ff00ff",a=new THREE.Color(n),r="#"+a.getHexString(),t=2*(e.match(/\n/g)||[]).length,n=new THREE.Vector3,n.x=o&&o[0]?o[0]:TR3.cursor.coordClick.x||0,n.y=o&&o[1]?o[1]+t:TR3.cursor.coordClick.y+t||0,n.z=o&&o[2]?o[2]:TR3.cursor.coordClick.z||0,t={text:e,font:{fontFace:"Arial",bold:!1},pos:{x:n.x,y:n.y,z:n.z,inv:!0},canvas:{text_Width:292,backgroundColor:{r:255*a.r,g:255*a.g,b:255*a.b,a:.8},borderColor:{r:155*a.r,g:155*a.g,b:155*a.b,a:1},borderThickness:1,depthTest:!1},center:!0},o=TR3.makeTextSprite(t);return o.TR3.source={text:t.text,color:r,pos:t.pos},o.name=e,o},TR3.del_vGeom=function(e,t){TR3.transformControls&&TR3.transCtrlsEnabled(!1);var o,n,a=e?TR3.vGeom.sprites.length-1:0,r=e?TR3.vGeom.obj3d.length-1:0,s=e?TR3.vGeom.build.length-1:0,i=e?TR3.vGeom.lights.length-1:0,e=!0,l=!0,c=!0,T=!0,d=!0;if(t&&(e="sprites"==t,l="obj3d"==t,c="build"==t,T="lights"==t,d="item"==t),T&&TR3.vGeom.lights&&TR3.vGeom.lights.length){for(;i<TR3.vGeom.lights.length;i++)TR3.onSuprFnc(TR3.vGeom.lights[i]),TR3.scene.remove(TR3.vGeom.lights[i][0]),TR3.scene.remove(TR3.vGeom.lights[i][1]),TR3.vGeom.lights.splice(i,1),i--;0===i&&(TR3.vGeom.lights=[])}if(e&&TR3.vGeom.sprites&&TR3.vGeom.sprites.length){for(;a<TR3.vGeom.sprites.length;a++)TR3.onSuprFnc(TR3.vGeom.sprites[a]),TR3.scene.remove(TR3.vGeom.sprites[a]),TR3.vGeom.sprites.splice(a,1),a--;0===a&&(TR3.vGeom.sprites=[])}if(l&&TR3.vGeom.obj3d&&TR3.vGeom.obj3d.length){for(;r<TR3.vGeom.obj3d.length;r++)1!=TR3.vGeom.obj3d[r].persist2Scene&&(n=(o=TR3.vGeom.obj3d[r]).scene||(o.parent&&o.parent.scene?o.parent.scene:o),TR3.onSuprFnc(n),TR3.scene.remove(n),TR3.vGeom.obj3d.splice(r,1),r--);0===r&&(TR3.vGeom.obj3d=[])}if(c&&TR3.vGeom.build&&TR3.vGeom.build.length){for(;s<TR3.vGeom.build.length;s++)1!=TR3.vGeom.build[s].persist2Scene&&(n=(o=TR3.vGeom.build[s]).scene||(o.parent&&o.parent.scene?o.parent.scene:o),TR3.scene.remove(n),TR3.vGeom.build.splice(s,1),s--);0===s&&(TR3.vGeom.build=[])}if(d&&TR3.vGeom.item&&TR3.vGeom.item.length){for(var R=0;R<TR3.vGeom.item.length;R++)TR3.scene.remove(TR3.vGeom.item[R]);TR3.vGeom.item=!1,TR3.vGeom.item.magni,TR3.vGeom.item.nPoint&&(TR3.vGeom.item.nPoint=0)}TR3.newDraw=-1},TR3.roundRect=function(e,t,o,n,a,r){e.beginPath(),e.moveTo(t+r,o),e.lineTo(t+n-r,o),e.quadraticCurveTo(t+n,o,t+n,o+r),e.lineTo(t+n,o+a-r),e.quadraticCurveTo(t+n,o+a,t+n-r,o+a),e.lineTo(t+r,o+a),e.quadraticCurveTo(t,o+a,t,o+a-r),e.lineTo(t,o+r),e.quadraticCurveTo(t,o,t+r,o),e.closePath(),e.fill(),e.stroke()},TR3.txtObject=async function(n,a,r,s,i){return new Promise(function(o){TR3.loaderFONT.load(TR3.config.src+"helvetiker_regular.typeface.json",function(e){var e=new TR3.TextGeometry(n,{font:e,size:r,height:.5,bevelEnabled:!0,bevelThickness:1,bevelSize:1,bevelOffset:0,bevelSegments:1}),t=new THREE.MeshBasicMaterial({color:a}),e=new THREE.Mesh(e,t);e.name=n,e.position.set(s[0],s[1],s[2]),e.rotation.y=i,o(e)})})},TR3.getFeatFromOL=function(e){TR3.loadingDiv.style.display="block";for(var t=0;t<e.length;t++){for(var o,n=e[t].getGeometry(),a=n.layout,r=n.getType(),s=["Point","Line","LineString","Polygon","Circle"],i=0;i<s.length;i++)-1!=r.indexOf(s[i])&&(o=s[i]);if(a&&o){var l=a.length,c=new Array,T=new Array;if("Circle"==o)var d=new THREE.Vector3,a=(n.getCenter(d),n.getRadius()),c=(T=TR3.getCoordsByXYmod(d[0],-d[1],!1))?new THREE.Vector4(T[3],T[4],T[5],a):new THREE.Vector4(d[0],TR3.zMed,-d[1],a);else if("Point"==o){d=n.getCoordinates();c=(T=TR3.getCoordsByXYmod(d[0],-d[1],!1))?new THREE.Vector3(T[3],T[4],T[5]):new THREE.Vector3(d[0],TR3.zMed,-d[1])}else if(n.layout)for(var R,d=n.getCoordinates().toString().split(","),m=0;m<d.length;m+=l)T=2==l||0==d[m+2]?(R=TR3.getCoordsByXYmod(d[m],-d[m+1],!1))?[R[3],R[4],R[5]]:[d[m],TR3.zMed,-d[m+1]]:(R=TR3.zM2T(d[m+2],!0),[d[m],R,-d[m+1]]),c.push(new THREE.Vector3(T[0],T[1],T[2]));a=e[t].getStyle(),n=null,a=(a&&a.stroke_&&(a=a.getStroke().getColor(),n=new THREE.Color(a[0]/255,a[1]/255,a[2]/255)),{color:n}),n=TR3.makeVectFeat(c,o,a,{reload:!1});TR3.scene.add(n)}}TR3.loadingDiv.style.display="none",TR3.VectorEvEnd()},TR3.setFeatToOL=function(){var e=TR3.LyrFeatFromOri;new Array;if(TR3.scene)for(var t=0;t<TR3.vGeom.item.length;t++){var o=TR3.vGeom.item[t];if("handMade"==o.name){for(var n,a=new Array,r=o.geometry.getAttribute("position"),s=o.nPoint||r.version,i=0;i<s;i++)a.push([r.getX(i),-r.getZ(i),TR3.zM2T(r.getY(i))]);"LineLoop"==o.type?(n="Polygon",a.push([r.getX(0),-r.getZ(0),TR3.zM2T(r.getY(0))]),a=[a]):n="Point"==o.type?"Point":"LineString";var o=o.material.color,o=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(100, 100, 100, 0.2)"}),stroke:new ol.style.Stroke({color:[255*o.r,255*o.g,255*o.b,1],width:2})}),l=new ol.Feature({geometry:new ol.geom[n](a)});l.setStyle(o),e.getSource().addFeature(l)}}},TR3.extrude2Dfeature=function(e,t,o,n){for(var a=TR3.getCoordsByXYmod(o[0],o[1],!1,!0)[4],r=0,o=(n&&(a-=r=1),new THREE.Group),s=(o.TR3=new Object,new THREE.PlaneGeometry(1,1,e.length-1,1)),i=s.getAttribute("position"),l=[],c=0;c<e.length;c++){var T,d=new Array;if(!(d=n?[0,0,0,(T=TR3.translate2DbyXYmod(e[c][0],e[c][1],!0))[0],a,T[1]]:TR3.getCoordsByXYmod(e[c][0],e[c][1],!1,!0))||0==d[6])return!1;e[c][0]=d[3],e[c][1]=d[5],i.setXYZ(c,e[c][0],d[4],e[c][1])}for(c=0;c<e.length;c++){i.setXYZ(c+e.length,e[c][0],r+a+3*t,e[c][1]);var R=new THREE.Vector2(e[c][0],e[c][1]);l.push(R)}i.needsUpdate=!0;for(var m=TR3.getRandomColor(100,150).hex,m=Math.round(m),p=new THREE.MeshBasicMaterial({color:m}),m=new THREE.MeshBasicMaterial({color:m,side:THREE.BackSide,transparent:!0,opacity:.5}),s=new THREE.Mesh(s,p),p=new THREE.EdgesGeometry(s.geometry),u=new THREE.LineBasicMaterial({color:13421772}),p=new THREE.LineSegments(p,u),u=new THREE.ShapeGeometry(new THREE.Shape(l)),m=new THREE.Mesh(u,m),g=u.getAttribute("position"),c=0;c<g.count;c++)g.setXYZ(c,g.getX(c),r+a+3*t,g.getY(c));return g.needsUpdate=!0,o.add(p),o.add(m),o.add(s),TR3.scene.add(o),TR3.vGeom.build||(TR3.vGeom.build=new Array(0)),TR3.vGeom.build.push(o),o},TR3.getRandomColor=function(e,t){var o=getRandomInt(e,t),n=getRandomInt(e,t),e=getRandomInt(e,t);return{rgb:[o,n,e],hex:Number("0x"+o.toString(16)+n.toString(16)+e.toString(16))}},TR3.setGeometry=function(e,t,o){var n,a=(e=void 0===e?{}:e).hasOwnProperty("depth")?e.depth:5.97,r=e.hasOwnProperty("height")?e.height:5.97,s=e.hasOwnProperty("width")?e.width:5.97,i=e.hasOwnProperty("heightSegments")?e.heightSegments:32,l=!!e.hasOwnProperty("openEnded")&&e.openEnded,c=e.hasOwnProperty("phiLength")?e.phiLength:2*Math.PI,T=(6.283==c&&(c=2*Math.PI),e.hasOwnProperty("phiStart")?e.phiStart:0),d=e.hasOwnProperty("radius")?e.radius:100,R=e.hasOwnProperty("radiusBottom")?e.radiusBottom:100,m=e.hasOwnProperty("radiusTop")?e.radiusTop:100,p=e.hasOwnProperty("thetaLength")?e.thetaLength:Math.PI,u=(6.283==p&&(p=2*Math.PI),e.hasOwnProperty("thetaStart")?e.thetaStart:0),g=e.hasOwnProperty("segments")?e.segments:32,h=e.hasOwnProperty("widthSegments")?e.widthSegments:32,y=!!(o=void 0===o?{}:o).hasOwnProperty("WireframeGeometry")&&o.WireframeGeometry,v=!!o.hasOwnProperty("EdgesGeometry")&&o.EdgesGeometry,f=!!o.hasOwnProperty("slctItem")&&o.slctItem,b=!!o.hasOwnProperty("transform")&&o.transform,E=!!o.hasOwnProperty("color")&&o.color,M=!!o.hasOwnProperty("extraData")&&o.extraData,E=E?t||new THREE.MeshBasicMaterial({color:E}):t||new THREE.MeshNormalMaterial({side:THREE.DoubleSide,opacity:.5,transparent:!0,depthTest:!0,depthWrite:!0,flatShading:!0});switch(e.geometry.toLowerCase()){case"box":n=new THREE.BoxGeometry(s,r,a,1,1,1);break;case"plane":(n=new THREE.PlaneGeometry(s,r,1,1)).rotateX(Math.PI/2);break;case"cylinder":n=new THREE.CylinderGeometry(m,R,r,g,1,l,u,p);break;case"cone":n=new THREE.ConeGeometry(d,r,g,i,l,u,p);break;case"circle":(n=new THREE.CircleGeometry(d,g,u,p)).rotateX(Math.PI/2);break;case"sphere":n=new THREE.SphereGeometry(d,h,i,T,c,u,p);break;case"semisphere":(n=new THREE.SphereGeometry(d,h,i,0,Math.PI,0,Math.PI)).rotateX(Math.PI);break;default:n=new THREE.BoxGeometry(s,r,a,1,1,1)}var x,w,S,E=new THREE.Mesh(n,E),v=(1==v&&(x=new THREE.EdgesGeometry(n),w=new THREE.LineBasicMaterial({color:13421772}),S=new THREE.LineSegments(x,w),E.add(S)),1==y&&(x=new THREE.WireframeGeometry(n),w=new THREE.LineBasicMaterial({color:13421772}),S=new THREE.LineSegments(x,w),E.add(S)),TR3.getSizeObj(E));return E.TR3=new Object,E.TR3.box=v[3],E.TR3.hitbox=v[4],E.TR3.radius=v[5],E.TR3.slctItem=!0,E.TR3.extraData=M||new Array,E.TR3.source={geom:e,mat:t,opts:o},1==f&&TR3.vGeom.obj3d.push(E),1==b&&TR3.transCtrlsEnabled(E),E},TR3.setLight=function(e,t,o){var e=e||"#ffffff",t=t||1,o=o||100,e=new THREE.Color(e),n="#"+e.getHexString(),e=new THREE.PointLight(e,t,o),n=(e.TR3=new Object,e.TR3.extraData=new Array,e.TR3.source={color:n,inten:t,dist:o},TR3.tPixMesh/10),t=new THREE.PointLightHelper(e,n);return TR3.vGeom.lights.push([e,t]),[e,t]},TR3.personViewFn=function(e){var t=e||TR3.moveKey.size,e=(TR3.controls.enableDamping=!1,TR3.controls.maxPolarAngle=1/0,TR3.controls.enableKeys=!1,TR3.camera.position.x=TR3.cursor.coordClick.x,TR3.camera.position.z=TR3.cursor.coordClick.z,TR3.getOptModCoordCam());e&&-1e7!=e[1]?(TR3.changeHeight(e[1]+t,!0,!0,1),TR3.cursor.helper.scale.set(.05,.05,.05)):(TR3.initPosCamera(!0),setTimeout(function(){TR3.personViewFn(t)},1500))},TR3.orbitalViewFn=function(){TR3.moveKey.walk=!1,TR3.controls.enableKeys=!1,TR3.controls.maxPolarAngle=Math.PI/2.25,TR3.controls.enableDamping=!0;var e=TR3.getRayCaster(!1),e=TR3.getIntersect(e,[TR3.mesh]);e[0]?((e=TR3.getCoordsByXYmod(e[0][0].point.x,e[0][0].point.z,!1))&&e[2]&&TR3.controls.target.set(e[3],e[4],e[5]),TR3.cursor.helper.scale.set(.5,.5,.5)):(TR3.initPosCamera(!0),setTimeout(function(){TR3.orbitalViewFn()},1500))},TR3.initPosCamera=function(e){TR3.moveKey.walk=!1,TR3.controls.enableDamping=!0,1==e?new TWEEN.Tween(TR3.camera.position).to({x:TR3.mesh.position.x,y:TR3.cameraPositionFar,z:TR3.mesh.position.z},2e3).easing(TWEEN.Easing.Linear).on("complete",function(e){TR3.controls.target.set(e.x,0,e.z),TR3.controls.update(),TR3.CameraMoveEvEnd()}).start():(TR3.camera.position.set(TR3.mesh.position.x,TR3.cameraPositionFar,TR3.mesh.position.z),TR3.controls.target.set(0,0,0),TR3.controls.update())},TR3.changeHeight=function(e,t,o,n){n=n||2e3;TR3.zeroParallax=e,TR3.moveKey.azOriAng=TR3.controls.getAzimuthalAngle(),1==o?new TWEEN.Tween(TR3.camera.position).to({y:e},n).easing(TWEEN.Easing.Linear).on("complete",function(e){TR3.controls.target.set(e.x+.01,e.y,e.z+.01),TR3.controls.update(),TR3.setAzAngle(TR3.moveKey.azOriAng),TR3.controls.enableKeys=!0,TR3.CameraMoveEvEnd()}).start():TR3.camera.position.y=e,1==t&&(TR3.controls.target.y=e,TR3.controls.update())},TR3.moveKeyFn=function(e){var t;1==TR3.moveKey.walk&&(e=e||TR3.moveKey.size,t=TR3.getOptModCoordCam(),TR3.changeHeight(t[1]+e,!0,!1,1))},TR3.keyDown=function(e){1!=TR3.moving||"37"!=e.keyCode&&"38"!=e.keyCode&&"39"!=e.keyCode&&"40"!=e.keyCode||(TR3.moveKey.is=!0);var n,t,o,a,r=TR3.transformControls.object;switch(e.keyCode){case 87:TR3.transformControls.setMode("translate");break;case 69:TR3.transformControls.setMode("rotate");break;case 82:TR3.transformControls.setMode("scale");break;case 107:TR3.transformControls.setSize(TR3.transformControls.size+.1);break;case 109:TR3.transformControls.setSize(Math.max(TR3.transformControls.size-.1,.1));break;case 32:TR3.transformControls.enabled=!1,TR3.transCtrlsEnabled(!1);break;case 86:r.visible=!r.visible;break;case 46:TR3.transformControls.enabled&&r&&(s=new Array,s="Sprite"===r.type?TR3.vGeom.sprites:"PointLight"===r.type?TR3.vGeom.lights:TR3.vGeom.obj3d,TR3.del3dObj(r,s),TR3.transformMeshByObj3d());break;case 90:if(TR3.transformControls.enabled&&r){var s=1;r.TR3.animation?(r.TR3.animation+=1,s=r.TR3.animation):r.TR3.animation=1;for(var i=0;i<TR3.rotate.length;i++){var l=TR3.rotate[i][0];r.uuid==l.uuid&&(TR3.rotate.splice(i,1),i--)}for(i=0;i<TR3.rotatePart.length;i++){var c=TR3.rotatePart[i][0];r.uuid==c.uuid&&(TR3.rotatePart.splice(i,1),i--)}for(i=0;i<TR3.oscillate.length;i++){var T=TR3.oscillate[i][0];r.uuid==T.uuid&&(TR3.oscillate.splice(i,1),i--)}switch(s){case 1:TR3.oscillate.push([r,6,1,r.position.y]);break;case 2:TR3.rotate.push([r,.02]);break;case 3:TR3.rotatePart.push([r,2,1,1]);break;case 4:r.TR3.animation=!1}}break;case 27:TR3.keyScape()}if(TR3.transformControls.enabled&&r&&r.TR3&&"Sprite"!==r.type&&"PointLight"!==r.type)switch(e.keyCode){case 71:r.edgesTC=!r.edgesTC,r.edgesTC?r.traverse(function(e){var t,o;e.isMesh&&(o=e.geometry,o=new THREE.EdgesGeometry(o),t=new THREE.LineBasicMaterial({color:13421772}),(o=new THREE.LineSegments(o,t)).name="edges",e.add(o))}):TR3.keyScape();break;case 73:TR3.transCtrlsEnabled(!1);var d=r.position,R=TR3.pscs.getPscsValues().ball.mass,m=TR3.pscs.getPscsValues().ball.impulse,p=TR3.getRayCaster([new THREE.Vector3(TR3.camera.position.x,d.y,TR3.camera.position.z),new THREE.Vector3(d.x,d.y,d.z)],"point-point");TR3.pscs.makePscObj({pos:r.position,mass:R,mesh:r,dir:p.ray.direction.multiplyScalar(m)});break;case 65:!1===TR3.cloneObj?(TR3.cloneObj=!0,TR3.canvasDest.style.cursor="crosshair"):TR3.keyScape();break;case 77:TR3.transCtrlsEnabled(!1);var d=r.position,u=TR3.pscs.getPscsValues().ball;r.TR3&&(r.TR3.mass=u.mass),TR3.pscs.makePscObj({pos:d,mass:u.mass,mesh:r});break;case 70:r.TR3.transformMesh?r.TR3.transformMesh+=1:r.TR3.transformMesh=1,TR3.transformMeshByObj3d();break;case 88:TR3.keyScape(),r.TR3.floorMesh=!r.TR3.floorMesh;break;case 79:d=TR3.getCoordsByXYmod(r.position.x,r.position.z);r.position.y=d[4]-+r.TR3.box.min.y*r.scale.y,r.TR3.zFalse=!0;break;case 83:r.newMaterial||(r.newMaterial=0);var g=["MeshBasicMaterial","MeshLambertMaterial","MeshPhongMaterial","MeshStandardMaterial"];r.traverse(function(e){var t;e.isMesh&&e.material&&e.material.color&&(t=new THREE[g[r.newMaterial]]({color:e.material.color}),e.material=t)}),r.newMaterial++,r.newMaterial>=g.length&&(r.newMaterial=!1);break;case 76:var R=TR3.coordM2T(r.position.x,r.position.y,r.position.z),d=TR3.getSizeObj(r),h=+d[1][0]/TR3.adjustScale,y=+d[0][0]/TR3.adjustScale,d=+d[2][0]/TR3.adjustScale,v=THREE.MathUtils.radToDeg(r.rotation.x),f=THREE.MathUtils.radToDeg(r.rotation.y),b=THREE.MathUtils.radToDeg(r.rotation.z),R='<div id="infohelp3dObj" style="padding:10px 40px">\t\t\t\t\t\t\t\t<div align="center"><b>Position</b></div>\t\t\t\t\t\t\t\t<input id="hidden3D" style="display: none" value="" autofocus><br>\t\t\t\t\t\t\t\t<b><span>X: </span></b><input id="Xpos3D" type="text" style="" value="'+R[0]+'"><br>\t\t\t\t\t\t\t\t<b><span>Y: </span></b><input id="Ypos3D" type="text" style="" value="'+R[1]+'"><br>\t\t\t\t\t\t\t\t<b><span>Z: </span></b><input id="Zpos3D" type="text" style="" value="'+R[2]+'"><br>\t\t\t\t\t\t\t\t<div align="center"><b>Size</b></div>\t\t\t\t\t\t\t\t<b><span>Alto: </span></b><input id="Height3D" type="text" style="" value="'+h+'"><br>\t\t\t\t\t\t\t\t<b><span>Largo: </span></b><input id="Width3D" type="text" style="" value="'+y+'"><br>\t\t\t\t\t\t\t\t<b><span>Profundo: </span></b><input id="Depth3D" type="text" style="" value="'+d+'"><br>\t\t\t\t\t\t\t\t<label><input type="checkbox" id="normalizeSize"> Proporcionar</label><br>\t\t\t\t\t\t\t\t<div align="center"><b>Angle</b></div>\t\t\t\t\t\t\t\t<b><span>W: </span></b><input id="Wangle3D" type="text" style="" value="'+v+'"><br>\t\t\t\t\t\t\t\t<b><span>Phi: </span></b><input id="PHIangle3D" type="text" style="" value="'+f+'"><br>\t\t\t\t\t\t\t\t<b><span>K: </span></b><input id="Kangle3D" type="text" style="" value="'+b+'"><br>\t\t\t\t\t\t\t\t<div align="center"><input id="UpdateData3D" type="button"  onclick="TR3.UpdateKeys3D(76)" value=" Actualizar Datos " style="margin-left:10px" class=""><br>\t\t\t\t\t\t\t\t<input id="UpdateGeom3D" type="button"  onclick="TR3.UpdateGeom3D(1)" value=" Posición " style="margin-left:10px" class="">\t\t\t\t\t\t\t\t<input id="UpdateGeom3D" type="button"  onclick="TR3.UpdateGeom3D(2)" value=" Tamaño " style="margin-left:10px" class="">\t\t\t\t\t\t\t\t<input id="UpdateGeom3D" type="button"  onclick="TR3.UpdateGeom3D(3)" value=" Ángulo " style="margin-left:10px" class="">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>';document.getElementById("advices").innerHTML=R,$("#advices").dialog("open");break;case 84:r.transparentTC=!r.transparentTC,r.transparentTC?r.traverse(function(e){if(e.isMesh){var t=e.material;if(t.length)for(var o=0;o<t.length;o++){var n=t[o];n.transparent||(n.transparentTC=n.opacity,n.opacity=.25,n.transparent=!0)}else(t=e.material).transparent||(t.side=2,t.sideTC=t.side,t.transparentTC=t.opacity,t.opacity=.25,t.transparent=!0)}}):TR3.keyScape();break;case 67:r.clippingPlanes?TR3.keyScape():(TR3.controls.enableZoom=!1,h=(TR3.getSizeObj(r)[3].max.y+TR3.getSizeObj(r)[3].min.y)/2,n=new THREE.Plane(new THREE.Vector3(0,-1,0),h),r.traverse(function(e){if(e.isMesh){var t=e.material;if(t.length)for(var o=0;o<t.length;o++)t[o].clippingPlanes=[n];else t.clippingPlanes=[n]}}),r.clippingPlanes=!0)}if("85"==e.keyCode)for(i=0;i<TR3.vGeom.obj3d.length;i++)(E=TR3.vGeom.obj3d[i]).isFloor&&1==E.isFloor&&(p=TR3.getRayCaster([TR3.camera.position,new THREE.Vector3(0,1,0)],"point-vector",0,3),M=TR3.getIntersect(p,[E])[0][0])&&(i=TR3.vGeom.obj3d.length,x=M.point,TR3.changeHeight(x.y+TR3.moveKey.size,!0,!1));if("68"==e.keyCode)for(var E,M,x,i=0;i<TR3.vGeom.obj3d.length;i++)(E=TR3.vGeom.obj3d[i]).isFloor&&1==E.isFloor&&(p=TR3.getRayCaster([TR3.camera.position,new THREE.Vector3(0,-1,0)],"point-vector",TR3.moveKey.size+1,5),M=TR3.getIntersect(p,[E])[0][0])&&(i=TR3.vGeom.obj3d.length,x=M.point,TR3.changeHeight(x.y+TR3.moveKey.size,!0,!1));if("80"==e.keyCode&&(p=TR3.getRayCaster(TR3.cursor.event),M=TR3.getIntersect(p,[TR3.mesh])[0][0])&&M.point&&TR3.controls.target.set(M.point.x,M.point.y,M.point.z),1==TR3.camera.visible&&"17"==e.keyCode&&(t=Math.round(16777215*Math.random()),t=new THREE.Mesh(new THREE.BoxGeometry(.12,.12,1),new THREE.MeshBasicMaterial({color:t})),a=new THREE.Vector3(1,-1,0).unproject(TR3.camera),t.position.copy(a),t.quaternion.copy(TR3.camera.quaternion),TR3.scene.add(t),p=TR3.getRayCaster(),t.pos=a,t.vector=p.ray.direction,t.cont=0,t.colision=!1,t.distFrames=!1,TR3.pscs.plasmaBalls.push(t)),1==TR3.camera.visible&&"66"==e.keyCode&&(t=(u=TR3.pscs.getPscsValues().ball).mass,o=u.size/2,m=2*u.impulse,o=new THREE.Mesh(new THREE.SphereGeometry(o,10,10),new THREE.MeshBasicMaterial({color:Math.round(16777215*Math.random())})),a=new THREE.Vector3(1,-1,0).unproject(TR3.camera),(p=TR3.getRayCaster()).ray.direction.multiplyScalar(m),TR3.scene.add(o),TR3.pscs.makePscObj({pos:a,dir:p.ray.direction,mesh:o,mass:t})),"16"==e.keyCode&&(TR3.camera.visible=!TR3.camera.visible,0==TR3.camera.visible)){for(i=0;i<TR3.pscs.plasmaBalls.length;i++)TR3.scene.remove(TR3.pscs.plasmaBalls[i]);TR3.pscs.plasmaBalls=[]}},TR3.UpdateKeys3D=function(e){var t=new Array;t.keyCode=e,TR3.keyDown(t)},TR3.UpdateGeom3D=function(e){var t,o,n,a,r,s,i,l,c,T=TR3.transformControls.object;1==e?(n=+document.getElementById("Xpos3D").value,t=+document.getElementById("Ypos3D").value,o=+document.getElementById("Zpos3D").value,n=TR3.coordM2T(n,t,o,!0),T.position.set(n[0],n[1],n[2])):2==e?(t=document.getElementById("Width3D").value,o=document.getElementById("Height3D").value,n=document.getElementById("Depth3D").value,a=+(s=TR3.getSizeObj(T))[1][0]/TR3.adjustScale,i=t/(r=+s[0][0]/TR3.adjustScale),l=o/a,c=n/(s=+s[2][0]/TR3.adjustScale),document.getElementById("normalizeSize").checked&&(t/r!=1?i=l=c=i:o/a!=1?i=l=c=l:n/s!=1&&(i=l=c)),T.scale.x=T.scale.x*i,T.scale.y=T.scale.y*l,T.scale.z=T.scale.z*c):3==e&&(T.rotation.x=0,T.rotation.y=0,T.rotation.z=0,T.rotateX(THREE.MathUtils.degToRad(+document.getElementById("Wangle3D").value)),T.rotateY(THREE.MathUtils.degToRad(+document.getElementById("PHIangle3D").value)),T.rotateZ(THREE.MathUtils.degToRad(+document.getElementById("Kangle3D").value))),TR3.UpdateKeys3D(76)},TR3.keyUp=function(e){TR3.moveKey.is=!1,TR3.transformControls.enabled&&17===e.keyCode&&(TR3.transformControls.setTranslationSnap(null),TR3.transformControls.setRotationSnap(null))},TR3.keyScape=function(){var n,e=TR3.transformControls.object;e.clippingPlanes&&"boolean"==typeof e.clippingPlanes&&(TR3.controls.enableZoom=!0,n=new THREE.Plane(new THREE.Vector3(0,-1,0),1/0),e.traverse(function(e){if(e.isMesh){var t=e.material;if(t.length)for(var o=0;o<t.length;o++)t[o].clippingPlanes=[n];else t.clippingPlanes=[n]}}),e.clippingPlanes=!1),e.userData.physicsBody&&(TR3.pscs.physicsWorld.removeRigidBody(e.userData.physicsBody),e.userData.physicsBody=!1,e.TR3.mass=!1),e.transparentTC&&"boolean"==typeof e.transparentTC&&(e.transparentTC=!1,e.traverse(function(e){if(e.isMesh){var t=e.material;if(t.length)for(var o=0;o<t.length;o++){var n=t[o];n.transparentTC&&(n.opacity=n.transparentTC,n.transparent=!1)}else t.transparentTC&&(t.opacity=t.transparentTC,t.transparent=!1)}})),e.TR3.transformMesh&&"number"==typeof e.TR3.transformMesh&&(e.TR3.transformMesh=4,TR3.transformMeshByObj3d()),e.TR3.floorMesh&&(e.TR3.floorMesh=!1),"boolean"==typeof TR3.cloneObj&&(TR3.cloneObj=!1,TR3.canvasDest.style.cursor="default"),e.edgesTC&&"boolean"==typeof e.edgesTC&&(e.edgesTC=!1,e.traverse(function(e){"edges"==e.name&&e.parent.remove(e)})),e.visible=!0,TR3.transCtrlsEnabled(!1)},TR3.getDist=function(e,t,o,n,a,r){for(var s,i,l=(r-o)/TR3.adjustScale,c=(TR3.distAlt+=l,s=TR3.formatMeasure(TR3.distAlt),TR3.getCoordsDistance([e,t],[n,a])),l=(TR3.dist2D+=c,i=TR3.formatMeasure(TR3.dist2D),TR3.dist3D+=Math.sqrt(Math.pow(c,2)+Math.pow(l,2)),c=TR3.formatMeasure(TR3.dist3D),TR3.setSegmentsByTerr(e,t,o,n,a,r,3)),T=l[1],d=new Array,R=0;R<T.length;R++)d.push(new THREE.Vector3(T[R][0],T[R][1],T[R][2]));e=TR3.makeVectFeat(d,"Line",{color:65280},{reload:!1});return TR3.scene.add(e),TR3.distTerr+=l[0],t=TR3.formatMeasure(TR3.distTerr),c={name:"Dist.3D",val:c[0],unit:c[1]},t={name:"Dist.terr",val:t[0],unit:t[1]},[{name:"Dist.2D",val:i[0],unit:i[1]},c,t,{name:"Dif.alt",val:s[0],unit:s[1]}]},TR3.getSurf=function(e,t){e.push(e[0]);for(var o=0,n=0,a=0,r=[],s=[],i=0,l=0;l<e.length-1;l++){for(var c=e[l][0],T=e[l][1],d=e[l][2],R=e[l+1][0],m=e[l+1][1],p=e[l+1][2],u=TR3.setSegmentsByTerr(c,T,d,R,m,p,3),g=0;g<u[1].length-1;g++)r.push(new THREE.Vector3(u[1][g][0],u[1][g][1],u[1][g][2])),s.push(new THREE.Vector2(u[1][g][0],u[1][g][2]));a+=u[0];for(var h,p=(p-d)/TR3.adjustScale,d=TR3.getCoordsDistance([c,T],[R,m]),y=(n+=d,o+=Math.sqrt(Math.pow(d,2)+Math.pow(p,2)),TR3.getSelectableObj()),g=0;g<y.length;g++)(h=y[g]).TR3&&h.TR3.floorMesh&&TR3.getCoordsByXYmod(e[l][0],e[l][1],[h],!0)[6]&&i++}if(i==e.length-1)M=h;else{for(var v=THREE.ShapeUtils.triangulateShape(s,[]),f=(new THREE.BufferGeometry).setFromPoints(r),b=[],l=0;l<v.length;l++)b.push(v[l][0],v[l][1],v[l][2]);f.setIndex(b);var E={color:"#777777",side:THREE.DoubleSide,transparent:!0,opacity:.75},M=TR3.makeMeshFeat(f,"Basic",E,{reload:!0})}TR3.scene.add(M);for(var x=t.geometry.getAttribute("position"),w=[],S=[],D=[],l=0;l<t.nPoint;l++){var C=TR3.coordM2T(x.getX(l),x.getY(l),x.getZ(l));w.push(new THREE.Vector2(C[0],C[1])),S.push(new THREE.Vector2(x.getX(l),x.getZ(l))),D.push(new THREE.Vector3(x.getX(l),x.getY(l),x.getZ(l)))}for(var E=TR3.formatMeasure(Math.abs(THREE.ShapeUtils.area(w)),"surf"),I=THREE.ShapeUtils.triangulateShape(S,[]),f=(new THREE.BufferGeometry).setFromPoints(D),b=[],k=0,z=0,P=0,l=0;l<I.length;l++){var H=I[l][0],B=I[l][1],G=I[l][2],x=(f.setIndex(b.push(H,B,G)),f.getAttribute("position")),H=new THREE.Vector3(x.getX(H),x.getY(H),x.getZ(H)),B=new THREE.Vector3(x.getX(B),x.getY(B),x.getZ(B)),G=new THREE.Vector3(x.getX(G),x.getY(G),x.getZ(G)),H=new THREE.Triangle(H,B,G),B=(k+=Math.abs(H.getArea()),TR3.makeSubTriangles([H],3)),G=TR3.get3dMetrics(B,M);z+=G[0],P+=G[1]}var O=TR3.formatMeasure(k,"surf"),j=TR3.formatMeasure(z,"surf"),A=TR3.formatMeasure(P,"vol"),n=TR3.formatMeasure(n),o=TR3.formatMeasure(o),a=TR3.formatMeasure(a);return[{name:"Per.2D",val:n[0],unit:n[1]},{name:"Per.3D",val:o[0],unit:o[1]},{name:"Per.terr",val:a[0],unit:a[1]},{name:"Surf.2D",val:E[0],unit:E[1]},{name:"Surf.3D",val:O[0],unit:O[1]},{name:"Surf.terr",val:j[0],unit:j[1]},P={name:"Vol.terr",val:A[0],unit:A[1]}]},TR3.makeSubTriangles=function(e,t){for(var t=t||1,o=TR3.tPixMesh*TR3.tPixMesh/2/t,n=0,a=new Array,n=0;n<e.length;n++){var r=e[n],s=new THREE.Vector3((r.a.x+r.b.x+r.c.x)/3,(r.a.y+r.b.y+r.c.y)/3,(r.a.z+r.b.z+r.c.z)/3),i=new Array;i.push(r.a,r.b,r.c,r.a);for(var l=0;l<i.length-1;l++){var c=s,T=i[l],d=i[l+1],R=new THREE.Vector3((T.x+d.x)/2,(T.y+d.y)/2,(T.z+d.z)/2),T=new THREE.Triangle(c,R,T),T=(a.push(T),new THREE.Triangle(c,R,d));a.push(T)}}return Math.abs(a[0].getArea())>o?TR3.makeSubTriangles(a,t):a},TR3.get3dMetrics=function(e,t){for(var o=0,n=0,a=TR3.makeMeshFeat("","Group","",{reload:!0}),r=0;r<e.length;r++){var s=[],i=TR3.getCoordsByXYmod(e[r].a.x,e[r].a.z,!1),i=(s.push(new THREE.Vector3(i[3],i[4],i[5])),TR3.getCoordsByXYmod(e[r].b.x,e[r].b.z,!1)),i=(s.push(new THREE.Vector3(i[3],i[4],i[5])),TR3.getCoordsByXYmod(e[r].c.x,e[r].c.z,!1)),i=(s.push(new THREE.Vector3(i[3],i[4],i[5])),(new THREE.BufferGeometry).setFromPoints(s)),l=new THREE.MeshBasicMaterial({color:"#00ff00",wireframe:!0}),i=new THREE.Mesh(i,l),l=(a.add(i),new THREE.Triangle(s[0],s[1],s[2])),i=Math.abs(l.getArea()),s=(o+=i,[]),l=(s.push(new THREE.Vector3(e[r].c.x,0,e[r].b.z)),s.push(new THREE.Vector3(e[r].c.x,0,e[r].b.z)),s.push(new THREE.Vector3(e[r].c.x,0,e[r].b.z)),new THREE.Triangle(s[0],s[1],s[2])),s=(Math.abs(l.getArea())+i)/2,l=new THREE.Vector2((e[r].a.x+e[r].b.x+e[r].c.x)/3,(e[r].a.z+e[r].b.z+e[r].c.z)/3),i=TR3.getCoordsByXYmod(l.x,l.y,!1),l=TR3.getCoordsByXYmod(l.x,l.y,[t]);n+=s*(i[2]-l[2])}return TR3.scene.add(a),[o,n]},TR3.setSegmentsByTerr=function(e,t,o,n,a,r,s,i){for(var l=new Array,c=new Array,o=(1==i&&(e=(i=TR3.coordM2T(e,t,o))[0],t=i[1],o=i[2],n=(i=TR3.coordM2T(n,a,r))[0],a=i[1],r=i[2]),Math.ceil(Math.abs((n-e)/TR3.tPixMesh))),i=Math.ceil(Math.abs((a-t)/TR3.tPixMesh)),T=Math.max(o,i)*s,d=0,R=(n-e)/T,m=(a-t)/T,p=0;p<T;p++){var u=TR3.getCoordsByXYmod(e+R*p,t+m*p,!1,!0);l.push([u[3],u[4],u[5]]),c.push([u[0],u[1],u[2]]);var g,h=(g=TR3.getCoordsByXYmod(e+R*(p+1),t+m*(p+1),!1,!0))[2]-u[2],u=TR3.getCoordsDistance([u[0],u[1]],[g[0],g[1]]);d+=Math.sqrt(Math.pow(u,2)+Math.pow(h,2))}return null!=g&&(l.push([g[3],g[4],g[5]]),c.push([g[0],g[1],g[2]])),[d,l,c]},TR3.getCoordsDistance=function(e,t){var o;return"undefined"!=typeof ol?(o=TR3.srsImg,e=ol.proj.toLonLat(e,o),t=ol.proj.toLonLat(t,o),ol.sphere.getDistance(e,t)):"undefined"!=typeof L?(o="EPSG:4326",e=L.latLng(proj4(proj4.defs(TR3.srsImg),proj4.defs(o),e)),t=L.latLng(proj4(proj4.defs(TR3.srsImg),proj4.defs(o),t)),e.distanceTo(t)):Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2))},TR3.getCoordsDistance3D=function(e,t){var o=(t[2]-e[2])/(TR3.adjustScale||1),e=TR3.getCoordsDistance([e[0],e[1]],[t[0],t[1]]);return Math.sqrt(Math.pow(e,2)+Math.pow(o,2))},TR3.formatMeasure=function(e,t){return e=e||1,t="surf"==t?1e6<Math.abs(e)?(e=(e/1e6).toFixed(3),"km2"):(e=e.toFixed(2),"m2"):"vol"==t?1e9<Math.abs(e)?(e=(e/1e9).toFixed(3),"km3"):(e=e.toFixed(2),"m3"):1e3<Math.abs(e)?(e=(e/1e3).toFixed(3),"km"):(e=e.toFixed(2),"m"),[e,t]},TR3.setCloneObj=function(e){var t=TR3.SkeletonUtilsClone(e),e=(t.TR3=JSON.parse(JSON.stringify(e.TR3)),t.TR3.blob=0,t.TR3.extraData&&(t.TR3.extraData.id="",t.TR3.extraData.changed=!0),new THREE.Vector3),e=(TR3.cursor.coordClick?(e.x=TR3.cursor.coordClick.x,e.y=TR3.cursor.coordClick.y,e.z=TR3.cursor.coordClick.z,e.y=TR3.operaValues(-1*t.TR3.box.min.y*t.scale.y,e.y,"suma")):console.log("fail position Clone"),t.position.set(e.x,e.y,e.z),t.TR3.aRotate);e&&("boolean"==typeof e[0]||"number"==typeof e[0]?"boolean"==typeof e[0]?TR3.rotate.push([t,.02]):t.rotation.y=e[0]:"boolean"==typeof e?TR3.rotate.push([t,.02]):t.rotation.y=e),TR3.vGeom.obj3d||(TR3.vGeom.obj3d=new Array(0)),TR3.vGeom.obj3d.push(t),TR3.scene.add(t)},TR3.makeMultiPos=function(e,t,o,n,a,r,s){for(var i=e.scene,l=1;l<t.length;l++){var c=t[l],T=o[l],d=a[l]||new Array,R=r[l],m=s[l],p=TR3.coordM2T(c[0],c[1],c[2],!0),u=new THREE.Vector3;u.x=p[0],u.y=p[1],u.z=p[2],u.w=c[2],TR3.makeClon(e,i,u,T,n,d,R,m)}},TR3.makeClon=function(e,t,o,n,a,r,s,i){var l=t.clone(),c=new Array;Object.assign(c,e),l.TR3=new Object,l.TR3=JSON.parse(JSON.stringify(t.TR3)),l.TR3.slctItem=s,l.TR3.aRotate=i,l.TR3.extraData=r,void 0!==t.TR3.mass&&"number"==typeof t.TR3.mass&&(TR3.pscs.physicsWorld?(l.TR3.mass=t.TR3.mass,TR3.pscs.goBrick(l)):l.TR3.mass=t.TR3.mass.toString()),n&&(l.TR3.isPixSize?(e=l.TR3.hitbox,n[0]=TR3.pix2geo(scaleSet[0])/e.x,n[1]=TR3.pix2geo(scaleSet[1])/e.z,n[2]=TR3.pix2geo(scaleSet[2])/e.y):l.TR3.isRealSize&&(r=n[0]/l.TR3.hitbox.y,(n=new Array)[0]=r,n[1]=r,n[2]=r),l.scale.set(n[0],n[2],n[1])),i&&("boolean"==typeof i[0]||"number"==typeof i[0]?"boolean"==typeof i[0]&&!0===i[0]?TR3.rotate.push([l,.02]):"number"==typeof i[0]&&(l.rotation.y=i):"boolean"!=typeof i&&"number"!=typeof i||("boolean"==typeof i&&!0===i?TR3.rotate.push([l,.02]):"number"==typeof i&&(l.rotation.y=i))),0<c.animations.length&&a&&((t=new THREE.AnimationMixer(l)).clipAction(c.animations[l.TR3.animateAction]).play(),TR3.mixer.push(t)),0==o.w&&(o.y=-1*l.TR3.box.min.y*l.scale.y),l.position.set(o.x,o.y,o.z),c.scene=l,TR3.vGeom.obj3d||(TR3.vGeom.obj3d=new Array(0)),!1!==s&&TR3.vGeom.obj3d.push(c),TR3.loadedFiles.push(c)},TR3.handleFileSelect=function(e){var t,o;TR3.sourceFile=!1,e.target.files?(t=e.target.files[0],document.getElementById(e.target.id+"_fake").value=t.name,TR3.sourceFile={blob:(window.URL||window.webkitURL).createObjectURL(t),src:t.name},(o=new FileReader).onload=function(){for(var e=!0,t=0;t<TR3.blobs.length;t++)TR3.blobs[t].src==TR3.sourceFile.src&&(e=!1);!0===e&&TR3.blobs.push({src:TR3.sourceFile.src,blobText:o.result}),TR3.canvasDest.style.cursor="crosshair"},o.readAsDataURL(t)):alert("Acción no soportada por su navegador, actualicese o utilice algún otro")},TR3.loadFile=function(t){var e,o=$.Deferred(),n=!!(t=void 0===t?{}:t).hasOwnProperty("src")&&t.src,a=document.getElementById("size3dObj"),r=(a.innerHTML="","loaderGLTF");return n?e=(e=n.split("."))[e.length-1]:(e=TR3.sourceFile.src.split(".")[1].toLowerCase(),n=TR3.sourceFile.blob,t.src=TR3.sourceFile.src,t.slctItem=!0,t.persist2Scene=!0),"ifc"==e&&(t.isFloor=!0,r="loaderIFC"),t.ext=e,!n||"glb"!=e&&"ifc"!=e?console.log("error srcLoad or extension"):TR3[r].load(n,function(e){TR3.loaderGLTFsucces(e,o,t)},function(e){a.innerHTML=Math.round(e.loaded/e.total*100)+"% loaded"},function(e){a.innerHTML="error: "+e.message,console.log(e),TR3.unlock3d("obj3d")}),o.promise()},TR3.loaderGLTFsucces=function(e,t,o){var n=!!(o=void 0===o?{}:o).hasOwnProperty("pos")&&o.pos,a=!o.hasOwnProperty("animation")||o.animation,r=!!o.hasOwnProperty("scale")&&o.scale,s=!!o.hasOwnProperty("aRotate")&&o.aRotate,i=!!o.hasOwnProperty("apilator")&&o.apilator,l=!!o.hasOwnProperty("slctItem")&&o.slctItem,c=!!o.hasOwnProperty("isPixSize")&&o.isPixSize,T=!!o.hasOwnProperty("isRealSize")&&o.isRealSize,d=!!o.hasOwnProperty("isFloor")&&o.isFloor,R=!!o.hasOwnProperty("src")&&o.src,m=!!o.hasOwnProperty("ext")&&o.ext,p=!!o.hasOwnProperty("persist2Scene")&&o.persist2Scene,u=!!o.hasOwnProperty("mass")&&o.mass,g=o.hasOwnProperty("extraData")?o.extraData:new Array,h=o.hasOwnProperty("animateAction")?o.animateAction:0,p=(e.persist2Scene=p,e.scene||e),y=TR3.getSizeObj(p);p.TR3=new Object,p.TR3.box=y[3],p.TR3.hitbox=y[4],p.TR3.radius=y[5],p.TR3.srcLoad=R,p.TR3.isPixSize=c,p.TR3.isRealSize=T,p.TR3.aRotate=s,p.TR3.mass=u,p.TR3.animateAction=h,Array.isArray(l)?p.TR3.slctItem=l[0]:l&&(p.TR3.slctItem=l);document.getElementById("size3dObj").innerHTML="<b>X:</b>"+(+y[0][0]/TR3.adjustScale).toFixed(2)+y[0][1]+" <b>Y:</b>"+(+y[2][0]/TR3.adjustScale).toFixed(2)+y[2][1]+" <b>Z:</b>"+(+y[1][0]/TR3.adjustScale).toFixed(2)+y[1][1];var v,R=!1,T=(e.animations&&0<e.animations.length&&a&&(R=!0,(c=new THREE.AnimationMixer(p)).clipAction(e.animations[h]).play(),TR3.mixer.push(c)),"object"==typeof g[0]?p.TR3.extraData=g[0]:g&&(p.TR3.extraData=g),p.TR3.source=JSON.parse(JSON.stringify(o)),!1),y=new THREE.Vector3,h=("object"==typeof n[0]?(0==n[0][2]&&(T=!0),v=TR3.coordM2T(n[0][0],n[0][1],n[0][2],!0),y.x=v[0],y.y=v[1],y.z=v[2]):n?(0==n[2]&&(T=!0),v=TR3.coordM2T(n[0],n[1],n[2],!0),y.x=v[0],y.y=v[1],y.z=v[2]):(T=!0,TR3.cursor.coordClick?(y.x=TR3.cursor.coordClick.x,y.y=TR3.cursor.coordClick.y,y.z=TR3.cursor.coordClick.z):console.log("fallo loaderGLTFsucces")),[1,1,1]);r&&(h="object"==typeof r[0]?JSON.parse(JSON.stringify(r[0])):JSON.parse(JSON.stringify(r)),p.TR3.isPixSize?(c=p.TR3.hitbox,h[0]=TR3.pix2geo(h[0])/c.x,h[1]=TR3.pix2geo(h[1])/c.z,h[2]=TR3.pix2geo(h[2])/c.y):p.TR3.isRealSize&&(o=h[0]/p.TR3.hitbox.y,h[0]=o,h[1]=o,h[2]=o),p.scale.set(h[0],h[2],h[1])),s&&("boolean"==typeof s[0]||"number"==typeof s[0]?"boolean"==typeof s[0]&&!0===s[0]?TR3.rotate.push([p,.02]):"number"==typeof s[0]&&(p.rotation.y=s):"boolean"!=typeof s&&"number"!=typeof s||("boolean"==typeof s&&!0===s?TR3.rotate.push([p,.02]):"number"==typeof s&&(p.rotation.y=s))),d&&(e.isFloor=d),m&&(e.ext=m),!0===T&&(y.y=TR3.operaValues(-1*p.TR3.box.min.y*p.scale.y,y.y,"suma"),p.TR3.zFalse=!0),p.position.set(y.x,y.y,y.z),void 0!==u&&"number"==typeof u&&(TR3.pscs.physicsWorld?(p.TR3.mass=u,TR3.pscs.goBrick(p)):(p.TR3.mass=u.toString(),console.log("tooFast 2 physics"))),TR3.vGeom.obj3d||(TR3.vGeom.obj3d=new Array(0)),!1===l&&!R||TR3.vGeom.obj3d.push(e),TR3.sourceFile?(TR3.scene.add(p),TR3.transCtrlsEnabled(p)):(TR3.sourceFile="",document.getElementById("file_3d_fake").value="Explorar GLB/IFC..."),i&&!isNaN(i)&&TR3.makeApilator(e,r,i,a),"object"==typeof n[0]&&TR3.makeMultiPos(e,n,r,a,g,l,s),TR3.loadedFiles.push(e),TR3.onCompleteFilesEv(TR3.loadedFiles),t.resolve(TR3.loadedFiles),TR3.loadedFiles=new Array,document.getElementById("file_3d").value="",document.getElementById("file_3d_fake").value=" Explorar GLB/IFC... ",TR3.sourceFile=!1,TR3.canvasDest&&TR3.canvasDest.style&&(TR3.canvasDest.style.cursor="default")},TR3.pscs.physicsConf=function(){var e=new Ammo.btDefaultCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),o=new Ammo.btDbvtBroadphase,n=new Ammo.btSequentialImpulseConstraintSolver;TR3.pscs.physicsWorld=new Ammo.btDiscreteDynamicsWorld(t,o,n,e),TR3.pscs.physicsWorld.setGravity(new Ammo.btVector3(0,-9.8,0)),TR3.pscs.transformAux1=new Ammo.btTransform},TR3.pscs.setGround=function(){var e=TR3.mesh.position,t=TR3.pscs.createTerrainShapePscs(),o=new Ammo.btTransform,e=(o.setIdentity(),o.setOrigin(new Ammo.btVector3(e.x,(TR3.zM2T(TR3.zMax,!0)+TR3.zM2T(TR3.zMin,!0))/2,e.z)),new Ammo.btVector3(0,0,0)),o=new Ammo.btDefaultMotionState(o),o=new Ammo.btRigidBody(new Ammo.btRigidBodyConstructionInfo(0,o,t,e));TR3.pscs.physicsWorld.addRigidBody(o),TR3.mesh.userData.physicsBody=o},TR3.pscs.rainPhy=function(){for(var e=TR3.pscs.getPscsValues().zone,t=TR3.mesh.geometry.getAttribute("position"),o=TR3.reducMeshW,n=TR3.reducMeshH,a=0,r=Math.random(),s=r*TR3.formatMeasure(TR3.tPixMesh)[0]/10,i=new THREE.SphereGeometry(e.size,10,10),l=new THREE.MeshBasicMaterial({color:Math.round(16777215*r)}),c=1;a<n*o-2*+o;c++)for(var a=c*e.interval*o,T=1;T<o-1;){var d=new THREE.Vector3,R=(d.x=t.getX(a+T)+TR3.mesh.position.x+s,d.z=t.getZ(a+T)+TR3.mesh.position.z+s,d.y=1.1*TR3.zM2T(TR3.zMax,!0)+100,new THREE.Vector3(e.direction[0],e.direction[1],e.direction[2])),m=(R.multiplyScalar(e.impulse),new THREE.Mesh(i,l));TR3.pscs.rain.push(m),TR3.scene.add(m),TR3.pscs.makePscObj({pos:d,dir:R,mesh:m,mass:e.mass}),T+=e.interval}},TR3.pscs.createTerrainShapePscs=function(){for(var e=TR3.reducMeshW,t=TR3.reducMeshH,o=TR3.zone,n=TR3.mesh.geometry.getAttribute("position"),a=Ammo._malloc(4*e*t),r=0,s=0,i=n.getY(0),l=n.getY(0),c=0;c<t;c++)for(var T=0;T<e;T++){var d=n.getY(r);(Ammo.HEAPF32[a+s>>2]=d)<i&&(i=d),l<d&&(l=d),r++,s+=4}TR3.zMin=i,TR3.zMax=l;var R=new Ammo.btHeightfieldTerrainShape(e,t,a,1,TR3.zM2T(TR3.zMin,!0),TR3.zM2T(TR3.zMax,!0),1,"PHY_FLOAT",!1),m=(o[2]-o[0])/(e-1),o=(o[3]-o[1])/(t-1);return R.setLocalScaling(new Ammo.btVector3(m,1,o)),R.setMargin(.05),R},TR3.pscs.updatePhysics=function(e){TR3.pscs.physicsWorld&&TR3.pscs.physicsWorld.stepSimulation&&TR3.pscs.physicsWorld.stepSimulation(e,10);for(var t=0,o=TR3.pscs.dynamicObjects.length;t<o;t++){var n=TR3.pscs.dynamicObjects[t],a=!1,r=(n.TR3&&(a=n.TR3.TCactive),n.userData.physicsBody);!a&&r&&(a=r.getMotionState())&&(a.getWorldTransform(TR3.pscs.transformAux1),r=TR3.pscs.transformAux1.getOrigin(),a=TR3.pscs.transformAux1.getRotation(),n.position.set(r.x(),r.y(),r.z()),n.quaternion.set(a.x(),a.y(),a.z(),a.w()),n.userData.collided=!1)}},TR3.pscs.clearPscsObjs=function(){for(var e=0;e<TR3.pscs.rain.length;e++){var t=TR3.pscs.rain[e];TR3.pscs.physicsWorld.removeRigidBody(t.userData.physicsBody),TR3.scene.remove(t)}TR3.pscs.rain=[],TR3.transCtrlsEnabled(!1)},TR3.pscs.updateGround=function(){TR3.pscs.physicsWorld.removeRigidBody(TR3.mesh.userData.physicsBody),TR3.mesh.userData.physicsBody=!1,TR3.pscs.setGround()},TR3.pscs.makePscObj=function(e){var t=!!(e=void 0===e?{}:e).hasOwnProperty("pos")&&e.pos,o=!!e.hasOwnProperty("dir")&&e.dir,n=!!e.hasOwnProperty("angVel")&&e.angVel,a=!!e.hasOwnProperty("mesh")&&e.mesh,r=!!e.hasOwnProperty("customShape")&&e.customShape,s=!!e.hasOwnProperty("mass")&&e.mass,e=!!e.hasOwnProperty("friction")&&e.friction,i=null,l=!1,c=(a.TR3&&a.TR3.hitbox&&(c=a.scale,T=a.TR3.hitbox,a.TR3.mass=s,T=new THREE.BoxGeometry(T.x*c.x,T.y*c.y,T.z*c.z),c=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.5,wireframe:!0}),(l=new THREE.Mesh(T,c)).position.set(t.x,t,t.z),T=a.quaternion,l.quaternion.set(T.x,T.y,T.z,T.w)),l||a),T=c.geometry.parameters,c=(r?i=TR3.pscs.createTriangleShapeByBufferGeometry(c):T.radius?i=new Ammo.btSphereShape(T.radius):T.depth&&(r=c.scale,i=new Ammo.btBoxShape(new Ammo.btVector3(.5*T.width*r.x,.5*T.height*r.y,.5*T.depth*r.z))),i.setMargin(.05),a.position.set(t.x,t.y,t.z),a.quaternion),T=s,r=new Ammo.btVector3(0,0,0),s=(i.calculateLocalInertia(T,r),new Ammo.btTransform),t=(s.setIdentity(),s.setOrigin(new Ammo.btVector3(t.x,t.y,t.z)),s.setRotation(new Ammo.btQuaternion(c.x,c.y,c.z,c.w)),new Ammo.btDefaultMotionState(s)),c=new Ammo.btRigidBodyConstructionInfo(T,t,i,r),s=new Ammo.btRigidBody(c),e=e||.5;return s.setFriction(e),o&&s.setLinearVelocity(new Ammo.btVector3(o.x,o.y,o.z)),n&&s.setAngularVelocity(new Ammo.btVector3(n.x,n.y,n.z)),a.userData.physicsBody=s,a.userData.collided=!1,TR3.pscs.dynamicObjects.push(a),0<T&&s.setActivationState(4),TR3.pscs.physicsWorld.addRigidBody(s),[s,a,l]},TR3.pscs.createTriangleShapeByBufferGeometry=function(e){for(var e=e.geometry,t=e.index.array,o=e.attributes.position.array,n=new Ammo.btTriangleMesh(!0,!0),a=0;a<t.length;a+=3){var r=3*t[a],s=3*t[a+1],i=3*t[a+2];n.addTriangle(new Ammo.btVector3(+o[0+r],+o[1+r],+o[2+r]),new Ammo.btVector3(+o[0+s],+o[1+s],+o[2+s]),new Ammo.btVector3(+o[0+i],+o[1+i],+o[2+i]),!1)}return new Ammo.btBvhTriangleMeshShape(n,!0,!0)},TR3.pscs.getPscsValues=function(){var e=new Object;return e.gravity=parseInt(-1*parseFloat(document.getElementById("gravityZone").value)),e.zone=new Object,e.zone.interval=parseInt(document.getElementById("coverZone").value),e.zone.size=parseFloat(document.getElementById("sizePtlZone").value),e.zone.mass=parseFloat(document.getElementById("massPtlZone").value),e.zone.impulse=parseFloat(document.getElementById("impulsePtlZone").value),e.zone.direction=document.getElementById("dirPtlZone").value.split(",").map(parseFloat),e.emisor=new Object,e.emisor.many=parseInt(document.getElementById("manyPtlEmisor").value),e.emisor.impulse=parseFloat(document.getElementById("impulsePtlEmisor").value),e.emisor.size=parseFloat(document.getElementById("sizePtlEmisor").value),e.emisor.mass=parseFloat(document.getElementById("massPtlEmisor").value),e.ball=new Object,e.ball.impulse=parseFloat(document.getElementById("impulsePtlBall").value),e.ball.size=parseFloat(document.getElementById("sizePtlBall").value),e.ball.mass=parseFloat(document.getElementById("massPtlBall").value),TR3.pscs.physicsWorld&&TR3.pscs.physicsWorld.getGravity().y()!=e.gravity&&TR3.pscs.physicsWorld.setGravity(new Ammo.btVector3(0,e.gravity,0)),e},TR3.pscs.setEmisor=function(){var e=Math.random(),t=TR3.pscs.getPscsValues().emisor,o=new THREE.SphereGeometry(t.size,4,2),e=new THREE.MeshBasicMaterial({color:Math.round(16777215*e)}),e=new THREE.Mesh(o,e),n=new THREE.EdgesGeometry(o),a=new THREE.LineBasicMaterial({color:13421772}),n=new THREE.LineSegments(n,a),a=(e.add(n),o.getAttribute("position").array),n=new THREE.SphereGeometry(t.size/4,4,2),o=new THREE.MeshBasicMaterial({color:7829367}),n=new THREE.Mesh(n,o);if(e.add(n),n.position.set(a[0],a[1],a[2]),!TR3.cursor.coordClick)return console.log("fallo setEmisor"),!1;e.position.set(TR3.cursor.coordClick.x,TR3.cursor.coordClick.y+t.size,TR3.cursor.coordClick.z),e.userData.slctItem=!0,e.TR3=new Object,TR3.pscs.emiters||(TR3.pscs.emiters=new Array(0)),TR3.pscs.emiters.push(e),TR3.vGeom.obj3d||(TR3.vGeom.obj3d=new Array(0)),TR3.vGeom.obj3d.push(e),TR3.scene.add(e),TR3.transCtrlsEnabled(e)},TR3.pscs.goEmisor=function(){if(TR3.pscs.emiters){TR3.transCtrlsEnabled(!1);for(var e=TR3.pscs.getPscsValues().emisor,t=TR3.pscs.emiters,o=Math.random(),n=0;n<t.length;n++)for(var a=t[n],r=new THREE.Mesh(new THREE.SphereGeometry(e.size,10,10),new THREE.MeshBasicMaterial({color:Math.round(16777215*o)})),s=0;s<e.many;s++){var i=a.position,l=a.geometry.getAttribute("position").array,c=new THREE.Vector3,l=(c.x=l[0],c.y=l[1],c.z=l[2],c.applyMatrix4(a.matrixWorld),new THREE.Vector3);l.subVectors(i,c).normalize().negate(),l.multiplyScalar(e.impulse),TR3.scene.add(r),TR3.pscs.makePscObj({pos:a.position,dir:l,mesh:r,mass:e.mass})}}},TR3.pscs.removeEmisors=function(){if(TR3.pscs.emiters){TR3.transCtrlsEnabled(!1);for(var e=TR3.pscs.emiters,t=0;t<e.length;t++){var o=e[t];TR3.del3dObj(o,TR3.vGeom.obj3d),TR3.pscs.physicsWorld.removeRigidBody(o.userData.physicsBody)}TR3.pscs.emiters=[]}},TR3.pscs.goBrick=function(e,t){var o,n,e=e||TR3.transformControls.object;TR3.pscs.bricks&&(TR3.transCtrlsEnabled(!1),o=TR3.pscs.getPscsValues().ball.mass,e.userData.physicsBody||(e.TR3&&"number"==typeof e.TR3.mass&&(TR3.pscs.bricks.push(e),n=e.TR3.mass),TR3.pscs.makePscObj({pos:e.position,mass:n=t?o:n,mesh:e})))},TR3.clearMeshMap=function(e){var t=TR3.canvasDest,o=TR3.scene,n=TR3.renderer;if("evtOl"==e&&TR3.setFeatToOL(),t&&Detector.webgl){var a=function(e){e.dispose();for(var t=0,o=Object.keys(e);t<o.length;t++){var n=e[o[t]];n&&"object"==typeof n&&"minFilter"in n&&n.dispose()}};for(n.dispose(),o.traverse(function(e){if(e.isMesh)if(e.userData&&e.userData.physicsBody&&TR3.pscs.physicsWorld.removeRigidBody(e.userData.physicsBody),e.geometry.dispose(),e.material.isMaterial)a(e.material);else for(var t=0,o=e.material;t<o.length;t++){var n=o[t];a(n)}}),o.remove.apply(o,o.children);0<o.children.length;)o.remove(o.children[0]);TR3.canvasDest=null,t.remove()}else t&&Detector.canvas&&(t.getContext("2d").clearRect(0,0,t.width,t.height),t.remove());t&&(TR3.stopAnimation(),TWEEN.removeAll()),TR3.del_vGeom()},TR3.onTransformEvTrue=function(e){e=new CustomEvent("TR3-onTransformEvTrue",{detail:e});TR3.map.dispatchEvent(e)},TR3.onSuprFnc=function(e){e=new CustomEvent("TR3-onSuprFnc",{detail:e});TR3.map.dispatchEvent(e)},TR3.onCreateItem=function(e){e=new CustomEvent("TR3-onCreateItem",{detail:e});TR3.map.dispatchEvent(e)},TR3.onCompleteFilesEv=function(e){e=new CustomEvent("TR3-onCompleteFiles",{detail:e});TR3.map.dispatchEvent(e)},TR3.intersectEvOver=function(e){e=new CustomEvent("TR3-onIntersectEvOver",{detail:e});TR3.map.dispatchEvent(e)},TR3.intersectEvClick=function(e){e=new CustomEvent("TR3-onIntersectEvClick",{detail:e});TR3.map.dispatchEvent(e)},TR3.CameraMoveEvEnd=function(e){e&&console.log(e);e=new CustomEvent("TR3-onCameraMoveEnd",{detail:"an event"});TR3.map.dispatchEvent(e)},TR3.VectorEvEnd=function(e){e&&console.log(e);e=new CustomEvent("TR3-onVectorEnd",{detail:"an event"});TR3.map.dispatchEvent(e)},TR3.MeasureEvEnd=function(e,t){e=new CustomEvent("TR3-onMeasureEnd",{detail:[e,t]});TR3.map.dispatchEvent(e)},TR3.setMeshMap=function(imgOri,dtmOri,bboxImgOri,optionsSet,valuesSet){var imgControl,cursor3d,anaglyph,magnification,autoRotate,wireframeMesh,tentative,terrain,txtSupportWebgl,txtSupportHTML5,hemispheric,moves,imgOrbitalMoves,moves;TR3.loadingDiv=document.getElementById("loadingTerrain"),TR3.imgOri=imgOri,TR3.dtmOri=dtmOri,document.getElementById("3doptions").style.display="none",TR3.bboxImgOri&&JSON.stringify(bboxImgOri)==JSON.stringify(TR3.bboxImgOri)&&TR3.loadingDiv&&TR3.canvasDest&&0==TR3.newMap?(TR3.setImageMesh(imgOri),document.getElementById("3doptions").style.display="block"):(TR3.newMeshMap=1,TR3.newMap=!1,TR3.clearMeshMap(),TR3.bboxImgOri=[eval(bboxImgOri[0]),eval(bboxImgOri[1]),eval(bboxImgOri[2]),eval(bboxImgOri[3])],"longlat"===proj4.Proj(TR3.srsImg).projName?TR3.geo2UTM=4e7/360:TR3.geo2UTM=1,TR3.zone=[TR3.bboxImgOri[0]*TR3.geo2UTM,TR3.bboxImgOri[1]*TR3.geo2UTM,TR3.bboxImgOri[2]*TR3.geo2UTM,TR3.bboxImgOri[3]*TR3.geo2UTM],TR3.centerZone=[(TR3.zone[0]+TR3.zone[2])/2,(TR3.zone[1]+TR3.zone[3])/2],imgControl=optionsSet.imgControl,cursor3d=optionsSet.cursor3d,anaglyph=optionsSet.anaglyph,autoRotate=optionsSet.autoRotate,wireframeMesh=optionsSet.wireframeMesh,tentative=optionsSet.tentative,terrain=optionsSet.terrain,magnification=valuesSet.magnification,TR3.lookAt=valuesSet.lookAt,TR3.divContainer(),TR3.divLoading(),TR3.setMagniValues(magnification),TR3.setMeshZone(),TR3.canvasDest=TR3.cvsDesty(),Detector.canvas?Detector.webgl?TR3.renderer=new THREE.WebGLRenderer({logarithmicDepthBuffer:!0,canvas:TR3.canvasDest,antialias:!0}):(TR3.renderer=new THREE.CanvasRenderer({canvas:TR3.canvasDest}),TR3.widthImg||(txtSupportWebgl="Su navegador parece no soportar WebGl. Por favor, actualice su versión o pruebe algún otro.",alert(txtSupportWebgl),pSupportWebgl=document.createElement("p"),pSupportWebgl.id="pSupportWebgl",pSupportWebgl.style.color="#ff0000",pSupportWebgl.innerHTML=txtSupportWebgl,document.getElementById("initDialog").appendChild(pSupportWebgl),document.getElementById("anaglyphCheck").style.display="none",document.getElementById("anaglyphType").style.display="none")):TR3.widthImg||(txtSupportHTML5="Su navegador parece no soportar HTML5. Por favor, actualice su versión o pruebe algún otro.",alert(txtSupportHTML5),pSupportHTML5=document.createElement("p"),pSupportHTML5.id="pSupportHTML5",pSupportHTML5.style.color="#ff0000",pSupportHTML5.innerHTML=txtSupportHTML5,document.getElementById("initDialog").appendChild(pSupportHTML5),document.getElementById("OptionsDialog").style.display="none"),TR3.renderer.localClippingEnabled=!0,TR3.renderer.physicallyCorrectLights=!0,TR3.renderer.setSize(TR3.canvasDestW,TR3.canvasDestH),TR3.anaglyphRenderer=new TR3.AnaglyphEffect(TR3.renderer,0),TR3.anaglyphRenderer.setSize(TR3.canvasDestW,TR3.canvasDestH),TR3.scene=new THREE.Scene,TR3.clock=new THREE.Clock,TR3.loaderGLTF=new TR3.GLTFLoader,TR3.loaderIFC=new TR3.IFCLoader,TR3.loaderIFC.ifcManager.setWasmPath("../TR3-pack/THREE/loaders/ifc/"),TR3.loaderIFC.ifcManager.applyWebIfcConfig({COORDINATE_TO_ORIGIN:!0,USE_FAST_BOOLS:!0}),TR3.loaderFONT=new TR3.FontLoader,TR3.sky=new TR3.Sky,TR3.sky.name="Sky",TR3.scene.add(TR3.sky),TR3.camera=new THREE.PerspectiveCamera(TR3.fov,TR3.canvasDestW/TR3.canvasDestH,1,13e5),TR3.scene.add(TR3.camera),TR3.camera.visible=!1,hemispheric=new THREE.HemisphereLight(16777215,16777215,2),TR3.scene.add(hemispheric),imgOrbitalMoves=document.getElementById("imgOrbitalMoves"),moves=imgControl?imgOrbitalMoves:TR3.canvasDest,TR3.controls=new TR3.OrbitControls(TR3.camera,moves),TR3.controls.listenToKeyEvents(window),TR3.controls.maxPolarAngle=Math.PI/4,TR3.controls.enableDamping=!0,TR3.controls.screenSpacePanning=!1,TR3.transformControls=new TR3.TransformControls(TR3.camera,TR3.canvasDest),TR3.transformControls.name="TransformControls",TR3.transformControls.enabled=!1,TR3.scene.add(TR3.transformControls),TR3.transformControls.addEventListener("dragging-changed",function(e){TR3.controls.enabled=!e.value,TR3.CtrlDargClick=!0;var e=TR3.transformControls,t=document.getElementById("size3dObj");e.enabled&&(e=e.object)&&e.parent&&(e=TR3.getSizeObj(e),t.innerHTML="<b>X:</b>"+(+e[0][0]/TR3.adjustScale).toFixed(2)+e[0][1]+" <b>Y:</b>"+(+e[2][0]/TR3.adjustScale).toFixed(2)+e[2][1]+" <b>Z:</b>"+(+e[1][0]/TR3.adjustScale).toFixed(2)+e[1][1])}),TR3.makeSteve(),TR3.makeWorld(imgOri),TR3.persist2Scene(),TR3.setOptions(imgControl,cursor3d,anaglyph,autoRotate,wireframeMesh,tentative,terrain)),0!=TR3.oneMeshMap&&(window.addEventListener("resize",TR3.onWindowResize,!1),TR3.map.addEventListener("mousemove",TR3.onIntersect,!1),TR3.map.addEventListener("contextmenu",TR3.setCoods2clip,!1),TR3.map.addEventListener("click",TR3.click_Obj3d,!1),TR3.map.addEventListener("mousedown",function(e){var t=TR3.getSelectableObj();TR3.cursor.mouseDownID=!1,0<t.length&&TR3.optionsSet.tentative&&(e=TR3.getRayCaster(e),(e=TR3.getIntersect(e,t))[0])&&(TR3.cursor.mouseDownID=e[0][0].object.uuid)},!1),TR3.map.addEventListener("touchstart",function(e){var t=TR3.getSelectableObj();TR3.cursor.mouseDownID=!1,0<t.length&&TR3.optionsSet.tentative&&(e=TR3.getRayCaster(e),(e=TR3.getIntersect(e,t))[0])&&(TR3.cursor.mouseDownID=e[0][0].object.uuid)},!1),TR3.map.addEventListener("touchend",function(e){TR3.click_Obj3d(e)},!1),TR3.map.addEventListener("wheel",TR3.onMouseWheel,!1),window.addEventListener("keydown",TR3.keyDown,!1),window.addEventListener("keyup",TR3.keyUp,!1),Ammo().then(function(e){TR3.pscs.physicsConf(),TR3.animate(),TR3.oneMeshMap--}))},TR3.onMouseWheel=function(e){var t,r=Math.max(-1,Math.min(1,-e.wheelDelta||e.detail||e.deltaY));TR3.cursor.helper.visible&&TR3.zCursor(r),1==TR3.moveKey.walk&&(e=r*TR3.controls.keyPanSpeed/5,TR3.controls.keyPanSpeed=TR3.controls.keyPanSpeed+e),1==TR3.optionsSet.anaglyph&&(e=TR3.getRayCaster(!1),0<(e=TR3.getIntersect(e,[TR3.mesh])).length)&&(t=TR3.camera.position,TR3.zeroParallax=t.distanceTo(e[0][0].point)),TR3.transformControls.enabled&&(t=TR3.transformControls.object).clippingPlanes&&t.traverse(function(e){if(e.isMesh){var t=e.material;if(t.length)for(var o=0;o<t.length;o++){var n=t[o],a=n.clippingPlanes[0].constant+r/60;n.clippingPlanes[0].constant=a}else{a=t.clippingPlanes[0].constant+r/3;t.clippingPlanes[0].constant=a}}})},TR3.onWindowResize=function(){TR3.map.offsetWidth&&(TR3.canvasDest.width=TR3.map.offsetWidth,TR3.canvasDest.height=TR3.map.offsetHeight,TR3.canvasDestW=TR3.map.offsetWidth,TR3.canvasDestH=TR3.map.offsetHeight,TR3.camera.aspect=TR3.canvasDestW/TR3.canvasDestH,TR3.camera.updateProjectionMatrix(),TR3.renderer.setSize(TR3.canvasDestW,TR3.canvasDestH))},TR3.onCompleteMap=function(){if(TR3.lookAt&&TR3.setLookAt(TR3.lookAt),!TR3.mesh.userData.physicsBody&&TR3.pscs.physicsWorld?TR3.pscs.setGround():setTimeout(function(){TR3.pscs.setGround()},1e3),TR3.scene&&TR3.scene.children)for(var e=0;e<TR3.scene.children.length;e++){var t,o,n,a=TR3.scene.children[e];a.TR3&&("string"==typeof a.position.y?(n=(o=a.position.y.replaceAll("$","")).slice(-1),t=+o.slice(0,-1),t=o&&"T"==n?TR3.zM2T(t,!0):"P"==n?TR3.zM2T(TR3.pix2geo(t),!0)-TR3.zM2T(0,!0):o.replace(n,""),a.position.y=+t):1==a.TR3.zFalse&&(o=TR3.getCoordsByXYmod(a.position.x,a.position.z,!1),n=TR3.operaValues(-1*a.TR3.box.min.y*a.scale.y,o[4],"suma"),a.position.y=n),"string"==typeof a.TR3.mass)&&(a.TR3.mass=+a.TR3.mass,TR3.pscs.goBrick(a))}TR3.loadingDiv.style.display="none",TR3.dfd_setMap.resolve(TR3.mesh),document.getElementById("3doptions").style.display="block",(TR3.newMeshMap=0)<TR3.oneMeshMap&&TR3.oneMeshMap--},TR3.persist2Scene=function(){if(TR3.vGeom.obj3d)for(var e=0;e<TR3.vGeom.obj3d.length;e++){var t=TR3.vGeom.obj3d[e];1==t.persist2Scene&&(t=t.scene||(t.parent&&t.parent.scene?t.parent.scene:t),TR3.scene.add(t))}},TR3.lock3d=function(e){TR3.cursor.causeLock+=e},TR3.unlock3d=function(e){-1<TR3.cursor.causeLock.indexOf(e)&&(e=TR3.cursor.causeLock.split(e),TR3.cursor.causeLock=e.toString().replace(/,/g,""))},TR3.rectaValue=function(e,t,o,n,a){return(a-e)/(o-e)*(n-t)+t},TR3.rectaValue3D=function(e,t,o,n,a,r,s){return[s,TR3.rectaValue(e,t,n,a,s),TR3.rectaValue(e,o,n,r,s)]},TR3.geo2pix=function(e){return+e/(TR3.tPixImg*TR3.geo2UTM)},TR3.pix2geo=function(e){return e*(TR3.tPixImg*TR3.geo2UTM)},TR3.getSizePix=function(){return((TR3.zone[2]-TR3.zone[0])/TR3.widthImg+(TR3.zone[3]-TR3.zone[1])/TR3.heightImg)/2},TR3.setAzAngle=function(e){var t=TR3.controls.getAzimuthalAngle(),e=e<=0?-e:2*Math.PI-e,t=t<=0?-t:2*Math.PI-t;e>2*Math.PI&&(e-=2*Math.PI),t>2*Math.PI&&(t-=2*Math.PI);t=0<(t=t-e)?2*Math.PI-t:Math.abs(t);"function"==typeof TR3.controls.rotateLeft&&TR3.controls.rotateLeft(t)},TR3.getOptModCoordCam=function(){for(var e=TR3.camera.position,t=-1e7,o=new Array,n=2*TR3.getSizePix(),a=TR3.controls.getAzimuthalAngle(),r=e.x+n*Math.sin(a),s=e.z-n*Math.cos(a),i=0;i<TR3.vGeom.obj3d.length;i++){var l=TR3.vGeom.obj3d[i];l.isFloor&&1==l.isFloor&&(l=TR3.getCoordsByXYmod(r,s,[l],!1,e.y))&&1==l[6]&&o.push(l)}o.push(TR3.getCoordsByXYmod(r,s,!1,!1,e.y));for(i=0;i<o.length;i++)o[i]&&t<o[i][4]&&(t=o[i][4]);return[e.x,t,e.z]},TR3.getCoordsByXYmod=function(e,t,o,n,a){var r,s,i,l,c,T,a=(a=a||!1)||TR3.zM2T(TR3.zMax+500,!0)*TR3.valuesSet.magnification*3,d=Math.abs(TR3.zM2T(TR3.zMin-500,!0)*TR3.valuesSet.magnification*3),o=o||[TR3.mesh],n=(n&&(e-=TR3.centerZone[0],t=-(t-TR3.centerZone[1])),new THREE.Vector3(e,a,t)),R=new THREE.Vector3(0,-1,0),n=TR3.getRayCaster([n,R],"point-vector",0,a+d),R=TR3.getIntersect(n,o)[0][0];return d=R?(a=R.point,r=TR3.centerZone[0]+a.x,s=TR3.centerZone[1]-a.z,i=TR3.zM2T(a.y,!1),l=a.x,c=a.y,T=a.z,!0):(r=e+TR3.centerZone[0],s=-t+TR3.centerZone[1],i=TR3.zMed,l=e,c=TR3.zM2T(TR3.zMed,!0),T=t,!1),[r,s,i,l,c,T,d]},TR3.translate2DbyXYmod=function(e,t,o){o=o?-(TR3.centerZone[0]-e):e+TR3.centerZone[0];e=TR3.centerZone[1]-t;return[o,e]},TR3.coordM2T=function(e,t,o,n){var a,r,s,i;if(n){if(!(i=TR3.getCoordsByXYmod(e,t,!1,!0)))return!1;o||0===o||(o=i&&i[2]?i[2]:TR3.zM2T(TR3.zMed,!0)),a=i[3],r=TR3.zM2T(o,n),s=i[5]}else{if(!(i=TR3.getCoordsByXYmod(e,o,!1)))return!1;t||0===t||(t=i&&i[5]?i[5]:TR3.zM2T(TR3.zMed)),a=i[0],r=i[1],s=TR3.zM2T(t=0===t?0:t,n)}return[a,r,s]},TR3.zM2T=function(e,t){var o=t?(e-TR3.zMed)*TR3.valuesSet.magnification:e/TR3.valuesSet.magnification+TR3.zMed;return"string"!=typeof e?t?"number"==typeof o&&!isNaN(o)||(o="$"+e+"$T"):"number"==typeof o&&!isNaN(o)||(o="$"+e+"$M"):o=e,o},TR3.makeVectFeat=function(e,t,o,n){var a=new THREE.BufferGeometry,r=Math.round(16777215*Math.random()),s=new Array;if(s.color=o.color||r,s.side=o.side||THREE.DoubleSide,s.transparent=o.transparent||!1,s.wireframe=o.wireframe||!1,s.opacity=o.opacity||1,"Circle"==t){for(var r=new THREE.CircleGeometry(e.w,20),i=(r.rotateX(Math.PI/2),r.vertices),l=0;l<i.length;l++){i[l].x=e.x+i[l].x,i[l].z=e.z+i[l].z;var c=TR3.getCoordsByXYmod(i[l].x,i[l].z,!1);c?i[l].y=c[4]:e.y?i[l].y=e.y:i[l].y=TR3.zMed}i.push(i[1]),i.shift(),a.setFromPoints(i);var T=new THREE.LineBasicMaterial({color:s.color}),d=new THREE.LineLoop(a,T)}else d=new("Point"==t?(a.setFromPoints(e),o=50*TR3.getSizePix(),T=new THREE.PointsMaterial({color:s.color,size:o}),THREE.Points):"Poligon"==t?(a.setFromPoints(e),T=new THREE.LineBasicMaterial({color:s.color}),THREE.LineLoop):(a.setFromPoints(e),T=new THREE.LineBasicMaterial({color:s.color}),THREE.Line))(a,T);return n&&(d.reload=n.reload||!1,d.magni=TR3.valuesSet.magnification,TR3.vGeom.item.unshift(d)),d},TR3.makeMeshFeat=function(e,t,o,n){var a,r=Math.round(16777215*Math.random()),s=new Array,r=(s.color=o.color||r,s.side=o.side||THREE.DoubleSide,s.transparent=o.transparent||!1,s.wireframe=o.wireframe||!1,s.opacity=o.opacity||1,new THREE.MeshBasicMaterial({color:s.color,side:s.side,transparent:s.transparent,wireframe:s.wireframe,opacity:s.opacity}));return"Basic"==t?a=new THREE.Mesh(e,r):"Group"==t&&(a=new THREE.Group),n&&(a.reload=n.reload||!1,a.magni=TR3.valuesSet.magnification,TR3.vGeom.item.unshift(a)),a},TR3.setLookAtini=function(e,t){var o=TR3.zone,o=TR3.coordM2T(o[2]-.1,o[1]+.1,0,!0),n=TR3.mesh.position.x,a=TR3.mesh.position.y,t=(("number"!=typeof e||isNaN(e)||e<5)&&(e=100),("number"!=typeof t||isNaN(t)||t<0)&&(t=4),TR3.cameraPositionFar*t/100),r=TR3.getCoordsDistance3D([n,a,0],[o[0],-o[2],t]),o=TR3.rectaValue3D(n,a,0,o[0],-o[2],t,n+e/100*r);TR3.setLookAt([n,0,a,o[0],t,o[1]])},TR3.setLookAt=function(e){var t,o={x:e[3],y:e[4],z:e[5]},n=new THREE.Vector3(e[0],e[1],e[2]);e[6]&&!0===e[6]&&(t=TR3.coordM2T(t[3],t[4],t[5],!0),e=TR3.coordM2T(t[0],t[1],t[2],!0),o={x:t[0],y:t[1],z:t[2]},n=new THREE.Vector3(e[0],e[1],e[2])),new TWEEN.Tween(TR3.camera.position).to(o,1e3).easing(TWEEN.Easing.Linear).on("start",function(){TR3.controls.target=n,TR3.controls.update(),TR3.lookAt=!1}).on("complete",function(){TR3.mesh.rotation.z=0,TR3.CameraMoveEvEnd()}).start()},TR3.goScenes=function(e){e=e||TR3.config.actual.loc;TR3.config.lookAt=e.look,TR3.setLookAt(TR3.config.lookAt,e),TR3.setOpts({autoRotate:!0})},TR3.oscillator=function(e,t,o,n,a){return Math.sin(e*t*Math.PI*2+n*Math.PI*2)*o+a},TR3.operaValues=function(e,t,o){var n,a,r;return"string"==typeof t?(a=(r=t.replaceAll("$","")).slice(-1),r=+r.slice(0,-1),"suma"==o&&(n="$"+(r+e)+"$"+a)):"suma"==o&&(n=t+e),n},TR3.del3dObj=function(e,t,o){var n,a;if(t&&0<t.length){if(e||TR3.transformControls.enabled){n=e||TR3.transformControls.object,TR3.transCtrlsEnabled(!1);for(var r=0;r<t.length;r++){var s=!1,i=t[r];i[0]&&(i=i[0],s=!0),i=(i.scene||i).uuid,n.uuid==i&&(s&&((n=new Array).push(t[r][0]),n.push(t[r][1])),a=r,r=t.length)}}if(void 0===a&&(a=t.length-1),n.scene)TR3.scene.remove(n.scene);else if(0<n.length)for(r=0;r<n.length;r++)TR3.scene.remove(n[r]);else TR3.scene.remove(n);t.splice(a,1),!0!==o&&TR3.onSuprFnc(n)}},TR3.transCtrlsEnabled=function(e){var t,o,n;"object"==typeof e&&(TR3.transformControls.attach(e),e=!0),e?((t=TR3.transformControls.object)&&t.TR3&&(t.TR3.TCactive=!0),t.TR3.zFalse=!1,TR3.onTransformEvTrue(TR3.transformControls),TR3.lock3d("obj3d")):(TR3.unlock3d("obj3d"),(t=TR3.transformControls.object)&&(t.userData.physicsBody&&(TR3.pscs.physicsWorld.removeRigidBody(t.userData.physicsBody),t.userData.physicsBody=new Object,o=t.position,n=t.TR3.mass||0,TR3.pscs.makePscObj({pos:o,mass:n,mesh:t})),TR3.transformMeshByObj3d(),t.TR3)&&(t.TR3.TCactive=!1),TR3.transformControls.detach(),TR3.controls.enableZoom=!0),TR3.transformControls.enabled=e,TR3.transformControls.showX=e,TR3.transformControls.showY=e,TR3.transformControls.showZ=e},TR3.getSizeObj=function(e){var t=new THREE.Vector3,e=(new THREE.Box3).setFromObject(e),o=(e.getSize(t),e.getBoundingSphere(new THREE.Sphere).radius);return[TR3.formatMeasure(t.x),TR3.formatMeasure(t.y),TR3.formatMeasure(t.z),e,t,o]},TR3.getIgridByXY=function(e,t){var o=TR3.reducMeshW;return!(o<=e)&&o*t+e},TR3.getXYgridByI=function(e){var t=TR3.reducMeshW,o=TR3.reducMeshH,n=(e/t-parseInt(e/t))*t,e=parseInt(e/t);return!(t<=n||o<=e)&&[n,e]},TR3.lonLat2google=function(e){for(var t=new Array,o=0;o<e.length;o++){var n=20037508.34*e[o][0]/180,a=Math.log(Math.tan((90+e[o][1])*Math.PI/360))/(Math.PI/180);t.push([n,20037508.34*a/180])}return t},TR3.getIndexMeshZoneFromObj3d=function(e){for(var t,o,n=e.position,a=TR3.getSizeObj(e)[4],e=e.scale,r=a.x*e.x/2,s=a.z*e.z/2,i=-a.x*e.x/2,a=-a.z*e.z/2,l=[n.x+i,n.z+a,n.x+r,n.z+s],c=!0,T=!0,d=TR3.mesh.geometry.getAttribute("position"),R=0;R<d.count;R++){var m=d.getX(R),p=d.getZ(R*TR3.reducMeshW);l[0]<m&&!0===c&&(t=R,c=!1),l[1]<p&&!0===T&&(o=R,T=!1),!1===c&&!1===T&&(R=d.count)}for(var u=Math.floor((l[2]-l[0])/TR3.tPixMesh),g=Math.floor((l[3]-l[1])/TR3.tPixMesh),h=new Array,R=0;R<g;R++)for(var y=0;y<u;y++)h.push(TR3.getIgridByXY(t+y,o+R));return h},TR3.transformMeshByObj3d=function(e){TR3.assignZmeshByIndex();var t=TR3.mesh.geometry.getAttribute("position"),o=new Array;e?o.push(e):o=TR3.getSelectableObj();for(var n=0;n<o.length;n++){var a=o[n],r=a;if(a.scene?r=a.scene:a.parent&&a.parent.scene&&(r=a.parent.scene),r.TR3&&r.TR3.transformMesh){var s=TR3.getIndexMeshZoneFromObj3d(r);switch(r.TR3.transformMesh){case 1:for(var i=0;i<s.length;i++){var l=(new THREE.Vector3).fromBufferAttribute(t,s[i]),c=TR3.getRayCaster([l,new THREE.Vector3(0,1,0)],"point-vector",0,!1),T=TR3.getIntersect(c,[r])[0][0],d=TR3.getRayCaster([l,new THREE.Vector3(0,-1,0)],"point-vector",0,!1),R=TR3.getIntersect(d,[r])[0][0];T&&R?T.distance<R.distance?t.setY(s[i],T.point.y):t.setY(s[i],R.point.y):T?t.setY(s[i],T.point.y):R&&t.setY(s[i],R.point.y)}break;case 2:for(i=0;i<s.length;i++){l=(new THREE.Vector3).fromBufferAttribute(t,s[i]),c=TR3.getRayCaster([l,new THREE.Vector3(0,1,0)],"point-vector",0,!1);(T=TR3.getIntersect(c,[r])[0][0])&&t.setY(s[i],T.point.y)}break;case 3:for(i=0;i<s.length;i++){l=(new THREE.Vector3).fromBufferAttribute(t,s[i]),d=TR3.getRayCaster([l,new THREE.Vector3(0,-1,0)],"point-vector",0,!1);(R=TR3.getIntersect(d,[r])[0][0])&&t.setY(s[i],R.point.y)}break;case 4:r.TR3.transformMesh=!1}t.needsUpdate=!0,TR3.mesh.geometry.computeVertexNormals()}}TR3.pscs.updateGround()},TR3.makeWorld=function(e){"object"==typeof e?TR3.makeObjects(e):-1==e.toUpperCase().indexOf("HTTP://")?TR3.obtainImageFromID(e):TR3.obtainImageFromPath(e)},TR3.obtainImageFromPath=function(e){var t=new Image,o=5;t.onload=function(){TR3.makeObjects(t)},t.onerror=function(){0<=o?(t.src=e,o--):(alert("can not load image correctly"),TR3.loadingDiv.style.display="none")},t.crossOrigin="anonymus",t.src=e},TR3.obtainImageFromID=function(e){e=document.getElementById(e);TR3.makeObjects(e)},TR3.makeScene=function(){var e=2*TR3.fov*Math.PI/360,t=TR3.zone,o=TR3.tPixMesh,o=TR3.rectaValue(2828,1e7,6,3e4,o),o=(TR3.controls.keyPanSpeed=o=o<5e3?5e3:o,TR3.controls.enableKeys=!1,TR3.controls.maxPolarAngle=Math.PI/2.25,TR3.moveKey.walk=!1,TR3.zeroParallax=TR3.cameraPositionFar=Math.cos(e/2)*(t[3]-t[1])/(2*Math.sin(e/2)),TR3.camera.position.set(0,TR3.cameraPositionFar/TR3.cameraDist,0),TR3.getCoordsByXYmod(t[0],t[1],!1,!0)),e=new THREE.DirectionalLight(16777215,1),o=(e.position.set(o[3],TR3.cameraPositionFar/4,o[5]),e.target.position.set(0,0,0),TR3.scene.add(e),TR3.scene.add(e.target),e.target.updateMatrixWorld(),TR3.getCoordsByXYmod(t[2],t[1],!1,!0));(e=new THREE.DirectionalLight(16777215,1)).position.set(o[3],TR3.cameraPositionFar/4,o[5]),e.target.position.set(0,0,0),TR3.scene.add(e),TR3.scene.add(e.target),e.target.updateMatrixWorld(),TR3.mesh.position.set(0,0,0),TR3.centerZone=[+TR3.centerZone[0],TR3.centerZone[1]- -0],TR3.controls.target.set(0,0,0),TR3.camera.near=1,TR3.camera.far=5e6,TR3.camera.fov=TR3.fov,TR3.cursor.helper.scale.set(1,1,1),TR3.renderScene(),TR3.initSky(0,0,0)},TR3.initSky=function(e,t,o){var n=TR3.scene.getObjectByName("Sky"),e=(n.scale.setScalar(13e5),n.position.set(e,t,o),n.rotation.y=Math.PI/2,new THREE.Vector3),t=0,o=.5,a=.005,r=.7,s=.49,i=.25,l=.5;(n=n.material.uniforms).turbidity.value=t,n.rayleigh.value=o,n.mieCoefficient.value=a,n.mieDirectionalG.value=r,t=Math.PI*-(s-.5),o=2*Math.PI*-(i-.5),e.x=Math.cos(o),e.y=Math.sin(o)*Math.sin(t),e.z=Math.sin(o)*Math.cos(t),n.sunPosition.value.copy(e),TR3.renderer.toneMappingExposure=l,TR3.renderer.render(TR3.scene,TR3.camera)},TR3.makeSteve=function(){var e=new THREE.Vector3(1,-1,0).unproject(TR3.camera),t=[.12,.12,1],o=new THREE.Mesh(new THREE.BoxGeometry(t[0],t[1],t[2]),new THREE.MeshBasicMaterial({color:14540253})),t=(o.position.copy(e),TR3.camera.add(o),new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(t[0],t[1],t[2])),new THREE.LineBasicMaterial({color:11184810}))),o=(o.add(t),new THREE.Object3D);o.position.copy(e),TR3.camera.add(o)},TR3.makeObjects=function(e){TR3.widthImg=e.width,TR3.heightImg=e.height;for(var t=TR3.zone,e=new THREE.Texture(e),e=(e.needsUpdate=!0,e.minFilter=THREE.LinearFilter,new THREE.MeshBasicMaterial({map:e})),o=89;TR3.reducMesh=(1-(o+=1)/100)/TR3.reducDTM,TR3.reducMeshW=Math.round(TR3.widthImg*TR3.reducMesh)+1,TR3.reducMeshH=Math.round(TR3.heightImg*TR3.reducMesh)+1,TR3.getSizePix()/TR3.reducMesh<TR3.maxResolMesh;);TR3.tPixImg=TR3.getSizePix(),TR3.tPixMesh=TR3.tPixImg/TR3.reducMesh;var n=new THREE.PlaneGeometry(t[2]-t[0],t[3]-t[1],TR3.reducMeshW-1,TR3.reducMeshH-1);n.rotateX(-Math.PI/2),TR3.mesh=new THREE.Mesh(n,e),TR3.mesh.geometry.dynamic=!0,TR3.mesh.name="mesh3d",TR3.scene.add(TR3.mesh);(n=new THREE.CylinderGeometry((t[2]-t[0])/200,0,(t[2]-t[0])/50,3)).applyMatrix4((new THREE.Matrix4).makeTranslation(0,(t[2]-t[0])/100,0)),TR3.cursor.helper=new THREE.Mesh(n,new THREE.MeshNormalMaterial),TR3.cursor.helper.name="cursor",TR3.cursor.helper.visible=!1,TR3.scene.add(TR3.cursor.helper),TR3.quaternion=new THREE.Quaternion,TR3.makeScene(),TR3.makeZmesh()},TR3.cvsDesty=function(){var e=document.getElementById("canvasDest");return e&&e.remove(),(e=TR3.canvasDest)||((e=document.createElement("CANVAS")).id="canvasDest",TR3.map.insertAdjacentElement("afterbegin",e)),e},TR3.divLoading=function(){var e=document.getElementById("infoGeo3d"),e=(e||((e=document.createElement("div")).id="infoGeo3d",e.style.position="absolute",e.style.fontSize="10px",e.style.margin="25px",e.style.backgroundColor="#fff",e.style.top="10px",e.style.zIndex="999",TR3.map.appendChild(e)),TR3.loadingDiv);e?(e.innerHTML="&nbsp;&nbsp;&nbsp;Loading ...&nbsp;&nbsp;&nbsp;",e.style.display="block"):((e=document.createElement("div")).id="loadingTerrain",e.style.position="absolute",e.style.top="0px",e.style.marginTop=TR3.canvasDestH/2+"px",e.style.marginLeft=TR3.canvasDestW/2.5+"px",e.style.fontSize="15px",e.style.backgroundColor="#bbb",e.style.border="solid",e.innerHTML="&nbsp;&nbsp;&nbsp;Loading ...&nbsp;&nbsp;&nbsp;",TR3.map.appendChild(e)),TR3.loadingDiv=e},TR3.divContainer=function(){"object"!=typeof TR3.map&&(TR3.map=document.getElementById(TR3.map)),TR3.canvasDestW=TR3.map.clientWidth||parseInt(TR3.map.style.width)||document.documentElement.offsetWidth,TR3.canvasDestH=TR3.map.clientHeight||parseInt(TR3.map.style.height)||document.documentElement.offsetHeight},TR3.setImageMesh=function(e){e=new THREE.Texture(e);e.needsUpdate=!0,e.minFilter=THREE.LinearFilter,TR3.mesh.material.map=e},TR3.setMeshZone=function(){0==TR3.newMeshMap&&TR3.widthImg&&(TR3.loadingDiv.style.display="block",TR3.makeScene())},TR3.assignZmesh=function(){for(var e=TR3.arrayZ,t=TR3.reducMeshH,o=TR3.reducMeshW,t=Math.round(t/2)*o+Math.round(o/2),o=(TR3.zMed=e[t],TR3.getCoordsDistance([TR3.zone[0],TR3.centerZone[1]],[TR3.zone[2],TR3.centerZone[1]])),t=Math.abs(TR3.zone[2]-TR3.zone[0]),n=TR3.getCoordsDistance([TR3.zone[0],TR3.zone[1]],[TR3.zone[2],TR3.zone[1]]),a=Math.abs(TR3.zone[0]-TR3.zone[2]),r=TR3.getCoordsDistance([TR3.zone[0],TR3.zone[3]],[TR3.zone[2],TR3.zone[3]]),s=Math.abs(TR3.zone[0]-TR3.zone[2]),i=TR3.getCoordsDistance([TR3.zone[1],TR3.centerZone[0]],[TR3.zone[3],TR3.centerZone[0]]),l=Math.abs(TR3.zone[3]-TR3.zone[1]),c=TR3.getCoordsDistance([TR3.zone[0],TR3.zone[1]],[TR3.zone[0],TR3.zone[3]]),T=Math.abs(TR3.zone[1]-TR3.zone[3]),d=TR3.getCoordsDistance([TR3.zone[2],TR3.zone[1]],[TR3.zone[2],TR3.zone[3]]),R=Math.abs(TR3.zone[1]-TR3.zone[3]),m=(TR3.adjustScale=(t/o+l/i+T/c+R/d+a/n+s/r)/6,TR3.mesh.geometry.getAttribute("position")),p=0;p<e.length;p++)m.setY(p,(e[p]*TR3.adjustScale-TR3.zMed)*TR3.valuesSet.magnification);TR3.renderScene(),m.needsUpdate=!0,TR3.mesh.geometry.computeVertexNormals(),1==TR3.newMeshMap?(TR3.onCompleteMap(),setTimeout(function(){TR3.onCompleteMap()},3e3)):TR3.loadingDiv.style.display="none"},TR3.assignZmeshByIndex=function(e){var t=TR3.arrayZ,o=TR3.mesh.geometry.getAttribute("position");if(e)for(var n=0;n<e.length;n++)o.setY(e[n],(t[e[n]]*TR3.adjustScale-TR3.zMed)*TR3.valuesSet.magnification);else for(n=0;n<t.length;n++)o.setY(n,(t[n]*TR3.adjustScale-TR3.zMed)*TR3.valuesSet.magnification);o.needsUpdate=!0,TR3.mesh.geometry.computeVertexNormals()},TR3.obtainZmeshWCS=function(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM,timeout){!timeout&&TR3.timeoutReq&&TR3.timeoutReq[0]&&clearTimeout(TR3.timeoutReq[0]),TR3.requestDTMwcs&&TR3.requestDTMwcs.abort(),TR3.requestDTMwcs=new XMLHttpRequest;var tPixMesh=TR3.tPixMesh,posName=1e3,posName,posName,posName,posName,c1=(1e3<tPixMesh||(posName=tPixMesh<1e3&&500<=tPixMesh?1e3:tPixMesh<500&&200<=tPixMesh?200:tPixMesh<200&&25<=tPixMesh?25:5),proj4(proj4.defs(TR3.srsImg),proj4.defs("EPSG:4326"),[bboxDTM0,bboxDTM1])),preName="Elevacion25830_";(c1[0]<-13||c1[1]<29.5)&&(preName="Elevacion4083_"),TR3.requestDTMwcs.open("GET","https://servicios.idee.es/wcs-inspire/mdt?SERVICE=WCS&REQUEST=GetCoverage&VERSION=1.0.0&interpolationMethod=bilinear&FORMAT=ArcGrid&CRS="+srsDTM+"&BBOX="+bboxDTM0+","+bboxDTM1+","+bboxDTM2+","+bboxDTM3+"&WIDTH="+widthDTM+"&HEIGHT="+heightDTM+"&COVERAGE="+preName+posName),TR3.requestDTMwcs.onload=function(){var txtDTMwcs=TR3.requestDTMwcs.responseText,str="\n ";if(txtDTMwcs&&-1!=txtDTMwcs.indexOf(str)){var zConteint=txtDTMwcs.slice(txtDTMwcs.indexOf(str)+str.length),sinSalto=zConteint.replace(/\r\n/g," "),sinFin=sinSalto.slice(0,sinSalto.length-1),arrayZ=sinFin.split(" "),lengthDTM=widthDTM*heightDTM,evalZ,zMin=+arrayZ[0],zMax=+arrayZ[0];if(arrayZ.length<100)TR3.errorDTMwcs(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM);else{for(var i=0;i<lengthDTM;i++)TR3.arrayZ[i]=evalZ=eval(arrayZ[i]),(evalZ<-1e3||4e3<evalZ)&&(TR3.arrayZ[i]=0),TR3.arrayZ[i]<zMin&&(zMin=TR3.arrayZ[i]),TR3.arrayZ[i]>zMax&&(zMax=TR3.arrayZ[i]);TR3.zMin=zMin,TR3.zMax=zMax,TR3.assignZmesh()}}else TR3.errorDTMwcs(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM);TR3.requestDTMwcs=!1},TR3.requestDTMwcs.onerror=function(e){TR3.errorDTMwcs(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM)},TR3.requestDTMwcs.send()},TR3.errorDTMwcs=function(e,t,o,n,a,r,s){for(var i=e*t,l=0;l<i;l++)TR3.arrayZ[l]=0;TR3.assignZmesh(),TR3.timeoutReq[1]<3?(TR3.timeoutReq[1]++,TR3.timeoutReq[0]=setTimeout(function(){TR3.obtainZmeshWCS(e,t,o,n,a,r,s,!0)},3e3)):(TR3.timeoutReq[1]=0,clearTimeout(TR3.timeoutReq[0]))},TR3.makeZmesh=function(){var widthDTM=TR3.reducMeshW,heightDTM=TR3.reducMeshH,bboxDTM0=eval(TR3.zone[0])-TR3.tPixMesh/2,bboxDTM1=eval(TR3.zone[1])-TR3.tPixMesh/2,bboxDTM2=eval(TR3.zone[2])+TR3.tPixMesh/2,bboxDTM3=eval(TR3.zone[3])+TR3.tPixMesh/2,srsDTM=TR3.srsImg;TR3.arrayZ=Array(widthDTM*heightDTM).fill(0),TR3.zMin=0,TR3.zMax=0,1==TR3.optionsSet.terrain?(document.getElementById("loadingTerrain").style.display="block",TR3.dtmOri?fetch(TR3.dtmOri).then(e=>e.text()).then(data_mdt=>{var txtDTMwcs=data_mdt,str="\n ",zConteint=txtDTMwcs.slice(txtDTMwcs.indexOf(str)+str.length),sinSalto=zConteint.replace(/\r\n/g," "),sinFin=sinSalto.slice(0,sinSalto.length-1),arrayZ=sinFin.split(" "),lengthDTM=widthDTM*heightDTM,evalZ,zMin=+arrayZ[0],zMax=+arrayZ[0];if(!(arrayZ.length<100)){for(var i=0;i<lengthDTM;i++)TR3.arrayZ[i]=evalZ=eval(arrayZ[i]),(evalZ<-1e3||4e3<evalZ)&&(TR3.arrayZ[i]=0),TR3.arrayZ[i]<zMin&&(zMin=TR3.arrayZ[i]),TR3.arrayZ[i]>zMax&&(zMax=TR3.arrayZ[i]);TR3.zMin=zMin,TR3.zMax=zMax,TR3.assignZmesh()}}):TR3.obtainZmeshWCS(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM)):TR3.assignZmesh()},TR3.setMagniValues=function(e){var t,o,n,a,r,s=TR3.valuesSet.magnification;return isNaN(parseFloat(e))?TR3.tPixMesh?(t=TR3.tPixMesh,o=Math.round(TR3.rectaValue(7e3,11,5,1,t)),n=Math.abs(TR3.zMax-TR3.zMin),(0<(a=Math.abs(TR3.zone[2]-TR3.zone[0]))-(r=Math.abs(TR3.zone[3]-TR3.zone[1]))?a:r)/n<=25&&(o/=4),TR3.valuesSet.magnification=o=15<(o=t<90||o<1?1:o)?15:o):TR3.valuesSet.magnification=1:TR3.valuesSet.magnification=Math.round(e),s!=e&&0==TR3.newMeshMap&&TR3.widthImg&&(TR3.assignZmesh(),TR3.assignZgeometries(),TR3.newDraw=-1),TR3.valuesSet.magnification};