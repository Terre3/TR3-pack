"use strict";var TR3=new Object,THREE=new Object;function isMobile(){var e,t=!1;return e=navigator.userAgent||navigator.vendor||window.opera,t=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))?!0:t}function isTouch(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}}function isIE(){var e=navigator.userAgent.toLowerCase();return-1!=e.indexOf("msie")?parseInt(e.split("msie")[1]):100}function isLandscape(){return window.innerWidth>window.innerHeight}TR3.version="rev:2.121.10",TR3.imgOri=!1,TR3.imgDesty=!1,TR3.lock3d=!1,TR3.config=new Object,"undefined"!=typeof IIIkel?TR3.config=IIIkel.config.TR3:TR3.config={unic:!0,src:!1,flag3d:!0,rotate:!1,lookAt:!1,magni:"auto",spritesDskMvl:1,zoomMapDskMvl:0},TR3.setLoader=function(e,t){TR3.config.src=e=void 0===e?"":e,THREE=t.THREE||THREE,TR3.OrbitControls=t.OrbitControls||OrbitControls||THREE.OrbitControls,TR3.TransformControls=t.TransformControls||TransformControls||THREE.TransformControls,TR3.SkeletonUtilsClone=t.SkeletonUtilsClone||SkeletonUtilsClone||THREE.SkeletonUtilsClone,TR3.GLTFExporter=t.GLTFExporter||GLTFExporter||THREE.GLTFExporter,TR3.GLTFLoader=t.GLTFLoader||GLTFLoader||THREE.GLTFLoader,TR3.IFCLoader=t.IFCLoader||IFCLoader||THREE.IFCLoader,TR3.FontLoader=t.FontLoader||FontLoader||THREE.FontLoader,TR3.TextGeometry=t.TextGeometry||TextGeometry||THREE.TextGeometry,TR3.Sky=t.Sky||Sky||THREE.Sky},TR3.setPanel=function(){return'\t\t\t\t<div id="3doptions" style="border: solid;margin: 5px; padding: 5px; display: none;float:left">\t\t\t\t\t<label id="lblSroOpt" style="font-weight: bold;margin-bottom: 5px;border: solid 2px royalblue;text-align: center;color: royalblue;cursor: pointer">▼ Herramientas 3D ▼</label>\t\t\t\t\t<div id="sroOpt" style="display:none">\t\t\t\t\t\t<div id="magnificationSliderValue">x</div>\t\t\t\t\t\t<input type="button" class="magniStep" style="float:left" value="&nbsp;-&nbsp;"><div id="magnificationSlider" style="float:left;width:95px;margin:4px"></div><input type="button" class="magniStep" style="float:left" value="+">\t\t\t\t\t\t<label style="width:150px;float:left"><input class="changeOpt" id="cursorCheck" type="checkbox"><span id="cursorCheck_spm">▼ 3D Cursor ▼</span></label><br>\t\t\t\t\t\t<div id="cursorCheck_div" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%">\t\t\t\t\t\t\t<input id="newLine" style="float:left;" type="button" value=" Línea " class="">\t\t\t\t\t\t\t<input id="newPolig" style="float:left;" type="button" value=" Polígono " class="">\t\t\t\t\t\t\t<div><input id="metrics" type="checkbox" style="margin:3px 0 3px 3px">Medir</div>\t\t\t\t\t\t\t<input id="calcMetrics" type="button" value="Calcular Métricas"><br>\t\t\t\t\t\t\t<input id="PickDrawStereo" type="text" style="width: 75px;height: 29px"; value="#ff6161">\t\t\t\t\t\t\t<input id="del_vGeom" type="button" value="Borrar Todo" class="">\t\t\t\t\t\t\t\x3c!--<span>Valor de Z: </span><input id="setZ" type="text" style="width: 50px;" value=""><span id="helpSetZ" style="color:royalblue;text-decoration:underline;cursor:pointer">Ayuda</span>--\x3e\t\t\t\t\t\t</div>\t\t\t\t\t\t<label style="width:150px;float:left"><input class="changeOpt" id="anaglyphCheck" type="checkbox"><span id="anaglyphCheck_spm">▼ Stereo 3D ▼</span></label>\t\t\t\t\t\t<div id="anaglyphType" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%">\t\t\t\t\t\t\t<span>&nbsp;-&nbsp;Modo: </span><select id="anaglyph-type" onchange="TR3.changeAnaglyphType()">\t\t\t\t\t\t\t\t<option value="optimiced">Optimizado</option>\t\t\t\t\t\t\t\t<option value="normal">Normal</option>\t\t\t\t\t\t\t\t<option value="half">Intermedio</option>\t\t\t\t\t\t\t\t<option value="gray">Gris</option>\t\t\t\t\t\t\t\t<option value="interlaced">Entrelazado</option>\t\t\t\t\t\t\t</select>\t\t\t\t\t\t\t<a target="_blank" href="'+TR3.config.src+'docStereo.pdf">Gafas 3d</a>\t\t\t\t\t\t</div>\t\t\t\t\t\t<label style="width:150px;float:left"><input class="" id="geomCheck" type="checkbox"><span id="geomCheck_spm">▼ Gemoetrías ▼</span></label>\t\t\t\t\t\t<div id="geomCheck_div" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%">\t\t\t\t\t\t\t<span>&nbsp;-&nbsp;Geometry: </span><select id="geometry-type" onchange="TR3.geometryBySelect()">\t\t\t\t\t\t\t\t<option value="Width,Height,Depth">Box</option>\t\t\t\t\t\t\t\t<option value="RadiusUnique,Segments,ThetaStart,ThetaLength">Circle</option>\t\t\t\t\t\t\t\t<option value="RadiusUnique,Height,Segments,ThetaStart,ThetaLength,OpenEnded">Cone</option>\t\t\t\t\t\t\t\t<option value="RadiusTop,RadiusBottom,Height,Segments,ThetaStart,ThetaLength,OpenEnded">Cylinder</option>\t\t\t\t\t\t\t\t<option value="Width,Height">Plane</option>\t\t\t\t\t\t\t\t<option value="RadiusUnique,Wsegments,Hsegments,ThetaStart,ThetaLength,PhiStart,PhiLength">Sphere</option>\t\t\t\t\t\t\t\t<option value="RadiusUnique,Wsegments,Hsegments">SemiSphere</option>\t\t\t\t\t\t\t</select>\t\t\t\t\t\t\t<div id="geoOpts_div">\t\t\t\t\t\t\t\t<div id="geomDepth_div" style="display: block;">\t\t\t\t\t\t\t\t\t<label>Width: </label>\t\t\t\t\t\t\t\t\t<input id="geomDepth_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomHeight_div" style="display: block;">\t\t\t\t\t\t\t\t\t<label>Height: </label>\t\t\t\t\t\t\t\t\t<input id="geomHeight_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomWidth_div" style="display: block;">\t\t\t\t\t\t\t\t\t<label>Depth: </label>\t\t\t\t\t\t\t\t\t<input id="geomWidth_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomRadiusUnique_div" style="display: none;">\t\t\t\t\t\t\t\t\t<label>Radius: </label>\t\t\t\t\t\t\t\t\t<input id="geomRadiusUnique_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomRadiusTop_div" style="display: none;">\t\t\t\t\t\t\t\t\t<label>RadiusTop: </label>\t\t\t\t\t\t\t\t\t<input id="geomRadiusTop_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomRadiusBottom_div" style="display: none;">\t\t\t\t\t\t\t\t\t<label>RadiusBottom: </label>\t\t\t\t\t\t\t\t\t<input id="geomRadiusBottom_value" type="text" style="width: 65px;">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomSegments_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomSegments_value">Segments: 32</div>\t\t\t\t\t\t\t\t\t<div id="geomSegments_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomWsegments_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomWsegments_value">WidthSegments: 32</div>\t\t\t\t\t\t\t\t\t<div id="geomWsegments_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomHsegments_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomHsegments_value">HeightSegments: 32</div>\t\t\t\t\t\t\t\t\t<div id="geomHsegments_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomPhiStart_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomPhiStart_value">PhiStart: 0</div>\t\t\t\t\t\t\t\t\t<div id="geomPhiStart_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomPhiLength_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomPhiLength_value">PhiLength: 6.283</div>\t\t\t\t\t\t\t\t\t<div id="geomPhiLength_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomThetaStart_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomThetaStart_value">ThetaStart: 0</div>\t\t\t\t\t\t\t\t\t<div id="geomThetaStart_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomThetaLength_div" style="display: none;">\t\t\t\t\t\t\t\t\t<div id="geomThetaLength_value">ThetaLength: 6.283</div>\t\t\t\t\t\t\t\t\t<div id="geomThetaLength_slider" style="margin:4px"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div id="geomOpenEnded_div" style="display: none;">\t\t\t\t\t\t\t\t\t<label>OpenEnded: </label>\t\t\t\t\t\t\t\t\t<input id="geomOpenEnded_value" type="checkbox">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t<input id="newGeom" type="button" value=" Insertar Geometría " style="margin:0px 0px 5px 10px" class=""></br>\t\t\t\t\t\t</div>\t\t\t\t\t\t<label style="width:150px;float:left"><input class="" id="physicsCheck" type="checkbox"><span id="physics_spm">▼ Físicas ▼</span></label>\t\t\t\t\t\t<div id="physicsDiv" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%;height:150px;overflow:auto;">\t\t\t\t\t\t\t<hr><p style="margin:5px"><b>▲ Dispersión ▲</b></p><hr>\t\t\t\t\t\t\t<span>Cobertura: </span><input id="coverZone" type="text" style="width: 65px;" value="5">\t\t\t\t\t\t\t<span>Tamaño: </span><input id="sizePtlZone" type="text" style="width: 65px;" value="1">\t\t\t\t\t\t\t<span>Masa: </span><input id="massPtlZone" type="text" style="width: 65px;" value="150">\t\t\t\t\t\t\t<span>Dirección: </span><input id="dirPtlZone" type="text" style="width: 65px;" value="0,0,0">\t\t\t\t\t\t\t<span>Impulso: </span><input id="impulsePtlZone" type="text" style="width: 65px;" value="15">\t\t\t\t\t\t\t<input id="rainPhy" type="button" value=" Dispersar " style="margin:5px 15px" class="">\t\t\t\t\t\t\t<hr><p style="margin:5px"><b>▲ Puntos de brote ▲</b></p><hr>\t\t\t\t\t\t\t<span>Cantidad: </span><input id="manyPtlEmisor" type="text" style="width: 65px;" value="1">\t\t\t\t\t\t\t<span>Impulso: </span><input id="impulsePtlEmisor" type="text" style="width: 65px;" value="30">\t\t\t\t\t\t\t<span>Tamaño: </span><input id="sizePtlEmisor" type="text" style="width: 65px;" value="1">\t\t\t\t\t\t\t<span>Masa: </span><input id="massPtlEmisor" type="text" style="width: 65px;" value="150">\t\t\t\t\t\t\t<input id="setEmisor" type="button" value="Insertar" style="margin:5px 0px 0px 5px;padding: 0px;" class="">\t\t\t\t\t\t\t<input id="goEmisor" type="button" value="Emitir" style="padding: 0px;" class="">\t\t\t\t\t\t\t<input id="stopGoEmisor" type="button" value="Parar" style="padding: 0px;" class="">\t\t\t\t\t\t\t<input id="removeEmisors" type="button" value="Borrar Todos" style="padding: 0px;" class="">\t\t\t\t\t\t\t<hr><p style="margin:5px"><b>▲ Bola ▲</b></p><hr>\t\t\t\t\t\t\t<span>Impulso: </span><input id="impulsePtlBall" type="text" style="width: 65px;" value="30">\t\t\t\t\t\t\t<span>Tamaño: </span><input id="sizePtlBall" type="text" style="width: 65px;" value="1">\t\t\t\t\t\t\t<span>Masa: </span><input id="massPtlBall" type="text" style="width: 65px;" value="150">\t\t\t\t\t\t\t<input id="goPscBall" type="button" value=" Emitir " style="margin:5px 15px" class="">\t\t\t\t\t\t\t<hr><p style="margin:5px"><b>▲ General ▲</b></p><hr>\t\t\t\t\t\t\t<span>Gravedad: </span><input id="gravityZone" type="text" style="width: 65px;" value="9.8">\t\t\t\t\t\t\t<span>CustomShapes: </span><input id="customShps" type="checkbox"">\t\t\t\t\t\t\t<input id="clearPscsObjs" type="button" value=" Limpiar Partículas " style="margin:5px 0px 0px 10px;" class="">\t\t\t\t\t\t\t<input id="updateGround" type="button" value=" Actualizar Terreno " style="margin-left:10px" class="">\t\t\t\t\t\t\t<input id="updatePscs" type="button" value=" Actualizar Físicas " style="margin-left:10px" class=""><hr>\t\t\t\t\t\t</div>\t\t\t\t\t\t<label style="width:150px;float:left"><input class="" id="textIntoCheck" type="checkbox"><span id="textInto_spm">▼ Texto ▼</span></label>\t\t\t\t\t\t<div id="textIntoDiv" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%;">\t\t\t\t\t\t\t<input id="minicolorText" type="text" style="width: 75%;height: 29px"; value="#ff6161">\t\t\t\t\t\t\t<input id="inputTextInto" type="text" style="width: 100%;" placeholder="Añadir texto">\t\t\t\t\t\t\t<input id="buttonTextInto" type="button" value="Insertar" style="" class="">\t\t\t\t\t\t\t<input id="selectText" type="button" value="Seleccionar" style="" class="">\t\t\t\t\t\t\t<input id="updateText" type="button" value="Actualizar" style="" class="">\t\t\t\t\t\t</div>\t\t\t\t\t\t<label style="width:150px;float:left"><input class="" id="lightIntoCheck" type="checkbox"><span id="lightInto_spm">▼ Punto de Luz ▼</span></label>\t\t\t\t\t\t<div id="lightIntoDiv" style="display:none;border: 1px dashed gray;padding: 1px;float: left;width: 100%;">\t\t\t\t\t\t\t<input id="minicolorLight" type="text" style="width: 75%;height: 29px"; value="#ff6161">\t\t\t\t\t\t\t<span>Intensidad: </span><input id="intensLight" type="text" style="width: 65px;" value="1">\t\t\t\t\t\t\t<span>Distancia: </span><input id="distLight" type="text" style="width: 65px;" value="100">\t\t\t\t\t\t\t<input id="buttonLightInto" type="button" value="Insertar" style="" class="">\t\t\t\t\t\t\t<input id="selectLight" type="button" value="Seleccionar" style="" class="">\t\t\t\t\t\t\t<input id="updateLight" type="button" value="Actualizar" style="" class="">\t\t\t\t\t\t</div>\t\t\t\t\t\t<div style="float:left">\t\t\t\t\t\t\t<input id="file_3d" type="file" accept=".glb,.ifc" style="opacity: 0; position: absolute; width: 100px;">\t\t\t\t\t\t\t<input id="file_3d_fake" style="color: gray; width: 100px;" value=" Explorar GLB/IFC... ">\t\t\t\t\t\t\t<span id="help3dObj" style="color:coral;text-decoration:underline;cursor:pointer"> ¡Ayuda!</span><br>\t\t\t\t\t\t\t<span>&nbsp;- Exportación ⇩ </span><select id="exporter-type" >\t\t\t\t\t\t\t\t<option value="terrain">Terreno</option>\t\t\t\t\t\t\t\t<option value="scene">Todo</option>\t\t\t\t\t\t\t\t<option value="selected">Seleccionado</option>\t\t\t\t\t\t\t</select>\t\t\t\t\t\t\t<input id="exportation" type="button" value="Exportar" onclick="TR3.changeExportType()">\t\t\t\t\t\t\t<label id="size3dObj"></label>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t\t<div id="orbitalMoves" style="text-align: center; box-shadow: rgb(136, 136, 136) 1px 1px 5px; border: medium outset #eee; float: left;">\t\t\t\t\t\t<img id="imgOrbitalMoves" src="'+TR3.config.src+'img/eartharrow.png" draggable="false" style="margin: 5px;cursor:pointer"><br>\t\t\t\t\t\t<input id="makeScene" type="button" value=" Restablecer " style="margin-bottom:5px" class=""><br>\t\t\t\t\t\t<input id="pWalking" type="button" value=" Caminar " style="" class="">\t\t\t\t\t\t<input id="pFlying" type="button" value=" &nbsp;Volar&nbsp; " style="" class="">\t\t\t\t\t\t<input id="orbitPoint" type="button" value=" Orbitar " style="" class="">\t\t\t\t\t\t<div id="exploreDiv" style="display:none">\t\t\t\t\t\t\t<div id="personFlySliderDiv" style="display:none">\t\t\t\t\t\t\t\t<div id="heightSliderValue">Altitud: </div>\t\t\t\t\t\t\t\t<div id="heightSlider" style="margin:5px"></div></div>\t\t\t\t\t\t\t<input id="lessV" type="button" value="- Velocidad"><input id="moreV" type="button" value="+ Velocidad">\t\t\t\t\t\t\t<label style="font-weight: bold; margin: 5px;color: brown;">Camina y Vuela con las flechas de teclado</label>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div style="text-align: left; margin: 5px">\t\t\t\t\t\t\t<input id="autoRotate" type="checkbox" class="changeOpt"> Rotación \t\t\t\t\t\t\t<input id="malla" type="checkbox" class="changeOpt"> Malla<br>\t\t\t\t\t\t\t<input id="tentative" type="checkbox" class="changeOpt" checked> Tentativo\t\t\t\t\t\t\t<input id="terrain" type="checkbox" class="changeOpt"> Terreno\t\t\t\t\t\t</div>\t\t\t\t\t</div>'+'<div id="advices"></div></div><img id="imgErrTR3evt" src onerror="TR3.setEvtPanel()">'},TR3.setEvtPanel=function(){$("#magnificationSlider").slider({min:1,max:15,slide:function(e,t){var o=TR3.formatMeasure(TR3.tPixMesh);$("#magnificationSliderValue").html("<b>x"+t.value+"</b> (malla: "+o[0]+o[1]+")"),TR3.setMagniValues(t.value)}}),$("#geomSegments_slider").slider({min:0,max:64,value:32,slide:function(e,t){$("#geomSegments_value").html("Segments: "+t.value)}}),$("#geomWsegments_slider").slider({min:0,max:64,value:32,slide:function(e,t){$("#geomWsegments_value").html("WidthSegments: "+t.value)}}),$("#geomHsegments_slider").slider({min:0,max:64,value:32,slide:function(e,t){$("#geomHsegments_value").html("HeightSegments: "+t.value)}}),$("#geomPhiStart_slider").slider({min:0,max:2*Math.PI,step:.001,value:0,slide:function(e,t){$("#geomPhiStart_value").html("PhiStart: "+t.value)}}),$("#geomPhiLength_slider").slider({min:0,max:2*Math.PI,step:.001,value:2*Math.PI,slide:function(e,t){$("#geomPhiLength_value").html("PhiLength: "+t.value)}}),$("#geomThetaStart_slider").slider({min:0,max:2*Math.PI,step:.001,value:0,slide:function(e,t){$("#geomThetaStart_value").html("ThetaStart: "+t.value)}}),$("#geomThetaLength_slider").slider({min:0,max:2*Math.PI,step:.001,value:2*Math.PI,slide:function(e,t){$("#geomThetaLength_value").html("ThetaLength: "+t.value)}}),$("#heightSlider").slider({min:0,max:1e3,slide:function(e,t){$("#heightSlider").slider("option","max",Math.round((TR3.zMax-TR3.zMed)*TR3.valuesSet.magnification)),$("#heightSlider").slider("option","min",Math.round((TR3.zMin-TR3.zMed)*TR3.valuesSet.magnification)),TR3.changeHeight(t.value,!0,!1),$("#heightSliderValue").html("Altitud: "+Math.round(t.value/TR3.valuesSet.magnification+TR3.zMed)+" m")}}),document.getElementById("lightIntoCheck").addEventListener("click",function(){var e=document.getElementById("lightInto_spm").innerHTML;this.checked?(document.getElementById("lightIntoDiv").style.display="block",document.getElementById("lightInto_spm").innerHTML=e.replaceAll("▼","▲")):(document.getElementById("lightIntoDiv").style.display="none",document.getElementById("lightInto_spm").innerHTML=e.replaceAll("▲","▼"))}),document.getElementById("textIntoCheck").addEventListener("click",function(){var e=document.getElementById("textInto_spm").innerHTML;this.checked?(document.getElementById("textIntoDiv").style.display="block",document.getElementById("textInto_spm").innerHTML=e.replaceAll("▼","▲")):(document.getElementById("textIntoDiv").style.display="none",document.getElementById("textInto_spm").innerHTML=e.replaceAll("▲","▼"))}),document.getElementById("anaglyphCheck").addEventListener("click",function(){var e=document.getElementById("anaglyphCheck_spm").innerHTML;this.checked?(document.getElementById("anaglyphType").style.display="block",document.getElementById("anaglyphCheck_spm").innerHTML=e.replaceAll("▼","▲")):(document.getElementById("anaglyphType").style.display="none",document.getElementById("anaglyphCheck_spm").innerHTML=e.replaceAll("▲","▼"))}),document.getElementById("physicsCheck").addEventListener("click",function(){var e=document.getElementById("physics_spm").innerHTML;this.checked?(document.getElementById("physicsDiv").style.display="block",document.getElementById("physics_spm").innerHTML=e.replaceAll("▼","▲")):(document.getElementById("physicsDiv").style.display="none",document.getElementById("physics_spm").innerHTML=e.replaceAll("▲","▼"),TR3.pscs.emiter=!1)}),document.getElementById("cursorCheck").addEventListener("click",function(){var e=document.getElementById("cursorCheck_spm").innerHTML;this.checked?(document.getElementById("cursorCheck_div").style.display="block",document.getElementById("cursorCheck_spm").innerHTML=e.replaceAll("▼","▲"),TR3.lock3d("cursor3d")):(document.getElementById("cursorCheck_div").style.display="none",document.getElementById("cursorCheck_spm").innerHTML=e.replaceAll("▲","▼"),document.getElementById("metrics").checked=!1,TR3.vGeom.measure=!1,TR3.endDraw(),TR3.unlock3d("cursor3d"))},!1),document.getElementById("geomCheck").addEventListener("click",function(){var e=document.getElementById("geomCheck_spm").innerHTML,t=2*TR3.tPixMesh;document.getElementById("geomWidth_value").value=t,document.getElementById("geomHeight_value").value=t,document.getElementById("geomDepth_value").value=t,document.getElementById("geomRadiusUnique_value").value=t,document.getElementById("geomRadiusTop_value").value=t,document.getElementById("geomRadiusBottom_value").value=t,this.checked?(document.getElementById("geomCheck_div").style.display="block",document.getElementById("geomCheck_spm").innerHTML=e.replaceAll("▼","▲"),TR3.lock3d("cursor3d")):(document.getElementById("geomCheck_div").style.display="none",document.getElementById("geomCheck_spm").innerHTML=e.replaceAll("▲","▼"))},!1),document.getElementById("lblSroOpt").addEventListener("click",function(){var e=document.getElementById("sroOpt").style.display,t=document.getElementById("lblSroOpt"),o=t.innerHTML;"none"==e?(document.getElementById("sroOpt").style.display="block",t.innerHTML=o.replaceAll("▼","▲")):(document.getElementById("sroOpt").style.display="none",t.innerHTML=o.replaceAll("▲","▼"))},!1);for(var e={animationSpeed:50,animationEasing:"swing",change:null,changeDelay:0,control:"hue",defaultValue:"",format:"rgb",showSpeed:100,hideSpeed:100,inline:!1,keywords:"",letterCase:"lowercase",opacity:!1,position:"bottom left",theme:"default TR3PickColor",swatches:[]},t=($("#PickDrawStereo").minicolors(e),$("#minicolorText").minicolors(e),$("#minicolorLight").minicolors(e),document.getElementsByClassName("changeOpt")),o=0;o<t.length;o++)t[o].addEventListener("click",TR3.setOpts,!1);document.getElementById("buttonLightInto").addEventListener("click",function(){TR3.vGeom.newLight=!0,TR3.canvasDest.style.cursor="crosshair"},!1),document.getElementById("buttonTextInto").addEventListener("click",function(){TR3.vGeom.newText=!0,TR3.canvasDest.style.cursor="crosshair"},!1),document.getElementById("newGeom").addEventListener("click",function(){TR3.setOpts({cursor3d:!1}),TR3.newGeom=!0,TR3.canvasDest.style.cursor="crosshair"},!1),document.getElementById("stopGoEmisor").addEventListener("click",function(){TR3.pscs.emiter=!1,TR3.canvasDest.style.cursor="default"},!1),document.getElementById("terrain").addEventListener("click",function(){TR3.makeZmesh()},!1),document.getElementById("goPscBall").addEventListener("click",function(){var e=[];e.keyCode="66",TR3.camera.visible=!0,TR3.keyDown(e)},!1),document.getElementById("rainPhy").addEventListener("click",function(){TR3.pscs.rainPhy()},!1),document.getElementById("setEmisor").addEventListener("click",function(){TR3.canvasDest.style.cursor="crosshair",TR3.pscs.emiter=!0},!1),document.getElementById("goEmisor").addEventListener("click",function(){TR3.pscs.emiter=!1,TR3.pscs.goEmisor()},!1),document.getElementById("removeEmisors").addEventListener("click",function(){TR3.pscs.emiter=!1,TR3.pscs.removeEmisors()},!1),document.getElementById("updateGround").addEventListener("click",function(){TR3.pscs.setGround()},!1),document.getElementById("updatePscs").addEventListener("click",function(){TR3.pscs.getPscsValues()},!1),document.getElementById("clearPscsObjs").addEventListener("click",function(){TR3.pscs.clearPscsObjs()},!1),document.getElementById("makeScene").addEventListener("click",function(){TR3.lightBtn(this.id),TR3.setValuesSliderMagn("auto"),TR3.moving=!1,TR3.initPosCamera(!0),TR3.cursor.helper.scale.set(1,1,1),document.getElementById("exploreDiv").style.display="none",document.getElementById("personFlySliderDiv").style.display="none",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("orbitPoint").addEventListener("click",function(){TR3.lightBtn(this.id),TR3.moving=!1,TR3.orbitalViewFn(),document.getElementById("exploreDiv").style.display="none",document.getElementById("personFlySliderDiv").style.display="none",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("pWalking").addEventListener("click",function(){TR3.lightBtn(this.id),this.blur(),TR3.moveKey.walkClicked=!0,TR3.canvasDest.style.cursor="crosshair",(TR3.optionsSet.imgControl?document.getElementById("imgOrbitalMoves"):document.getElementById("canvasDest")).focus(),document.getElementById("exploreDiv").style.display="block",document.getElementById("personFlySliderDiv").style.display="none",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("pFlying").addEventListener("click",function(){TR3.lightBtn(this.id),TR3.moving=!0;var e=(TR3.zMax-TR3.zMin)/2*TR3.valuesSet.magnification;TR3.personViewFn(e),TR3.setValuesSliderHeight(e),TR3.moveKey.walk=!1,(TR3.optionsSet.imgControl?document.getElementById("imgOrbitalMoves"):document.getElementById("canvasDest")).focus(),document.getElementById("exploreDiv").style.display="block",document.getElementById("personFlySliderDiv").style.display="block",TR3.setOpts({autoRotate:!1})},!1),document.getElementById("metrics").addEventListener("click",function(){document.getElementById("metrics").checked?TR3.vGeom.measure=!0:TR3.vGeom.measure=!1},!1);for(var a=document.getElementById("imgOrbitalMoves"),n=(a.addEventListener("mouseover",function(){a.src=TR3.config.src+"img/eartharrow_over.png"},!1),a.addEventListener("mouseout",function(){a.src=TR3.config.src+"img/eartharrow.png"},!1),document.getElementById("moreV").addEventListener("click",function(){(TR3.optionsSet.imgControl?a:TR3.canvasDest).focus(),TR3.controls.keyPanSpeed=3*TR3.controls.keyPanSpeed},!1),document.getElementById("lessV").addEventListener("click",function(){(TR3.optionsSet.imgControl?a:TR3.canvasDest).focus(),TR3.controls.keyPanSpeed=TR3.controls.keyPanSpeed/3},!1),document.getElementById("newLine").addEventListener("click",function(){TR3.vGeom.polig=!1,TR3.newVgeom()},!1),document.getElementById("newPolig").addEventListener("click",function(){TR3.vGeom.polig=!0,TR3.newVgeom()},!1),document.getElementById("calcMetrics").addEventListener("click",function(){TR3.updateVgeom()},!1),document.getElementById("del_vGeom").addEventListener("click",function(){TR3.del_vGeom(!1,"item"),TR3.del_vGeom(!1,"sprites"),document.getElementById("metrics").checked=!1},!1),document.getElementById("selectText").addEventListener("click",function(){var e=TR3.vGeom.sprites.length,e=Math.floor(Math.random()*e)+0;TR3.transCtrlsEnabled(TR3.vGeom.sprites[e])},!1),document.getElementById("updateText").addEventListener("click",function(){var e,t=TR3.transformControls.object;t&&(e=t.position,TR3.del3dObj(t,TR3.vGeom.sprites),t=document.getElementById("inputTextInto").value,(t=TR3.formatedText(t||"hey!",$("#minicolorText").val(),e)).position.set(e.x,e.y,e.z),TR3.scene.add(t),TR3.transCtrlsEnabled(t),TR3.onCreateItem(t))},!1),document.getElementById("selectLight").addEventListener("click",function(){var e=TR3.vGeom.lights.length,e=Math.floor(Math.random()*e)+0;0<TR3.vGeom.lights.length&&TR3.transCtrlsEnabled(TR3.vGeom.lights[e][0])},!1),document.getElementById("updateLight").addEventListener("click",function(){var e,t,o,a=TR3.transformControls.object;a&&(e=a.position,TR3.del3dObj(a,TR3.vGeom.lights),a=$("#minicolorLight").val()||"#ffffff",t=document.getElementById("intensLight").value||1,o=document.getElementById("distLight").value||100,(a=TR3.setLight(a,t,o))[0].position.set(e.x,e.y,e.z),TR3.scene.add(a[0]),TR3.scene.add(a[1]),TR3.transCtrlsEnabled(a[0]),TR3.onCreateItem(a[0]))},!1),document.getElementById("file_3d").addEventListener("change",function(e){TR3.handleFileSelect(e)},!1),$("#advices").dialog({position:{my:"left center",at:"left center",of:window},title:"Información",autoOpen:!1,width:400}),document.getElementById("help3dObj").addEventListener("click",function(){document.getElementById("advices").innerHTML='<div id="infohelp3dObj" style="padding:10px 40px;height: 500px;">\t\t\t\t\t\t<div align="center"><u>Operaciones y Transformaciones:</u></div><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(87)" value="W"> Trasladar | <input type="button" onclick="TR3.UpdateKeys3D(69)" value="E"> Rotar | <input type="button" onclick="TR3.UpdateKeys3D(82)" value="R"> Escalar <I>·manejar objeto·</I><br />\t\t\t\t\t\t<br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(107)" value="+"> Aumentar | <input type="button" onclick="TR3.UpdateKeys3D(109)" value="-"> Disminuir <I>·ejes·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(27)" value="Esc"> Desactiva herramienta<br />\t\t\t\t\t\t<br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(46)" value="Supr"> Elimina <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(32)" value="Space"> Deselecciona <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(76)" value="L"> Información geométrica del <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(71)" value="G"> Ver geometría de Malla <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(70)" value="F"> Influir sobre el terreno con el <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(88)" value="X"> El <I>·objeto·</I> es referencia en métricas de volumen<br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(86)" value="V"> Visibilidad <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(84)" value="T"> Transparencia <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(79)" value="O"> Baja al suelo el <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(65)" value="A"> Clona <I>·objeto·</I> <br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(67)" value="C"> Recorta <I>·objeto·</I> + Rueda ratón <br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(73)" value="I"> Impulsar <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(77)" value="M"> Dotar de masa <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(90)" value="Z"> Animar <I>·objeto·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(83)" value="S"> Cambiar textura <I>·geometría·</I><br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(75)" value="K"> Genera un prisma recto a partir de un  <I>·polígono·</I><br />\t\t\t\t\t\t<br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(85)" value="U"> Sube en primera persona <br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(68)" value="D"> Baja en primera persona <br />\t\t\t\t\t\t<input type="button" onclick="TR3.UpdateKeys3D(80)" value="P"> Target de movimientos en cursor <br />\t\t\t\t\t</div>',$("#advices").dialog({height:590}),$("#advices").dialog("open")},!1),document.getElementsByClassName("magniStep")),r=$("#magnificationSlider").slider("option","min"),s=$("#magnificationSlider").slider("option","max"),o=0;o<n.length;o++)n[o].addEventListener("click",function(e){var e=e.target.value,t=TR3.valuesSet.magnification;-1!=e.indexOf("+")?TR3.setValuesSliderMagn(t=s<(t+=1)?s:t):TR3.setValuesSliderMagn(t=(t-=1)<r?r:t)})},TR3.lightBtn=function(e){for(var t=document.getElementsByClassName("btnDrawOn"),o=0;o<t.length;o++)t[o].style.border="",t[o].className="";"makeScene"==e&&(e="orbitPoint"),document.getElementById(e).className="btnDrawOn",document.getElementById(e).style.border="solid 2px"},TR3.setStart=function(e){TR3.params=e,TR3.dfd_setMap=$.Deferred();var t=!!(e=void 0===e?{}:e).hasOwnProperty("oriImg")&&e.oriImg,o=!!e.hasOwnProperty("oriDTM")&&e.oriDTM,a=(TR3.map=!!e.hasOwnProperty("desty")&&e.desty,!!e.hasOwnProperty("bbox")&&e.bbox),e=(TR3.srsImg=e.hasOwnProperty("projCode")?e.projCode:"EPSG:3857",TR3.LyrFeatFromOri=!!e.hasOwnProperty("LyrFeat")&&e.LyrFeat,TR3.cameraDist=e.hasOwnProperty("cameraDist")?e.cameraDist:1,"object"==typeof t||(t=document.getElementById(t))||alert("invalid Origin"),"object"!=typeof TR3.map&&(TR3.map=document.getElementById(TR3.map),TR3.map||alert("invalid Destiny")),TR3.getOptions()),n=TR3.getValues();return TR3.setValues(n),TR3.setMeshMap(t,o,a,e,{magnification:n.magnification,lookAt:TR3.config.lookAt}),TR3.config.lookAt=!1,TR3.setValuesSliderMagn(n),TR3.config.magni="auto",TR3.vGeom.measure=!1,TR3.startAnimation(),document.getElementById("metrics").checked=!1,document.getElementById("exploreDiv").style.display="none",document.getElementById("personFlySliderDiv").style.display="none",TR3.dfd_setMap.promise()},TR3.getOptions=function(){var e="none"!=document.getElementById("imgOrbitalMoves").style.display,t=!!document.getElementById("cursorCheck")&&document.getElementById("cursorCheck").checked,o=!!document.getElementById("anaglyphCheck")&&document.getElementById("anaglyphCheck").checked,a=!!document.getElementById("autoRotate")&&document.getElementById("autoRotate").checked;return{imgControl:e,cursor3d:t,anaglyph:o,autoRotate:a=1==TR3.config.rotate?!(TR3.config.rotate=0):a,wireframeMesh:!!document.getElementById("malla")&&document.getElementById("malla").checked,tentative:!!document.getElementById("tentative")&&document.getElementById("tentative").checked,terrain:!!document.getElementById("terrain")&&document.getElementById("terrain").checked}},TR3.setOpts=function(e){var t=TR3.getOptions();e&&(null!=e.imgControl&&(t.imgControl=e.imgControl),null!=e.cursor3d&&(t.cursor3d=e.cursor3d),null!=e.anaglyph&&(t.anaglyph=e.anaglyph),null!=e.autoRotate&&(t.autoRotate=e.autoRotate),null!=e.wireframeMesh&&(t.wireframeMesh=e.wireframeMesh),null!=e.tentative&&(t.tentative=e.tentative),null!=e.terrain)&&(t.terrain=e.terrain),TR3.setOptions(t.imgControl,t.cursor3d,t.anaglyph,t.autoRotate,t.wireframeMesh,t.tentative,t.terrain)},TR3.setOptions=function(e,t,o,a,n,r,s){var i,l;document.getElementById("imgOrbitalMoves").style.display=1==e?"inline":"none",document.getElementById("cursorCheck").checked=1==t,document.getElementById("malla").checked=1==n,document.getElementById("autoRotate").checked=1==a,document.getElementById("anaglyphCheck").checked=1==o,document.getElementById("tentative").checked=1==r,document.getElementById("terrain").checked=1==s,TR3.canvasDest&&(i=document.getElementById("infoGeo3d"),l=document.getElementById("cursorCheck_div"),s!==TR3.optionsSet.terrain&&TR3.setStart(TR3.params),t!==TR3.optionsSet.cursor3d&&(1==t?(l.style.display="block",i.style.display="block",TR3.canvasDest.style.cursor="none",TR3.cursor.helper.visible=!0,TR3.controls.enableZoom=!1):(l.style.display="none",(i.style.display="none")===TR3.canvasDest.style.cursor&&(TR3.canvasDest.style.cursor="default"),TR3.cursor.helper.visible=!1,TR3.controls.enableZoom=!0)),n!==TR3.optionsSet.wireframeMesh&&(TR3.mesh.material.wireframe=1==n),a!==TR3.optionsSet.autoRotate&&(TR3.controls.autoRotate=1==a),o!==TR3.optionsSet.anaglyph&&1==o&&(l=TR3.getRayCaster(!1),0<(i=TR3.getIntersect(l,[TR3.mesh])).length)&&i[0][0]&&i[0][0].point&&(l=TR3.camera.position,TR3.zeroParallax=l.distanceTo(i[0][0].point)),TR3.optionsSet={imgControl:e,cursor3d:t,anaglyph:o,autoRotate:a,wireframeMesh:n,tentative:r,terrain:s}),TR3.optionsSet.terrain=s},TR3.setValues=function(values){var magni,magnific;values.magnification&&(magni=values.magnification,magnific="auto","number"!=typeof Number(magni)||isNaN(magni)||(magnific=eval(magni)),TR3.config.magni=magnific,TR3.setValuesSliderMagn(magnific)),values.reducDTM&&(TR3.reducDTM=values.reducDTM)},TR3.getValues=function(){var e=new Object;return e.magnification=TR3.config.magni,e},TR3.changeAnaglyphType=function(){TR3.anaglyphType=document.getElementById("anaglyph-type").value,TR3.anaglyphRenderer.updateAnaglyphType(TR3.scene,TR3.camera)},TR3.changeExportType=function(){var e=document.getElementById("exporter-type").value;"null"!=e&&TR3.exportGLTF(e)},TR3.setValuesSliderMagn=function(e){e&&0<e&&e<51?TR3.setMagniValues(e):e="auto"==e?TR3.setMagniValues():TR3.valuesSet.magnification,$("#magnificationSlider").slider("value",e);var t=TR3.formatMeasure(TR3.tPixMesh);$("#magnificationSliderValue").html("<b>x"+e+"</b> (malla: "+t[0]+" "+t[1]+")")},TR3.setValuesSliderHeight=function(e){$("#heightSlider").slider("value",e),$("#heightSlider").slider("option","max",Math.round((TR3.zMax-TR3.zMed)*TR3.valuesSet.magnification)),$("#heightSlider").slider("option","min",Math.round((TR3.zMin-TR3.zMed)*TR3.valuesSet.magnification)),$("#heightSliderValue").html("Altitud: "+Math.round(e/TR3.valuesSet.magnification+TR3.zMed)+" m")},TR3.geometryBySelect=function(){for(var e=$("#geometry-type")[0].value.split(","),t=$("#geoOpts_div")[0].children,o=0;o<t.length;o++){t[o].style.display="none";for(var a=0;a<e.length;a++)-1!=t[o].id.indexOf(e[a])&&(t[o].style.display="block")}},TR3.setGeomBySelect=function(){for(var e,t=$("#geometry-type")[0],o=new Object,a=0;a<t.length;a++)!0===t[a].selected&&(e=t[a].innerHTML);for(var n=$("#geoOpts_div")[0].children,a=0;a<n.length;a++){var r,s=n[a].children;0<s.length&&("DIV"===n[a].tagName&&s[1].value?o[(r=s[0].innerHTML.replaceAll(":","").replaceAll(" ","")).charAt(0).toLowerCase()+r.slice(1)]=+s[1].value:o[(r=s[0].innerHTML.split(":"))[0].charAt(0).toLowerCase()+r[0].slice(1)]=+r[1])}o.geometry=e,o.openEnded=$("#geomOpenEnded_value")[0].checked;var i=TR3.setGeometry(o,"",{transform:!0,slctItem:!0}),l=(o.height||(o.height=0),i.position.set(TR3.cursor.coordClick.x,TR3.cursor.coordClick.y+o.height/2*TR3.adjustMapScale,TR3.cursor.coordClick.z),i.scale.set(TR3.adjustMapScale,TR3.adjustMapScale,TR3.adjustMapScale),TR3.getSizeObj(i));document.getElementById("size3dObj").innerHTML="<b>X:</b>"+(l[0][0]/TR3.adjustMapScale).toFixed(2)+l[0][1]+" <b>Y:</b>"+(l[2][0]/TR3.adjustMapScale).toFixed(2)+l[2][1]+" <b>Z:</b>"+(l[1][0]/TR3.adjustMapScale).toFixed(2)+l[1][1],TR3.scene.add(i)};var Detector={isMobile:isMobile(),isTablet:!isMobile()&&isTouch(),isTouch:isTouch(),isIE:isIE(),isLandscape:isLandscape(),canvas:!!window.CanvasRenderingContext2D,webgl:function(){if(-1!=window.navigator.userAgent.indexOf("Windows NT 5")||isIE()<10)return!1;try{var e=document.createElement("canvas");return!!window.WebGLRenderingContext&&(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=(window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.']:['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.']).join("\n")),e},addGetWebGLMessage:function(e){var t,o=void 0!==(e=e||{}).parent?e.parent:document.body,e=void 0!==e.id?e.id:"oldie";(t=Detector.getWebGLErrorMessage()).id=e,o.appendChild(t)}},wmsMap=new Object,Datum_axis=(wmsMap.transCoord=function(){},{ED50:[6378388,6356911.946],WGS84:[6378137,6356752.314],ETRS89:[6378137,6356752.314],WGS72:[6378135,6356750.52],OSGB36:[6377563.396,6356256.909]}),datToDat={ETRS89toED50Pen:{tx:131.032,ty:100.251,tz:163.354,s:-939e-8,rx:-3455e-7,ry:-54166e-10,rz:-.0003176666},ED50toETRS89Pen:{tx:-131.032,ty:-100.251,tz:-163.354,s:939e-8,rx:3455e-7,ry:54166e-10,rz:.0003176666},ETRS89toED50Bal:{tx:181.4609,ty:90.2931,tz:187.1902,s:-1757e-8,rx:39861e-9,ry:136722e-9,rz:-109306e-9},ED50toETRS89Bal:{tx:-181.4609,ty:-90.2931,tz:-187.1902,s:1757e-8,rx:-39861e-9,ry:-136722e-9,rz:109306e-9},ETRS89toED50NWP:{tx:178.383,ty:83.172,tz:221.293,s:-212e-7,rx:150028e-9,ry:-14775e-8,rz:-35083e-9},ED50toETRS89NWP:{tx:-178.383,ty:-83.172,tz:-221.293,s:212e-7,rx:-150028e-9,ry:14775e-8,rz:35083e-9},WGS84toED50:{tx:89.5,ty:93.8,tz:123.1,s:-12e-7,rx:0,ry:0,rz:-433e-7},ED50toWGS84:{tx:-89.5,ty:-93.8,tz:-123.1,s:12e-7,rx:0,ry:0,rz:433e-7},OSGB36toWGS84:{tx:446.448,ty:-124.157,tz:542.06,s:-204894e-10,rx:4172222e-11,ry:6861111e-11,rz:.00023391666}};function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function spaces(e){for(var t=" ",o=0;o<e-1;o++)t+=" ";return t}wmsMap.transCoord.getElipsoide=function(e){var t=Datum_axis[e][0],e=Datum_axis[e][1];return{a:t,b:e,e2:(t*t-e*e)/(t*t)}},wmsMap.transCoord.srsChange=function(e,t,o,a){var n,r,s,o=this.getDatum(o),a=this.getDatum(a);return o.datum==a.datum?o.huso==a.huso?{c1:e,c2:t}:""==o.huso?{c1:(n=this.geoToUTM(e,t,o.datum,a.huso)).x,c2:n.y}:""==a.huso?{c1:(n=this.utmToGeo(e,t,o.datum,o.huso)).lon,c2:n.lat}:(s=this.utmToGeo(e,t,o.datum,o.huso),{c1:(n=this.geoToUTM(s.lon,s.lat,o.datum,a.huso)).x,c2:n.y}):""==o.huso&&""==a.huso?{c1:(n=this.changeDatum(e,t,o.datum,a.datum)).lon,c2:n.lat}:""==o.huso&&""!=a.huso?(n=this.changeDatum(e,t,o.datum,a.datum),{c1:(r=this.geoToUTM(n.lon,n.lat,a.datum,a.huso)).x,c2:r.y}):""!=o.huso&&""==a.huso?(n=this.utmToGeo(e,t,o.datum,o.huso),{c1:(r=this.changeDatum(n.lon,n.lat,o.datum,a.datum)).lon,c2:r.lat}):(n=this.utmToGeo(e,t,o.datum,o.huso),r=this.changeDatum(n.lon,n.lat,o.datum,a.datum),{c1:(s=this.geoToUTM(r.lon,r.lat,a.datum,a.huso)).x,c2:s.y})},wmsMap.transCoord.getDatum=function(e){var t,o,a=e.length,n="",r="";return 10==a?(t="UTM",326==(o=e.slice(5,8))?n="WGS84":230==o?n="ED50":258==o&&(n="ETRS89"),r=e.slice(-2)):9==a&&(t="Lon-Lat",4326==(o=e.slice(5,9))?n="WGS84":4230==o?n="ED50":4258==o&&(n="ETRS89")),{datum:n,huso:r,proy:t}},wmsMap.transCoord.getEPSG=function(e,t,o){var a,n;return"UTM"==e?a="":"Lon-Lat"==e&&(a="4",o=""),"ETRS89"==t?n="258":"ED50"==t?n="230":"WGS84"==t&&(n="326"),{EPSG:"EPSG:"+a+n+o}},wmsMap.transCoord.isGeo=function(e){return"Lon-Lat"==wmsMap.transCoord.getDatum(e).proy},wmsMap.transCoord.isUTM=function(e){return"UTM"==wmsMap.transCoord.getDatum(e).proy},wmsMap.transCoord.geoToUTM=function(e,t,o,a){var o=this.getElipsoide(o),n=o.a,o=o.e2,r=t*(Math.PI/180),s=e*(Math.PI/180);a=a||Math.floor((e+180)/6)+1,56<=t&&t<64&&3<=e&&e<12&&(a=32),72<=t&&t<84&&(0<=e&&e<9?a=31:9<=e&&e<21?a=33:21<=e&&e<33?a=35:33<=e&&e<42&&(a=37));var e=(6*(a-1)-180+3)*(Math.PI/180),a=(ePrimeSquared=o/(1-o),n/Math.sqrt(1-o*Math.sin(r)*Math.sin(r))),i=Math.tan(r)*Math.tan(r),l=ePrimeSquared*Math.cos(r)*Math.cos(r),s=Math.cos(r)*(s-e),e=n*((1-o/4-3*o*o/64-5*o*o*o/256)*r-(3*o/8+3*o*o/32+45*o*o*o/1024)*Math.sin(2*r)+(15*o*o/256+45*o*o*o/1024)*Math.sin(4*r)-35*o*o*o/3072*Math.sin(6*r)),n=.9996*a*(s+(1-i+l)*Math.pow(s,3)/6+(5-18*i+i*i+72*l-58*ePrimeSquared)*Math.pow(s,5)/120)+5e5,o=.9996*(e+a*Math.tan(r)*(s*s/2+(5-i+9*l+4*l*l)*Math.pow(s,4)/24+(61-58*i+i*i+600*l-330*ePrimeSquared)*Math.pow(s,6)/720));return t<0&&(o+=1e7),{x:n,y:o}},wmsMap.transCoord.utmToGeo=function(e,t,o,a){var o=this.getElipsoide(o),n=o.a,o=o.e2,r=o/(1-o),s=(1-Math.sqrt(1-o))/(1+Math.sqrt(1-o)),e=e-5e5,a=6*(a-1)-180+3,t=(t=t)/.9996/(n*(1-o/4-3*o*o/64-5*Math.pow(o,3)/256)),s=t+(3*s/2-27*Math.pow(s,3)/32)*Math.sin(2*t)+(21*s*s/16-55*Math.pow(s,4)/32)*Math.sin(4*t)+151*Math.pow(s,3)/96*Math.sin(6*t),t=n/Math.sqrt(1-o*Math.sin(s)*Math.sin(s)),i=Math.tan(s)*Math.tan(s),l=r*Math.cos(s)*Math.cos(s),n=n*(1-o)/Math.pow(1-o*Math.sin(s)*Math.sin(s),1.5),o=e/(.9996*t),e=(s-t*Math.tan(s)/n*(o*o/2-(5+3*i+10*l-4*l*l-9*r)*Math.pow(o,4)/24+(61+90*i+298*l+45*i*i-252*r-3*l*l)*Math.pow(o,6)/720))*(180/Math.PI);return{lon:a+(o-(1+2*i+l)*Math.pow(o,3)/6+(5-2*l+28*i-3*l*l+8*r+24*i*i)*Math.pow(o,5)/120)/Math.cos(s)*(180/Math.PI),lat:e}},wmsMap.transCoord.GeoToGeocentric=function(e,t,o){var o=this.getElipsoide(o),a=o.a,o=(o.b,o.e2),t=wmsMap.oper.degToRad(t),e=wmsMap.oper.degToRad(e),a=a/Math.sqrt(1-o*wmsMap.oper.sin2(t));return{x:(0+a)*Math.cos(t)*Math.cos(e),y:(0+a)*Math.cos(t)*Math.sin(e),z:((1-o)*a+0)*Math.sin(t)}},wmsMap.transCoord.GeocentricToGeo=function(e,t,o,n){elipsoide=this.getElipsoide(n),a=elipsoide.a,b=elipsoide.b,excen=elipsoide.e2;for(var n=wmsMap.oper.radToDeg(Math.atan(t/e)),r=Math.sqrt(e*e+t*t),s=Math.atan(o/(r*(1-excen))),i=1;i<10;i++)v=a/Math.sqrt(1-excen*wmsMap.oper.sin2(s)),s=phiN1=Math.atan((o+excen*v*Math.sin(s))/r);return{lon:n,lat:wmsMap.oper.radToDeg(s)}},wmsMap.transCoord.bursaWolf=function(e,t,o,a){var n=a.tx,r=a.ty,s=a.tz,i=a.s,l=wmsMap.oper.degToRad(a.rx),c=wmsMap.oper.degToRad(a.ry),a=wmsMap.oper.degToRad(a.rz),d=Math.sin(c),c=Math.cos(c),T=Math.sin(l),l=Math.cos(l),R=Math.sin(a),a=Math.cos(a),i=1+i,m=[[],[],[]];return m[0][0]=i*(c*a),m[1][0]=i*(-c*R),m[2][0]=i*d,m[0][1]=i*(T*d*a+l*R),m[1][1]=i*(-T*d*R+l*a),m[2][1]=i*(-T*c),m[0][2]=i*(-l*d*a+T*R),m[1][2]=i*(l*d*R+T*a),m[2][2]=i*(l*c),{x:m[0][0]*e+m[0][1]*t+m[0][2]*o+n,y:m[1][0]*e+m[1][1]*t+m[1][2]*o+r,z:m[2][0]*e+m[2][1]*t+m[2][2]*o+s}},wmsMap.transCoord.changeDatum=function(e,t,o,a){return"ETRS89"==o&&"WGS84"==a||"ETRS89"==a&&"WGS84"==o?{lon:e,lat:t}:(gcIn=wmsMap.transCoord.GeoToGeocentric(e,t,o),o=this.getParam(o,a,e,t),gcOut=wmsMap.transCoord.bursaWolf(gcIn.x,gcIn.y,gcIn.z,o),{lon:(gOut=wmsMap.transCoord.GeocentricToGeo(gcOut.x,gcOut.y,gcOut.z,a)).lon,lat:gOut.lat})},wmsMap.transCoord.getParam=function(e,t,o,a){var n,o=-9.416<o&&o<-4.5&&41.5<a&&a<43.833?(n=datToDat.ETRS89toED50NWP,datToDat.ED50toETRS89NWP):1<o&&o<4.5&&38.5<a&&a<40.3?(n=datToDat.ETRS89toED50Bal,datToDat.ED50toETRS89Bal):-10<o&&o<3.833&&35.5<a&&a<44.833?(n=datToDat.ETRS89toED50Pen,datToDat.ED50toETRS89Pen):(n=datToDat.WGS84toED50,datToDat.ED50toWGS84);return"ETRS89"==e&&"ED50"==t?n:"ED50"==e&&"ETRS89"==t?o:"WGS84"==e&&"ED50"==t?datToDat.WGS84toED50:"ED50"==e&&"WGS84"==t?datToDat.ED50toWGS84:"OSGB36"==e&&"WGS84"==t?datToDat.OSGB36toWGS84:void 0},wmsMap.transCoord.getGradMinSeg=function(e,t){var o=60*(Math.floor(e)-e),a=60*(Math.floor(t)-t),n=Math.floor(60*(o-Math.floor(o))),r=Math.floor(60*(a-Math.floor(a))),o=(e=0<=e?Math.floor(e)+"&ordm;"+Math.floor(Math.abs(o))+"'"+Math.abs(n-59)+"''":"-"+Math.abs(Math.ceil(e))+"&ordm;"+Math.floor(60+o)+"'"+n+"''",Math.floor(t)+"&ordm;"+Math.floor(Math.abs(a))+"'"+Math.abs(r-59)+"''");return{lon:e,lat:o}},wmsMap.transCoord.getGradDeci=function(e,t,o){return(e=e||0)+(t=t||0)/60+(o=o||0)/3600},wmsMap.transCoord.getSuperficie=function(matrix,datum){for(var c,vect=[],matrixAux=[],i=0;i<matrix.length;i++){var c=wmsMap.transCoord.geoToUTM(eval(matrix[i][0]),eval(matrix[i][1]),datum,30),vect=[];vect[0]=c.x,vect[1]=c.y,matrixAux.push(vect)}var superf=0,n=matrixAux.length;if(matrixAux[0][0]==matrixAux[n-1][0]&&matrixAux[0][1]==matrixAux[n-1][1])for(var j=0;j<n-1;j++)superf+=-matrixAux[j][0]*matrixAux[j+1][1]+matrixAux[j+1][0]*matrixAux[j][1];else{for(var j=0;j<n-1;j++)superf+=-matrixAux[j][0]*matrixAux[j+1][1]+matrixAux[j+1][0]*matrixAux[j][1];superf+=-matrixAux[n-1][0]*matrixAux[0][1]+matrixAux[0][0]*matrixAux[n-1][1]}return Math.abs(superf/2)},wmsMap.transCoord.normalizeDegrees=function(e){var t=[360,180];return e[0]<-t[0]&&(e[0]+=t[0],e[2]+=t[0]),e[2]>t[0]&&(e[2]-=t[0],e[0]-=t[0]),e[1]<-t[1]&&(e[1]+=t[1],e[3]+=t[1]),e[3]>t[1]&&(e[3]-=t[1],e[1]-=t[1]),e},wmsMap.transCoord.geoZone=function(e,t,o){return o="UTM"==this.getDatum(o).proy?this.srsChange(e,t,o,"EPSG:4258"):{c1:e,c2:t},Math.floor((o.c1+180)/6)+1},wmsMap.transCoord.tw2c=function(e,t,o,a,n){var r,s,i,l={},c={};return a.x00?(i=e-parseFloat(a["x0"+n]),r=t-parseFloat(a["y0"+n]),s=o-parseFloat(a["z0"+n]),daux=-parseFloat(a["df"+n])/(parseFloat(a["r"+n][2])*i+parseFloat(a["r"+n][5])*r+parseFloat(a["r"+n][8])*s),l.x=(parseFloat(a["r"+n][0])*i+parseFloat(a["r"+n][3])*r+parseFloat(a["r"+n][6])*s)*daux,l.y=(parseFloat(a["r"+n][1])*i+parseFloat(a["r"+n][4])*r+parseFloat(a["r"+n][7])*s)*daux,c=wmsMap.tAfinDirect(l,a["tx"+n],a["ty"+n],a.r),(i=YAHOO.util.Dom.getStyle("contIzq","height"))&&(c.y=parseInt(i)-c.y)):(c.x=(a[0+8*n]*e*100+a[1+8*n])/(100*o+a[2+8*n])+a[3+8*n],c.y=(a[4+8*n]*t*100+a[5+8*n])/(100*o+a[6+8*n])+a[7+8*n]),c},wmsMap.tAfinDirect=function(e,t,o,a){var n={};return n.x=parseFloat(a[0])*e.x+parseFloat(a[1])*e.y+parseFloat(t),n.y=parseFloat(a[2])*e.x+parseFloat(a[3])*e.y+parseFloat(o),n},wmsMap.tAfinInver=function(e,t,o,a){var n=e.x,e=e.y,r={},s=a[0]*a[3]-a[2]*a[1];return s&&(r.x=(parseFloat(a[3])*n-parseFloat(a[1])*e-parseFloat(a[3])*t+parseFloat(a[1])*o)/s,r.y=(-parseFloat(a[2])*n+parseFloat(a[0])*e-parseFloat(a[0])*o+parseFloat(a[2])*t)/s),r},TR3.requestDTMwcs=!1,TR3.scene,TR3.renderer,TR3.camera,TR3.controls,TR3.mesh,TR3.fov=30,TR3.sourceFile=!1,TR3.sourceTexture=!1,TR3.blobs=new Array,TR3.params,TR3.geo2UTM,TR3.bboxImgOri=[],TR3.srsImg,TR3.widthImg,TR3.heightImg,TR3.tPixImg,TR3.texture,TR3.maxResolMesh=5,TR3.reducDTM=1,TR3.zMin,TR3.zMed,TR3.zMax,TR3.arrayZ=[],TR3.zone=[],TR3.centerZone=[],TR3.reducMeshW,TR3.reducMeshH,TR3.timeoutReq=[],TR3.timeoutReq[1]=0,TR3.newMap=!1,TR3.cameraDist=1,TR3.pscs=[],TR3.pscs.physicsWorld,TR3.pscs.transformAux1=!1,TR3.pscs.dynamicObjects=[],TR3.pscs.plasmaBalls=[],TR3.pscs.emiter=!1,TR3.pscs.emiters=[],TR3.pscs.rain=[],TR3.loadedFiles=[],TR3.newGeom=!1,TR3.cloneObj=!1,TR3.map,TR3.canvasDest,TR3.loadingDiv,TR3.canvasDestW,TR3.canvasDestH,TR3.optionsSet={imgControl:!0,cursor3d:!1,anaglyph:!1,autoRotate:!1,wireframeMesh:!1,tentative:!1,terrain:!1},TR3.valuesSet={magnification:"auto",height:0},TR3.cursor={helper:!1,setZterr:!1,setkCde:!1,causeLock:"",event:!1,coordClick:!1,mouseDownID:!1},TR3.slctBox=new Array,TR3.newMeshMap=1,TR3.oneMeshMap=2,TR3.zeroParallax,TR3.moveKey={is:!1,size:1.7,walk:!1,azOriAng:0,walkClicked:!1},TR3.CtrlDargClick=!1,TR3.cameraPositionFar,TR3.lookAt,TR3.oscillate=[],TR3.rotate=[],TR3.scalate=[],TR3.rotatePart=[],TR3.lookAtCamera=[],TR3.idAnimation=-1,TR3.mixer=new Array,TR3.newDraw=-1,TR3.vGeom=[],TR3.vGeom.positions,TR3.vGeom.measure=!1,TR3.vGeom.polig=!1,TR3.vGeom.newText=!1,TR3.vGeom.newLight=!1,TR3.vGeom.item=[],TR3.vGeom.item.magni,TR3.vGeom.item.nPoint=0,TR3.vGeom.sprites=[],TR3.vGeom.lights=[],TR3.vGeom.obj3d=[],TR3.vGeom.build=[],TR3.animate=function(){TR3.idAnimation=requestAnimationFrame(TR3.animate),TR3.controls.update(),TR3.renderScene(),1==TR3.moveKey.is&&TR3.moveKeyFn();var e=TR3.clock.getDelta(),t=TR3.clock.getElapsedTime();if(TR3.pscs.updatePhysics(e),TR3.mixer)for(var o=0;o<TR3.mixer.length;o++)TR3.mixer[o].update(e);for(o=0;o<TR3.oscillate.length;o++){var a=TR3.oscillate[o],n=a[0].position,r=0,s=a[3]||0;s+=Math.sin(t*a[1]+r)*a[2],n.y=s}for(o=0;o<TR3.rotatePart.length;o++){var i=TR3.rotatePart[o],l=i[0].rotation,r=0,s=i[3]||0;s+=Math.sin(t*i[1]+r)*i[2],l.y=s}for(o=0;o<TR3.rotate.length;o++){var c=TR3.rotate[o];c[0].rotation.y+=c[1]||.02}for(o=0;o<TR3.lookAtCamera.length;o++)TR3.lookAtCamera[o].lookAt(TR3.camera.position);for(o=0;o<TR3.scalate.length;o++){var d=TR3.scalate[o],T=d[0].scale,R=d[3]||0;R+=Math.sin(t*d[1])*d[2],T.x=R,T.y=R,T.z=R}if(0<TR3.pscs.plasmaBalls.length&&1==TR3.camera.visible)for(o=0;o<TR3.pscs.plasmaBalls.length;o++){var m,p,u,g=TR3.pscs.plasmaBalls[o];g.colision||(g.translateZ(m=-50*e),25<g.cont&&!g.distFrames&&(p=TR3.getRayCaster([g.pos,g.vector],"point-vector"),(u=TR3.getSelectableObj()).push(TR3.mesh),(p=TR3.getIntersect(p,u)[0][0])?(u=p.distance,g.distFrames||(g.distFrames=-u/m)):g.distFrames="infinite"),g.distFrames&&"infinite"!=g.distFrames&&g.distFrames<g.cont*parseInt(6.25)&&(p?(g.colision=!0,g.position.set(p.point.x,p.point.y,p.point.z)):g.distFrames=!1),g.cont++)}var h=TR3.sky.material.uniforms.rayleigh.value,y=Math.round(10*TR3.oscillator(.07*t+.4,1,.3,0,.4))/10;Math.round(.07*t*200)%9==0&&h!=y&&(TR3.sky.material.uniforms.rayleigh.value=y)},TR3.startAnimation=function(e){TR3.idAnimation=window.requestAnimationFrame(TR3.animate)},TR3.stopAnimation=function(e){window.cancelAnimationFrame(TR3.idAnimation)},TR3.renderScene=function(){TWEEN.update(),TR3.optionsSet.anaglyph&&Detector.webgl?TR3.anaglyphRenderer.render(TR3.scene,TR3.camera,TR3.zeroParallax):TR3.renderer.render(TR3.scene,TR3.camera)},TR3.exportGLTF=function(e){var t=new Array;if("selected"==e&&TR3.transformControls.object)t=TR3.transformControls.object;else if("scene"==e)for(var o=0;o<TR3.scene.children.length;o++){var a=TR3.scene.children[o];"Mesh"!==a.type&&"Group"!==a.type&&"Object3D"!==a.type&&"Sprite"!==a.type||"TransformControls"!==a.name&&"G-hills"!==a.name&&"cursor"!==a.name&&"planetary"!==a.name&&"starField"!==a.name&&"Sky"!==a.name&&"Compass"!==a.name&&"N"!==a.name&&"S"!==a.name&&"E"!==a.name&&"W"!==a.name&&t.push(function(e){e="Scene"!=e.type&&"Group"!=e.type&&e.scene||e;return TR3.SkeletonUtilsClone(e)}(a))}else"terrain"==e&&(t=TR3.mesh);(new TR3.GLTFExporter).parse(t,function(e){var t;e instanceof ArrayBuffer?(t="TR3_scene.glb",r(new Blob([e],{type:"application/octet-stream"}),t)):(t=JSON.stringify(e,null,2),e="TR3_scene.gltf",r(new Blob([t],{type:"text/plain"}),e))},"",{trs:!0,onlyVisible:!0,binary:!0,animations:!1,maxTextureSize:1024});var n=document.createElement("a");function r(e,t){n.href=URL.createObjectURL(e),n.download=t,n.click()}n.style.display="none",document.body.appendChild(n)},TR3.AnaglyphEffect=function(l,e,t){var c,d,T,R,m,p=new THREE.Matrix4,u=new THREE.Matrix4,g=200,h=new THREE.PerspectiveCamera,y=(h.matrixAutoUpdate=!1,new THREE.PerspectiveCamera),v=(y.matrixAutoUpdate=!1,new THREE.OrthographicCamera(-1,1,1,-1,0,1)),f=new THREE.Scene,o={minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat},b=new THREE.WebGLRenderTarget(e=void 0===e?512:e,t=void 0===t?512:t,o),E=new THREE.WebGLRenderTarget(e,t,o),a=(this.getAnaglyphColors=function(){var e="",t={lr1:"0.0",lg1:"0.7",lb1:"0.3",rr2:"0.0",rg2:"1.0",rb2:"0.0",rr3:"0.0",rg3:"0.0",rb3:"1.0"};switch(e=TR3?TR3.anaglyphType:e){case"normal":t={lr1:"1.0",lg1:"0.0",lb1:"0.0",rr2:"0.0",rg2:"1.0",rb2:"0.0",rr3:"0.0",rg3:"0.0",rb3:"1.0"};break;case"half":t={lr1:"0.299",lg1:"0.587",lb1:"0.114",rr2:"0.0",rg2:"1.0",rb2:"0.0",rr3:"0.0",rg3:"0.0",rb3:"1.0"};break;case"gray":t={lr1:"0.299",lg1:"0.587",lb1:"0.114",rr2:"0.299",rg2:"0.587",rb2:"0.114",rr3:"0.299",rg3:"0.587",rb3:"0.114"}}return t},this.getFragmentShader=function(){var e=this.getAnaglyphColors(),e=["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","\tvec4 colorL, colorR;","\tvec2 uv = vUv;","\tcolorL = texture2D( mapLeft, uv );","\tcolorR = texture2D( mapRight, uv );","\tgl_FragColor = vec4( colorL.r * "+e.lr1+" + colorL.g * "+e.lg1+" + colorL.b * "+e.lb1+", colorR.r * "+e.rr2+" + colorR.g * "+e.rg2+" + colorR.b * "+e.rb2+", colorR.r * "+e.rr3+" + colorR.g * "+e.rg3+" + colorR.b * "+e.rb3+", colorL.a + colorR.a ) * 1.1;","}"].join("\n");return TR3&&"interlaced"==TR3.anaglyphType?e=["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","\tvec2 uv = vUv;","\tif ( ( mod( gl_FragCoord.y, 2.0 ) ) < 1.00 ) {","\t\tgl_FragColor = texture2D( mapRight, uv );","\t} else {","\t\tgl_FragColor = texture2D( mapLeft, uv );","\t}","}"].join("\n"):TR3&&"interlaced swap"==TR3.anaglyphType&&(e=["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","\tvec2 uv = vUv;","\tif ( ( mod( gl_FragCoord.y, 2.0 ) ) < 1.00 ) {","\t\tgl_FragColor = texture2D( mapLeft, uv );","\t} else {","\t\tgl_FragColor = texture2D( mapRight, uv );","\t}","}"].join("\n")),e},new THREE.ShaderMaterial({uniforms:{mapLeft:{type:"t",value:b},mapRight:{type:"t",value:E}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = vec2( uv.x, uv.y );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:this.getFragmentShader()})),e=new THREE.Mesh(new THREE.PlaneGeometry(2,2),a);f.add(e),this.setSize=function(e,t){b&&b.dispose(),E&&E.dispose(),b=new THREE.WebGLRenderTarget(e,t,o),E=new THREE.WebGLRenderTarget(e,t,o),a.uniforms.mapLeft.value=b.texture,a.uniforms.mapRight.value=E.texture,l.setSize(e,t)},this.render=function(e,t,o){var a,n,r,s,i=l.getRenderTarget();e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),d===t.aspect&&T===t.near&&R===t.far&&m===t.fov&&g===o||(d=t.aspect,T=t.near,R=t.far,m=t.fov,c=g=o,o=t.projectionMatrix.clone(),a=(r=c/30*.5)*T/c,n=T*Math.tan(THREE.MathUtils.degToRad(.5*m)),p.elements[12]=r,u.elements[12]=-r,r=-n*d+a,s=n*d+a,o.elements[0]=2*T/(s-r),o.elements[8]=(s+r)/(s-r),h.projectionMatrix.copy(o),r=-n*d-a,s=n*d-a,o.elements[0]=2*T/(s-r),o.elements[8]=(s+r)/(s-r),y.projectionMatrix.copy(o)),h.matrixWorld.copy(t.matrixWorld).multiply(u),h.position.copy(t.position),h.near=t.near,h.far=t.far,l.setRenderTarget(b),l.clear(),l.render(e,h),y.matrixWorld.copy(t.matrixWorld).multiply(p),y.position.copy(t.position),y.near=t.near,y.far=t.far,l.setRenderTarget(E),l.clear(),l.render(e,y),l.setRenderTarget(null),l.render(f,v),l.setRenderTarget(i)},this.dispose=function(){b&&b.dispose(),E&&E.dispose()},this.updateAnaglyphType=function(e,t){this.getAnaglyphColors();a.fragmentShader=this.getFragmentShader(),a.needsUpdate=!0,this.render(e,t,g)}},TR3.getIntersect=function(e,t){for(var o=!1,a=16777215,n=new Array,r=0;r<t.length;r++){var s=t[r],i=s;if(s.scene?i=s.scene:s.parent&&s.parent.scene&&(i=s.parent.scene),0<(n=i?e.intersectObject(i,!0):n).length&&0===TR3.slctBox.length){if(o=n,TR3.intersectEvOver(s),TR3.optionsSet.tentative&&i.TR3&&i.TR3.hitbox){var s=i.TR3.hitbox,l=i.TR3.box,c=i.scale,d=i.position,T=i.quaternion,i=(void 0!==i.TR3.floorMesh&&"number"==typeof i.TR3.floorMesh&&(a=7829367),void 0!==i.TR3.transformMesh&&"number"==typeof i.TR3.transformMesh&&(a=255),void 0!==i.TR3.mass&&"number"==typeof i.TR3.mass&&(a=65280),new THREE.BoxGeometry(s.x*c.x,s.y*c.y,s.z*c.z)),s=new THREE.EdgesGeometry(i),i=new THREE.LineBasicMaterial({color:a}),s=new THREE.LineSegments(s,i);s.position.set(d.x,d.y+(l.max.y+l.min.y)*c.y/2,d.z),s.quaternion.set(T.x,T.y,T.z,T.w),TR3.slctBox.push(s);for(var R=0;R<TR3.slctBox.length;R++)TR3.scalate.push([TR3.slctBox[R],6,.1,1]),TR3.scene.add(TR3.slctBox[R])}r=t.length}else if(n.length<1){if(0<TR3.slctBox.length){for(R=0;R<TR3.slctBox.length;R++)TR3.scene.remove(TR3.slctBox[R]);TR3.slctBox=new Array}}else(o=o||n)[0].point.y<n[0].point.y&&(o=n)}return[o]},TR3.getRayCaster=function(e,t,o,a){var n,r,a=a||13e5,o=o||0;return t?"point-point"==t?(n=e[0],r=(new THREE.Vector3).copy(e[1]).sub(n)):"point-camera"==t?(n=e[0],r=new THREE.Vector3,TR3.camera.getWorldDirection(r)):"point-vector"==t&&(n=e[0],r=(new THREE.Vector3).copy(e[1])):(n=(t=function(e){var t=TR3.map,o=t.offsetTop,a=t.offsetLeft;for(;t.parentElement;)t=t.parentElement,o+=t.offsetTop,a+=t.offsetLeft;e&&e.touches&&0<e.touches.length?(n=e.touches[0].clientX,r=e.touches[0].clientY):e?(n=e.clientX,r=e.clientY):(n=.5*TR3.canvasDestW,r=.5*TR3.canvasDestH,o=a=0);var e=(n-a)/TR3.canvasDestW*2-1,n=2*-((r-o)/TR3.canvasDestH)+1,r=new THREE.Vector3(e,n,TR3.camera.near),e=(r.unproject(TR3.camera),TR3.camera.position);return[e,r.sub(e)]}(e))[0],r=t[1]),new THREE.Raycaster(n,r.normalize(),o,a)},TR3.onIntersect=function(e){var t,o,a,n;TR3.optionsSet.cursor3d?(o=TR3.getRayCaster(e),0<(a=TR3.getIntersect(o,[TR3.mesh])[0]).length&&(n=(t=a[0].point).y,TR3.cursor.helper.position.set(t.x,n,t.z),TR3.redrawInfo(t.x,t.y,t.z,!1))):0<(n=TR3.getSelectableObj()).length&&TR3.optionsSet.tentative&&(o=TR3.getRayCaster(e),a=TR3.getIntersect(o,n)),TR3.cursor.event=e},TR3.getSelectableObj=function(){var e=new Array;if(0==TR3.camera.visible)for(var t=TR3.vGeom.obj3d,o=0;o<t.length;o++)(t[o].scene&&t[o].scene.TR3&&t[o].scene.TR3.slctItem||t[o]&&t[o].TR3&&t[o].TR3.slctItem)&&e.push(t[o]);else for(t=TR3.vGeom.build,o=0;o<t.length;o++)e.push(t[o]);return e},TR3.redrawInfo=function(e,t,o,a){var e=TR3.getCoordsByXYmod(e,o,!1),o=e[0],n=e[1],e=e[2],r=0,s=TR3.formatMeasure(TR3.tPixMesh),a=(a&&(r=a-e),TR3.XYZ2Clip=[o.toFixed(3),n.toFixed(3),e.toFixed(2)],"<b>Project: "+proj4.Proj(TR3.srsImg).projName+" - Datum:"+proj4.Proj(TR3.srsImg).title+"</b><br><b>X:</b> "+TR3.XYZ2Clip[0]+"<br><b>Y:</b> "+TR3.XYZ2Clip[1]+"<br><b>Z:</b> "+TR3.XYZ2Clip[2]+"&nbsp;&nbsp;&nbsp;<b>±Zcur:</b> "+(r*TR3.adjustMapScale).toFixed(2)+" m&nbsp;&nbsp;&nbsp;<b>Malla:</b> "+(+s[0]/TR3.adjustMapScale).toFixed(2)+" "+s[1]);document.getElementById("infoGeo3d").innerHTML=a},TR3.zCursor=function(e){var t=TR3.cursor.helper.position,e=TR3.zM2T(t.y)+e*TR3.getSizePix(),o=TR3.zM2T(e,!0);t.set(t.x,o,t.z),TR3.redrawInfo(t.x,t.y,t.z,e),TR3.optionsSet.cursor3d=!1,setTimeout(function(){TR3.optionsSet.cursor3d=!0},3e3)},TR3.click_Obj3d=function(e){var t=!0,o=TR3.getRayCaster(e),a=TR3.getIntersect(o,[TR3.mesh]),n=TR3.camera.position;if(TR3.cursor.coordClick=new THREE.Vector3,0<a.length&&a[0].length?(r=a[0][0],TR3.cursor.coordClick.x=r.point.x,TR3.cursor.coordClick.y=r.point.y,TR3.cursor.coordClick.z=r.point.z):(TR3.cursor.coordClick=!1,console.log("Fail Position!")),!TR3.CtrlDargClick&&TR3.optionsSet.tentative){var r=TR3.getSelectableObj();if(0<r.length){var o=TR3.getRayCaster(e),e=TR3.getIntersect(o,r);if(e[0]&&TR3.cursor.mouseDownID===e[0][0].object.uuid)return o={intersect:e[0]},TR3.intersectEvClick(o),!0===TR3.optionsSet.anaglyph&&(TR3.zeroParallax=n.distanceTo(e[0][0].point),t=!1),!0}}TR3.CtrlDargClick=!1,t&&!0===TR3.optionsSet.anaglyph&&0==TR3.transformControls.visible&&(TR3.zeroParallax=n.distanceTo(a[0][0].point)),1==TR3.newGeom&&(TR3.setGeomBySelect(),TR3.canvasDest.style.cursor="default",TR3.newGeom=!1),TR3.sourceFile&&(TR3.loadFile({slctItem:!0}),TR3.canvasDest.style.cursor="default"),1==TR3.pscs.emiter&&TR3.pscs.setEmisor(),1==TR3.cloneObj&&((r=TR3.transformControls.object)?TR3.setCloneObj(r):(TR3.cloneObj=!1,TR3.canvasDest.style.cursor="default")),1==TR3.moveKey.walkClicked&&(TR3.moving=!0,TR3.personViewFn(),TR3.moveKey.walk=!0,TR3.moveKey.walkClicked=!1,TR3.canvasDest.style.cursor="default"),1==TR3.vGeom.newText&&""!=(o=document.getElementById("inputTextInto").value)&&(e=TR3.formatedText(o),TR3.scene.add(e),TR3.vGeom.newText=!1,TR3.transCtrlsEnabled(e),TR3.onCreateItem(e),TR3.canvasDest.style.cursor="default"),1==TR3.vGeom.newLight&&(t=$("#minicolorLight").val()||"#ffffff",n=document.getElementById("intensLight").value||1,a=document.getElementById("distLight").value||100,(r=TR3.setLight(t,n,a))[0].position.set(TR3.cursor.coordClick.x,TR3.cursor.coordClick.y,TR3.cursor.coordClick.z),TR3.scene.add(r[0]),TR3.scene.add(r[1]),TR3.transCtrlsEnabled(r[0]),TR3.onCreateItem(r[0]),TR3.vGeom.newLight=!1,TR3.canvasDest.style.cursor="default"),TR3.cursor.helper.visible&&TR3.vGeom.positions&&-1!=TR3.newDraw&&0<TR3.vGeom.item.length&&TR3.addPoint(),TR3.controls.active=!1,TR3.setOpts({autoRotate:!1})},TR3.setCoods2clip=function(e){e.preventDefault(),TR3.XYZ2Clip&&(document.getElementById("inputTextInto").value+="["+TR3.XYZ2Clip.toString()+"],")},TR3.decorations=function(e,t,o,a){0!=e&&TR3.setHills(),0!=t&&TR3.setStarField(13e5),0!=o&&TR3.setPlanets(13e5),0!=a&&TR3.setCompass()},TR3.setHills=function(){var e={src:TR3.config.src+"hills.glb",scale:[.8*Math.abs(TR3.zone[2]-TR3.zone[0]),.8*Math.abs(TR3.zone[2]-TR3.zone[0]),.8*Math.abs(TR3.zone[3]-TR3.zone[1])],pos:[TR3.centerZone[0],TR3.centerZone[1],0],aRotate:!1,name:"Decoration",slctItem:!1};TR3.loadFile(e).then(function(e){e[0].scene.name="hills",e[0].scene.position.y=0,e[0].scene.rotateY(Math.PI);var t=new THREE.Group;t.name="G-hills",t.add(e[0].scene),TR3.scene.add(t)})},TR3.setStarField=function(e){TR3.txtObject("N","#888888",3e4,[0,2e5,0-e],0).then(function(e){TR3.scene.add(e)}),TR3.txtObject("S","#888888",3e4,[0,2e5,0+e],Math.PI).then(function(e){TR3.scene.add(e)}),TR3.txtObject("E","#888888",3e4,[0+e,2e5,0],-Math.PI/2).then(function(e){TR3.scene.add(e)}),TR3.txtObject("W","#888888",3e4,[0-e,2e5,0],Math.PI/2).then(function(e){TR3.scene.add(e)});for(var t=new THREE.BufferGeometry,o=[],a=0;a<600;a++){var n=new THREE.Vector3,r=THREE.MathUtils.randFloat(0,2*Math.PI),s=THREE.MathUtils.randFloat(-Math.PI/2,Math.PI/2);n.x=e*Math.sin(r)*Math.cos(s),n.y=e*Math.sin(r)*Math.sin(s),n.z=e*Math.cos(r),o.push(n)}t.setFromPoints(o);var i=new THREE.PointsMaterial({color:"#cccc88",size:15e3}),t=new THREE.Points(t,i);t.name="starField",TR3.scene.add(t)},TR3.setPlanets=function(e){var t=new THREE.BoxGeometry(.01,.01,.01),o=new THREE.MeshBasicMaterial({}),t=new THREE.Mesh(t,o),o=(t.name="planetary",t.rotateX(Math.PI/20),new THREE.IcosahedronGeometry(5e4,3)),a=new THREE.MeshLambertMaterial({color:11184733}),a=new THREE.Mesh(o,a),n=(a.position.x=e-5e4,new THREE.RingGeometry(6e4,9e4,32)),r=new THREE.MeshLambertMaterial({color:13421772,side:THREE.DoubleSide}),r=new THREE.Mesh(n,r),r=(r.rotateX(Math.PI/1.5),a.add(r),t.add(a),TR3.rotate.push([a,.01]),new THREE.MeshLambertMaterial({color:13421772})),a=new THREE.Mesh(o,r),o=(a.position.x=5e4-e,new THREE.MeshLambertMaterial({color:11184733,side:THREE.DoubleSide})),r=new THREE.Mesh(n,o);r.rotateX(Math.PI/1.5),a.add(r),t.add(a),TR3.rotate.push([a,.01]),TR3.rotate.push([t,.001]),TR3.scene.add(t)},TR3.setCompass=function(){var e=TR3.getCoordsDistance([TR3.zone[0],TR3.zone[1]],[TR3.zone[2],TR3.zone[3]])/1.5,t=new THREE.RingGeometry(1.1*e,1.3*e,32),o=new THREE.MeshBasicMaterial({color:15918847,transparent:!0,opacity:.5}),o=new THREE.Mesh(t,o),a=(o.name="Compass",TR3.setGeometry({geometry:"semisphere",radius:1.1*e},new THREE.MeshBasicMaterial({color:16777215,side:THREE.BackSide}))),a=(o.add(a),TR3.zM2T(TR3.zMmax,!0)),e=(o.position.y=-20,o.rotateX(3*Math.PI/2),o.rotateZ(.92),TR3.txtObject("- N -","#888888",e/15,[0,a,0-e],0).then(function(e){TR3.scene.add(e)}),TR3.txtObject("- S -","#888888",e/15,[0,a,0+e],Math.PI).then(function(e){TR3.scene.add(e)}),TR3.txtObject("- E -","#888888",e/15,[0+e,a,0],-Math.PI/2).then(function(e){TR3.scene.add(e)}),TR3.txtObject("-W-","#888888",e/15,[0-e,a,0],Math.PI/2).then(function(e){TR3.scene.add(e)}),new THREE.WireframeGeometry(t)),a=new THREE.LineBasicMaterial({color:13421772}),t=new THREE.Line(e,a);o.add(t),TR3.scene.add(o)},TR3.updateVgeom=function(){for(var e=TR3.vGeom.item[TR3.vGeom.item.length-1],t=TR3.getMetrics(e),o=0;o<t.length;o++){var a=t[o][1]||TR3.cursor.coordClick,a=(a.inv=!0,{text:t[o][0],pos:a}),n=TR3.makeTextSprite(a);TR3.scene.add(n)}TR3.MeasureEvEnd(t,n)},TR3.addPoint=function(){var e=TR3.cursor.coordClick,t=TR3.vGeom.item[TR3.vGeom.item.length-1],o=t.nPoint,a=TR3.vGeom.positions;a[3*o+0]=e.x,a[3*o+1]=e.y,a[3*o+2]=e.z,t.nPoint++,t.geometry.setDrawRange(0,t.nPoint),t.geometry.attributes.position.needsUpdate=!0,1<o&&TR3.vGeom.measure&&TR3.updateVgeom()},TR3.newVgeom=function(e){TR3.newDraw++;var t=new THREE.BufferGeometry,o=new Float32Array(450),o=(t.setAttribute("position",new THREE.BufferAttribute(o,3)),TR3.vGeom.positions=o,new THREE.LineBasicMaterial({color:$("#PickDrawStereo").val()})),t=new(1==TR3.vGeom.polig?THREE.LineLoop:(TR3.distAlt=0,TR3.dist2D=0,TR3.dist3D=0,TR3.distTerr=0,THREE.Line))(t,o);if(t.frustumCulled=!1,t.nPoint=0,t.magni=TR3.valuesSet.magnification,t.name="handMade",TR3.scene.add(t),TR3.vGeom.sprites&&TR3.vGeom.sprites.length)for(var a=0;a<TR3.vGeom.sprites.length;a++)1==TR3.vGeom.sprites[a].reload&&(TR3.vGeom.sprites[a].reload=!1);if(TR3.vGeom.item&&TR3.vGeom.item.length)for(a=0;a<TR3.vGeom.item.length;a++)1==TR3.vGeom.item[a].reload&&(TR3.vGeom.item[a].reload=!1);TR3.vGeom.item||(TR3.vGeom.item=new Array(0)),TR3.vGeom.item.push(t),TR3.vGeom.item[0].reload=!1},TR3.endDraw=function(e){TR3.newDraw=-1},TR3.getMetrics=function(e){var t=new Array;if(t.length=0,TR3.vGeom.sprites&&TR3.vGeom.sprites.length)for(var o=0;o<TR3.vGeom.sprites.length;o++)1==TR3.vGeom.sprites[o].reload&&(TR3.scene.remove(TR3.vGeom.sprites[o]),TR3.vGeom.sprites.splice(o,1),o--);if(TR3.vGeom.item&&TR3.vGeom.item.length)for(o=0;o<TR3.vGeom.item.length;o++)1==TR3.vGeom.item[o].reload&&(TR3.scene.remove(TR3.vGeom.item[o]),TR3.vGeom.item.splice(o,1),o--);if(1==TR3.vGeom.polig&&2<e.nPoint){for(var a,n=e.geometry.getAttribute("position"),r=new Array,o=(a=e.nPoint)-1;-1<o;o--){var s=TR3.getCoordsByXYmod(n.getX(o),n.getZ(o),!1);r.unshift(s)}var i=TR3.getSurf(r,e);t.push([TR3.txtMetric([i[0],i[1],i[2]]),new THREE.Vector3(n.getX(0),n.getY(0),n.getZ(0))]),t.push([TR3.txtMetric([i[6]]),new THREE.Vector3(n.getX(a-1),n.getY(a-1),n.getZ(a-1))]),t.push([TR3.txtMetric([i[3],i[4],i[5]]),new THREE.Vector3(n.getX(Math.floor(a/2)),n.getY(Math.floor(a/2)),n.getZ(Math.floor(a/2)))])}return TR3.vGeom.polig&&0!=TR3.vGeom.polig||(n=e.geometry.getAttribute("position"),a=e.nPoint,i=TR3.getCoordsByXYmod(n.getX(a-1),n.getZ(a-1),!1),e=TR3.getCoordsByXYmod(n.getX(a-2),n.getZ(a-2),!1),e=TR3.getDist(e[0],e[1],n.getY(a-2),i[0],i[1],n.getY(a-1)),t.push([TR3.txtMetric(e)])),t},TR3.txtMetric=function(e){for(var t="",o=0;o<e.length;o++)e[o]?t+=" "+e[o].name+": "+e[o].val+" "+e[o].unit+"\n":(e.splice(o,1),o--);return t=t&&2<t.length?t.slice(0,-1):t},TR3.assignZgeometries=function(){},TR3.makeTextSprite=function(e){var t=!!(e=void 0===e?{}:e).hasOwnProperty("center")&&e.center,o=e.hasOwnProperty("pos")?e.pos:{x:44e4,y:444e4,z:900,inv:!1},a=e.hasOwnProperty("text")?e.text:"",n=!!e.hasOwnProperty("isPixSize")&&e.isPixSize,r=e.hasOwnProperty("extraData")?e.extraData:new Array,s=(void 0===e.font&&(e.font={}),e.font.hasOwnProperty("fontFace")?e.font.fontFace:"Arial"),i=e.font.hasOwnProperty("fontSize")?e.font.fontSize:24,l=!e.font.hasOwnProperty("bold")||e.font.bold,c=e.font.hasOwnProperty("textColor")?e.font.textColor:{r:0,g:0,b:0,a:1},d=(void 0===e.canvas&&(e.canvas={}),e.canvas.hasOwnProperty("backgroundColor")?e.canvas.backgroundColor:{r:255,g:100,b:100,a:.8}),T=(e.canvas.hasOwnProperty("borderColor")&&e.canvas.borderColor,e.canvas.hasOwnProperty("borderThickness")?e.canvas.borderThickness:4),R=e.canvas.hasOwnProperty("rounded")?e.canvas.rounded:6,m=e.canvas.hasOwnProperty("borderColor")?e.canvas.borderColor:{r:255,g:0,b:0,a:1},p=!!e.canvas.hasOwnProperty("text_Height")&&e.canvas.text_Height,u=!!e.canvas.hasOwnProperty("text_Width")&&e.canvas.text_Width,g=!!e.canvas.hasOwnProperty("scale")&&e.canvas.scale,h=!e.canvas.hasOwnProperty("depthTest")||e.canvas.depthTest,y=document.createElement("canvas"),v=y.getContext("2d"),l=l?"Bold ":"";v.font=l+i+"px "+s,v.fillStyle="rgba("+d.r+","+d.g+","+d.b+","+d.a+")",v.strokeStyle="rgba("+m.r+","+m.g+","+m.b+","+m.a+")";var f=(a=(a=null==a?"":a).replace(new RegExp("---","g")," ")).split("\n"),b=(f=f.length<=1?a.split("+++"):f).length,E=i+T,l=p||(1.2*i+T)*b,s=v.measureText(a),d=u||s.width/b*1.2;146<l&&(l=146),292<d&&(d=292),v.lineWidth=T,TR3.roundRect(v,T/2,T/2,d+T,l,R),v.fillStyle="rgba("+c.r+","+c.g+","+c.b+","+c.a+")";for(var M=0;M<b;++M)v.fillText(f[M],T,E*(M+1));m=new THREE.Texture(y),m.needsUpdate=!0,p=new THREE.SpriteMaterial({map:m,alphaTest:.6,depthTest:h}),i=new THREE.Sprite(p),i.TR3=new Object,i.TR3.extraData=r,i.TR3.source=JSON.parse(JSON.stringify(e)),i.reload=!0,a=new THREE.Vector3,o.inv?(a.x=o.x,a.y=o.y,a.z=o.z):(u=TR3.coordM2T(o.x,o.y,o.z,!0),a.x=u[0],a.y=u[1],a.z=u[2]),n&&(a.y="$"+o.z+"$P"),i.position.set(a.x,a.y,a.z),s=TR3.config.spritesDskMvl,g?n?i.scale.set(g*TR3.getSizePix()*s,g/2*TR3.getSizePix()*s,1):i.scale.set(g,g/2,1):i.scale.set(100*TR3.getSizePix()*s,50*TR3.getSizePix()*s,1),d=TR3.rectaValue(1,.7,4,.05,b);return t?i.center.set(.5,.5):i.center.set(0,d),TR3.vGeom.sprites||(TR3.vGeom.sprites=new Array(0)),TR3.vGeom.sprites.push(i),i},TR3.formatedText=function(e,t,o){for(var a=e,n="",r="",s=(25<a.length&&(a=e.slice(0,25)+"-\n ",25<(n=e.slice(25)).length)&&(n=e.slice(25,50)+"-\n ",r=e.slice(50,75)),(a+n+r).split("-\n")),i="",l=0;l<s.length;l++){var c=s[l];i+=spaces(25-c.length)+c+"-\n"}e=i.slice(0,-2);a=t||$("#minicolorText").val()||"#ff00ff",n=new THREE.Color(a),r="#"+n.getHexString(),t=2*(e.match(/\n/g)||[]).length,a=new THREE.Vector3,a.x=o&&o[0]?o[0]:TR3.cursor.coordClick.x||0,a.y=o&&o[1]?o[1]+t:TR3.cursor.coordClick.y+t||0,a.z=o&&o[2]?o[2]:TR3.cursor.coordClick.z||0,t={text:e,font:{fontFace:"Arial",bold:!1},pos:{x:a.x,y:a.y,z:a.z,inv:!0},canvas:{text_Width:292,backgroundColor:{r:255*n.r,g:255*n.g,b:255*n.b,a:.8},borderColor:{r:155*n.r,g:155*n.g,b:155*n.b,a:1},borderThickness:1,depthTest:!1},center:!0},o=TR3.makeTextSprite(t);return o.TR3.source={text:t.text,color:r,pos:t.pos},o.name=e,o},TR3.del_vGeom=function(e,t){TR3.transformControls&&TR3.transCtrlsEnabled(!1);var o,a,n=e?TR3.vGeom.sprites.length-1:0,r=e?TR3.vGeom.obj3d.length-1:0,s=e?TR3.vGeom.build.length-1:0,i=e?TR3.vGeom.lights.length-1:0,e=!0,l=!0,c=!0,d=!0,T=!0;if(t&&(e="sprites"==t,l="obj3d"==t,c="build"==t,d="lights"==t,T="item"==t),d&&TR3.vGeom.lights&&TR3.vGeom.lights.length){for(;i<TR3.vGeom.lights.length;i++)TR3.onSuprFnc(TR3.vGeom.lights[i]),TR3.scene.remove(TR3.vGeom.lights[i][0]),TR3.scene.remove(TR3.vGeom.lights[i][1]),TR3.vGeom.lights.splice(i,1),i--;0===i&&(TR3.vGeom.lights=[])}if(e&&TR3.vGeom.sprites&&TR3.vGeom.sprites.length){for(;n<TR3.vGeom.sprites.length;n++)TR3.onSuprFnc(TR3.vGeom.sprites[n]),TR3.scene.remove(TR3.vGeom.sprites[n]),TR3.vGeom.sprites.splice(n,1),n--;0===n&&(TR3.vGeom.sprites=[])}if(l&&TR3.vGeom.obj3d&&TR3.vGeom.obj3d.length){for(;r<TR3.vGeom.obj3d.length;r++)1!=TR3.vGeom.obj3d[r].persist2Scene&&(a=(o=TR3.vGeom.obj3d[r]).scene||(o.parent&&o.parent.scene?o.parent.scene:o),TR3.onSuprFnc(a),TR3.scene.remove(a),TR3.vGeom.obj3d.splice(r,1),r--);0===r&&(TR3.vGeom.obj3d=[])}if(c&&TR3.vGeom.build&&TR3.vGeom.build.length){for(;s<TR3.vGeom.build.length;s++)1!=TR3.vGeom.build[s].persist2Scene&&(a=(o=TR3.vGeom.build[s]).scene||(o.parent&&o.parent.scene?o.parent.scene:o),TR3.scene.remove(a),TR3.vGeom.build.splice(s,1),s--);0===s&&(TR3.vGeom.build=[])}if(T&&TR3.vGeom.item&&TR3.vGeom.item.length){for(var R=0;R<TR3.vGeom.item.length;R++)TR3.scene.remove(TR3.vGeom.item[R]);TR3.vGeom.item=!1,TR3.vGeom.item.magni,TR3.vGeom.item.nPoint&&(TR3.vGeom.item.nPoint=0)}TR3.newDraw=-1},TR3.roundRect=function(e,t,o,a,n,r){e.beginPath(),e.moveTo(t+r,o),e.lineTo(t+a-r,o),e.quadraticCurveTo(t+a,o,t+a,o+r),e.lineTo(t+a,o+n-r),e.quadraticCurveTo(t+a,o+n,t+a-r,o+n),e.lineTo(t+r,o+n),e.quadraticCurveTo(t,o+n,t,o+n-r),e.lineTo(t,o+r),e.quadraticCurveTo(t,o,t+r,o),e.closePath(),e.fill(),e.stroke()},TR3.txtObject=async function(a,n,r,s,i){return new Promise(function(o){TR3.loaderFONT.load(TR3.config.src+"helvetiker_regular.typeface.json",function(e){var e=new TR3.TextGeometry(a,{font:e,size:r,height:.5,bevelEnabled:!0,bevelThickness:1,bevelSize:1,bevelOffset:0,bevelSegments:1}),t=new THREE.MeshBasicMaterial({color:n}),e=new THREE.Mesh(e,t);e.name=a,e.position.set(s[0],s[1],s[2]),e.rotation.y=i,o(e)})})},TR3.getFeatFromOL=function(e){TR3.loadingDiv.style.display="block";for(var t=0;t<e.length;t++){for(var o,a=e[t].getGeometry(),n=a.layout,r=a.getType(),s=["Point","Line","LineString","Polygon","Circle"],i=0;i<s.length;i++)-1!=r.indexOf(s[i])&&(o=s[i]);if(n&&o){var l=n.length,c=new Array,d=new Array;if("Circle"==o)var T=new THREE.Vector3,n=(a.getCenter(T),a.getRadius()),c=(d=TR3.getCoordsByXYmod(T[0],-T[1],!1))?new THREE.Vector4(d[3],d[4],d[5],n):new THREE.Vector4(T[0],TR3.zMed,-T[1],n);else if("Point"==o){T=a.getCoordinates();c=(d=TR3.getCoordsByXYmod(T[0],-T[1],!1))?new THREE.Vector3(d[3],d[4],d[5]):new THREE.Vector3(T[0],TR3.zMed,-T[1])}else if(a.layout)for(var R,T=a.getCoordinates().toString().split(","),m=0;m<T.length;m+=l)d=2==l||0==T[m+2]?(R=TR3.getCoordsByXYmod(T[m],-T[m+1],!1))?[R[3],R[4],R[5]]:[T[m],TR3.zMed,-T[m+1]]:(R=TR3.zM2T(T[m+2],!0),[T[m],R,-T[m+1]]),c.push(new THREE.Vector3(d[0],d[1],d[2]));n=e[t].getStyle(),a=null,n=(n&&n.stroke_&&(n=n.getStroke().getColor(),a=new THREE.Color(n[0]/255,n[1]/255,n[2]/255)),{color:a}),a=TR3.makeVectFeat(c,o,n,{reload:!1});TR3.scene.add(a)}}TR3.loadingDiv.style.display="none",TR3.VectorEvEnd()},TR3.setFeatToOL=function(){var e=TR3.LyrFeatFromOri;new Array;if(TR3.scene)for(var t=0;t<TR3.vGeom.item.length;t++){var o=TR3.vGeom.item[t];if("handMade"==o.name){for(var a,n=new Array,r=o.geometry.getAttribute("position"),s=o.nPoint||r.version,i=0;i<s;i++)n.push([r.getX(i),-r.getZ(i),TR3.zM2T(r.getY(i))]);"LineLoop"==o.type?(a="Polygon",n.push([r.getX(0),-r.getZ(0),TR3.zM2T(r.getY(0))]),n=[n]):a="Point"==o.type?"Point":"LineString";var o=o.material.color,o=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(100, 100, 100, 0.2)"}),stroke:new ol.style.Stroke({color:[255*o.r,255*o.g,255*o.b,1],width:2})}),l=new ol.Feature({geometry:new ol.geom[a](n)});l.setStyle(o),e.getSource().addFeature(l)}}},TR3.extrude2Dfeature=function(e,t,o){for(var a=new THREE.PlaneGeometry(1,1,e.length-1,1),n=a.getAttribute("position"),r=[],s=0;s<e.length;s++)n.setXYZ(s,e[s][0]-o[0],0,e[s][1]-o[1]);for(s=0;s<e.length;s++){n.setXYZ(s+e.length,e[s][0]-o[0],0+t*TR3.adjustMapScale,e[s][1]-o[1]);var i=new THREE.Vector2(e[s][0],e[s][1]);r.push(i)}n.needsUpdate=!0;var l=TR3.getRandomColor(100,150).hex,l=Math.round(l),c=new THREE.MeshBasicMaterial({color:l}),l=new THREE.MeshBasicMaterial({color:l,side:THREE.BackSide,transparent:!0,opacity:.5}),a=new THREE.Mesh(a,c),c=new THREE.EdgesGeometry(a.geometry),d=new THREE.LineBasicMaterial({color:13421772}),c=new THREE.LineSegments(c,d),d=new THREE.ShapeGeometry(new THREE.Shape(r)),d=new THREE.Mesh(d,l);return d.rotation.x=Math.PI/2,c.position.set(o[0],0,o[1]),d.position.y=0+t*TR3.adjustMapScale,a.position.set(o[0],0,o[1]),[c,a,d]},TR3.getRandomColor=function(e,t){var o=getRandomInt(e,t),a=getRandomInt(e,t),e=getRandomInt(e,t);return{rgb:[o,a,e],hex:Number("0x"+o.toString(16)+a.toString(16)+e.toString(16))}},TR3.setGeometry=function(e,t,o){var a,n=(e=void 0===e?{}:e).hasOwnProperty("depth")?e.depth:5.97,r=e.hasOwnProperty("height")?e.height:5.97,s=e.hasOwnProperty("width")?e.width:5.97,i=e.hasOwnProperty("heightSegments")?e.heightSegments:32,l=!!e.hasOwnProperty("openEnded")&&e.openEnded,c=e.hasOwnProperty("phiLength")?e.phiLength:2*Math.PI,d=(6.283==c&&(c=2*Math.PI),e.hasOwnProperty("phiStart")?e.phiStart:0),T=e.hasOwnProperty("radius")?e.radius:100,R=e.hasOwnProperty("radiusBottom")?e.radiusBottom:100,m=e.hasOwnProperty("radiusTop")?e.radiusTop:100,p=e.hasOwnProperty("thetaLength")?e.thetaLength:Math.PI,u=(6.283==p&&(p=2*Math.PI),e.hasOwnProperty("thetaStart")?e.thetaStart:0),g=e.hasOwnProperty("segments")?e.segments:32,h=e.hasOwnProperty("widthSegments")?e.widthSegments:32,y=!!(o=void 0===o?{}:o).hasOwnProperty("WireframeGeometry")&&o.WireframeGeometry,v=!!o.hasOwnProperty("EdgesGeometry")&&o.EdgesGeometry,f=!!o.hasOwnProperty("slctItem")&&o.slctItem,b=!!o.hasOwnProperty("transform")&&o.transform,E=!!o.hasOwnProperty("color")&&o.color,M=!!o.hasOwnProperty("extraData")&&o.extraData,E=E?t||new THREE.MeshBasicMaterial({color:E}):t||new THREE.MeshNormalMaterial({side:THREE.DoubleSide,opacity:.5,transparent:!0,depthTest:!0,depthWrite:!0,flatShading:!0});switch(e.geometry.toLowerCase()){case"box":a=new THREE.BoxGeometry(s,r,n,1,1,1);break;case"plane":(a=new THREE.PlaneGeometry(s,r,1,1)).rotateX(Math.PI/2);break;case"cylinder":a=new THREE.CylinderGeometry(m,R,r,g,1,l,u,p);break;case"cone":a=new THREE.ConeGeometry(T,r,g,i,l,u,p);break;case"circle":(a=new THREE.CircleGeometry(T,g,u,p)).rotateX(Math.PI/2);break;case"sphere":a=new THREE.SphereGeometry(T,h,i,d,c,u,p);break;case"semisphere":(a=new THREE.SphereGeometry(T,h,i,0,Math.PI,0,Math.PI)).rotateX(Math.PI);break;default:a=new THREE.BoxGeometry(s,r,n,1,1,1)}var x,w,S,E=new THREE.Mesh(a,E),v=(1==v&&(x=new THREE.EdgesGeometry(a),w=new THREE.LineBasicMaterial({color:13421772}),S=new THREE.LineSegments(x,w),E.add(S)),1==y&&(x=new THREE.WireframeGeometry(a),w=new THREE.LineBasicMaterial({color:13421772}),S=new THREE.LineSegments(x,w),E.add(S)),TR3.getSizeObj(E));return E.TR3=new Object,E.TR3.box=v[3],E.TR3.hitbox=v[4],E.TR3.radius=v[5],E.TR3.slctItem=!0,E.TR3.extraData=M||new Array,E.TR3.source={geom:e,mat:t,opts:o},1==f&&TR3.vGeom.obj3d.push(E),1==b&&TR3.transCtrlsEnabled(E),E},TR3.setLight=function(e,t,o){var e=e||"#ffffff",t=t||1,o=o||100,e=new THREE.Color(e),a="#"+e.getHexString(),e=new THREE.PointLight(e,t,o),a=(e.TR3=new Object,e.TR3.extraData=new Array,e.TR3.source={color:a,inten:t,dist:o},TR3.tPixMesh/10),t=new THREE.PointLightHelper(e,a);return TR3.vGeom.lights.push([e,t]),[e,t]},TR3.personViewFn=function(e){var t=(e||TR3.moveKey.size)/TR3.adjustMapScale,e=(TR3.controls.enableDamping=!1,TR3.controls.maxPolarAngle=1/0,TR3.controls.enableKeys=!1,TR3.camera.position.x=TR3.cursor.coordClick.x,TR3.camera.position.z=TR3.cursor.coordClick.z,TR3.getOptModCoordCam());e&&-1e7!=e[1]?(TR3.changeHeight(e[1]+t,!0,!0,1),TR3.cursor.helper.scale.set(.05,.05,.05)):(TR3.initPosCamera(!0),setTimeout(function(){TR3.personViewFn(t)},1500))},TR3.orbitalViewFn=function(){TR3.moveKey.walk=!1,TR3.controls.enableKeys=!1,TR3.controls.maxPolarAngle=Math.PI/2.25,TR3.controls.enableDamping=!0;var e=TR3.getRayCaster(!1),e=TR3.getIntersect(e,[TR3.mesh]);e[0]?((e=TR3.getCoordsByXYmod(e[0][0].point.x,e[0][0].point.z,!1))&&e[2]&&TR3.controls.target.set(e[3],e[4],e[5]),TR3.cursor.helper.scale.set(.5,.5,.5)):(TR3.initPosCamera(!0),setTimeout(function(){TR3.orbitalViewFn()},1500))},TR3.initPosCamera=function(e){TR3.moveKey.walk=!1,TR3.controls.enableDamping=!0,1==e?new TWEEN.Tween(TR3.camera.position).to({x:TR3.mesh.position.x,y:TR3.cameraPositionFar,z:TR3.mesh.position.z},2e3).easing(TWEEN.Easing.Linear).on("complete",function(e){TR3.controls.target.set(e.x,0,e.z),TR3.controls.update(),TR3.CameraMoveEvEnd()}).start():(TR3.camera.position.set(TR3.mesh.position.x,TR3.cameraPositionFar,TR3.mesh.position.z),TR3.controls.target.set(0,0,0),TR3.controls.update())},TR3.changeHeight=function(e,t,o,a){a=a||2e3;TR3.zeroParallax=e,TR3.moveKey.azOriAng=TR3.controls.getAzimuthalAngle(),1==o?new TWEEN.Tween(TR3.camera.position).to({y:e},a).easing(TWEEN.Easing.Linear).on("complete",function(e){TR3.controls.target.set(e.x+.01,e.y,e.z+.01),TR3.controls.update(),TR3.setAzAngle(TR3.moveKey.azOriAng),TR3.controls.enableKeys=!0,TR3.CameraMoveEvEnd()}).start():TR3.camera.position.y=e,1==t&&(TR3.controls.target.y=e,TR3.controls.update())},TR3.moveKeyFn=function(e){var t;1==TR3.moveKey.walk&&(e=e||TR3.moveKey.size,t=TR3.getOptModCoordCam(),TR3.changeHeight(t[1]+e,!0,!1,1))},TR3.keyDown=function(e){1!=TR3.moving||"37"!=e.keyCode&&"38"!=e.keyCode&&"39"!=e.keyCode&&"40"!=e.keyCode||(TR3.moveKey.is=!0);var a,t,o,n=TR3.transformControls.object;switch(e.keyCode){case 87:TR3.transformControls.setMode("translate");break;case 69:TR3.transformControls.setMode("rotate");break;case 82:TR3.transformControls.setMode("scale");break;case 107:TR3.transformControls.setSize(TR3.transformControls.size+.1);break;case 109:TR3.transformControls.setSize(Math.max(TR3.transformControls.size-.1,.1));break;case 32:TR3.transformControls.enabled=!1,TR3.transCtrlsEnabled(!1);break;case 86:n.visible=!n.visible;break;case 46:TR3.transformControls.enabled&&n&&(r=new Array,r="Sprite"===n.type?TR3.vGeom.sprites:"PointLight"===n.type?TR3.vGeom.lights:TR3.vGeom.obj3d,TR3.del3dObj(n,r),TR3.transformMeshByObj3d());break;case 90:if(TR3.transformControls.enabled&&n){var r=1;n.TR3.animation?(n.TR3.animation+=1,r=n.TR3.animation):n.TR3.animation=1;for(var s=0;s<TR3.rotate.length;s++){var i=TR3.rotate[s][0];n.uuid==i.uuid&&(TR3.rotate.splice(s,1),s--)}for(s=0;s<TR3.rotatePart.length;s++){var l=TR3.rotatePart[s][0];n.uuid==l.uuid&&(TR3.rotatePart.splice(s,1),s--)}for(s=0;s<TR3.oscillate.length;s++){var c=TR3.oscillate[s][0];n.uuid==c.uuid&&(TR3.oscillate.splice(s,1),s--)}switch(r){case 1:TR3.oscillate.push([n,6,1,n.position.y]);break;case 2:TR3.rotate.push([n,.02]);break;case 3:TR3.rotatePart.push([n,2,1,1]);break;case 4:n.TR3.animation=!1}}break;case 27:TR3.keyScape()}if(TR3.transformControls.enabled&&n&&n.TR3&&"Sprite"!==n.type&&"PointLight"!==n.type)switch(e.keyCode){case 71:n.edgesTC=!n.edgesTC,n.edgesTC?n.traverse(function(e){var t,o;e.isMesh&&(o=e.geometry,o=new THREE.EdgesGeometry(o),t=new THREE.LineBasicMaterial({color:13421772}),(o=new THREE.LineSegments(o,t)).name="edges",e.add(o))}):TR3.keyScape();break;case 73:TR3.transCtrlsEnabled(!1);var d=n.position,T=(p=TR3.pscs.getPscsValues()).ball.mass,R=p.ball.impulse,m=TR3.getRayCaster([new THREE.Vector3(TR3.camera.position.x,d.y,TR3.camera.position.z),new THREE.Vector3(d.x,d.y,d.z)],"point-point");TR3.pscs.makePscObj({pos:n.position,mass:T,mesh:n,dir:m.ray.direction.multiplyScalar(R),customShape:p.customShapes});break;case 65:!1===TR3.cloneObj?(TR3.cloneObj=!0,TR3.canvasDest.style.cursor="crosshair"):TR3.keyScape();break;case 77:TR3.transCtrlsEnabled(!1);var d=n.position,p=TR3.pscs.getPscsValues();n.TR3&&(n.TR3.mass=p.ball.mass),TR3.pscs.makePscObj({pos:d,mass:p.ball.mass,mesh:n,customShape:p.customShapes});break;case 70:n.TR3.transformMesh?n.TR3.transformMesh+=1:n.TR3.transformMesh=1,TR3.transformMeshByObj3d();break;case 88:TR3.keyScape(),n.TR3.floorMesh=!n.TR3.floorMesh;break;case 79:d=TR3.getCoordsByXYmod(n.position.x,n.position.z);n.position.y=d[4]-+n.TR3.box.min.y*n.scale.y,n.TR3.zFalse=!0;break;case 83:var u='<div id="addTextureObj">\t\t\t\t\t\t\t\t<input id="addTexture" type="file" accept=".jpg,.png,.jpeg,.gif" style="opacity: 0; position: absolute;">\t\t\t\t\t\t\t\t<input id="addTexture_fake" style="color: gray;" value=" Explorar Image... ">\t\t\t\t\t\t\t</div>';document.getElementById("advices").innerHTML=u,document.getElementById("addTexture").addEventListener("change",function(e){TR3.handleTexture(e)},!1),$("#advices").dialog({height:100}),$("#advices").dialog("open");break;case 76:var T=TR3.coordM2T(n.position.x,n.position.y,n.position.z),g=TR3.getSizeObj(n),h=g[1][0]/TR3.adjustMapScale,y=g[0][0]/TR3.adjustMapScale,g=g[2][0]/TR3.adjustMapScale,v=THREE.MathUtils.radToDeg(n.rotation.x),f=THREE.MathUtils.radToDeg(n.rotation.y),b=THREE.MathUtils.radToDeg(n.rotation.z),u='<div id="infohelp3dObj" style="padding:10px 40px;height: 500px;">\t\t\t\t\t\t\t\t<div align="center"><b>Position</b></div>\t\t\t\t\t\t\t\t<input id="hidden3D" style="display: none" value="" autofocus><br>\t\t\t\t\t\t\t\t<b><span>X: </span></b><input id="Xpos3D" type="text" style="" value="'+T[0]+'"><br>\t\t\t\t\t\t\t\t<b><span>Y: </span></b><input id="Ypos3D" type="text" style="" value="'+T[1]+'"><br>\t\t\t\t\t\t\t\t<b><span>Z: </span></b><input id="Zpos3D" type="text" style="" value="'+T[2]+'"><br>\t\t\t\t\t\t\t\t<div align="center"><b>Size</b></div>\t\t\t\t\t\t\t\t<b><span>Alto: </span></b><input id="Height3D" type="text" style="" value="'+h+'"><br>\t\t\t\t\t\t\t\t<b><span>Largo: </span></b><input id="Width3D" type="text" style="" value="'+y+'"><br>\t\t\t\t\t\t\t\t<b><span>Profundo: </span></b><input id="Depth3D" type="text" style="" value="'+g+'"><br>\t\t\t\t\t\t\t\t<label><input type="checkbox" id="normalizeSize"> Proporcionar</label><br>\t\t\t\t\t\t\t\t<div align="center"><b>Angle</b></div>\t\t\t\t\t\t\t\t<b><span>W: </span></b><input id="Wangle3D" type="text" style="" value="'+v+'"><br>\t\t\t\t\t\t\t\t<b><span>Phi: </span></b><input id="PHIangle3D" type="text" style="" value="'+f+'"><br>\t\t\t\t\t\t\t\t<b><span>K: </span></b><input id="Kangle3D" type="text" style="" value="'+b+'"><br>\t\t\t\t\t\t\t\t<div align="center"><input id="UpdateData3D" type="button"  onclick="TR3.UpdateKeys3D(76)" value=" Actualizar Datos " style="margin-left:10px" class=""><br>\t\t\t\t\t\t\t\t<input id="UpdateGeom3D" type="button"  onclick="TR3.UpdateGeom3D(1)" value=" Posición " style="margin-left:10px" class="">\t\t\t\t\t\t\t\t<input id="UpdateGeom3D" type="button"  onclick="TR3.UpdateGeom3D(2)" value=" Tamaño " style="margin-left:10px" class="">\t\t\t\t\t\t\t\t<input id="UpdateGeom3D" type="button"  onclick="TR3.UpdateGeom3D(3)" value=" Ángulo " style="margin-left:10px" class="">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>';document.getElementById("advices").innerHTML=u,$("#advices").dialog({height:590}),$("#advices").dialog("open");break;case 84:n.transparentTC=!n.transparentTC,n.transparentTC?n.traverse(function(e){if(e.isMesh){var t=e.material;if(t.length)for(var o=0;o<t.length;o++){var a=t[o];a.transparent||(a.transparentTC=a.opacity,a.opacity=.25,a.transparent=!0)}else(t=e.material).transparent||(t.side=2,t.sideTC=t.side,t.transparentTC=t.opacity,t.opacity=.25,t.transparent=!0)}}):TR3.keyScape();break;case 67:n.clippingPlanes?TR3.keyScape():(TR3.controls.enableZoom=!1,T=(TR3.getSizeObj(n)[3].max.y+TR3.getSizeObj(n)[3].min.y)/2,a=new THREE.Plane(new THREE.Vector3(0,-1,0),T),n.traverse(function(e){if(e.isMesh){var t=e.material;if(t.length)for(var o=0;o<t.length;o++)t[o].clippingPlanes=[a];else t.clippingPlanes=[a]}}),n.clippingPlanes=!0)}if("85"==e.keyCode)for(s=0;s<TR3.vGeom.obj3d.length;s++)(E=TR3.vGeom.obj3d[s]).isFloor&&1==E.isFloor&&(m=TR3.getRayCaster([TR3.camera.position,new THREE.Vector3(0,1,0)],"point-vector",0,3),M=TR3.getIntersect(m,[E])[0][0])&&(s=TR3.vGeom.obj3d.length,x=M.point,TR3.changeHeight(x.y+TR3.moveKey.size,!0,!1));if("68"==e.keyCode)for(var E,M,x,s=0;s<TR3.vGeom.obj3d.length;s++)(E=TR3.vGeom.obj3d[s]).isFloor&&1==E.isFloor&&(m=TR3.getRayCaster([TR3.camera.position,new THREE.Vector3(0,-1,0)],"point-vector",TR3.moveKey.size+1,5),M=TR3.getIntersect(m,[E])[0][0])&&(s=TR3.vGeom.obj3d.length,x=M.point,TR3.changeHeight(x.y+TR3.moveKey.size,!0,!1));if("80"==e.keyCode&&(m=TR3.getRayCaster(TR3.cursor.event),M=TR3.getIntersect(m,[TR3.mesh])[0][0])&&M.point&&TR3.controls.target.set(M.point.x,M.point.y,M.point.z),"75"==e.keyCode&&TR3.vGeom.polig){var w=TR3.vGeom.item[TR3.vGeom.item.length-1];if("LineLoop"==w.type){for(var d=w.geometry.getAttribute("position").array,S=[],C=[],I=[],s=0;s<w.nPoint;s++)S.push([d[3*s],d[3*s+2]]),C.push(d[3*s]),I.push(d[3*s+2]);S.push([d[0],d[2]]);var D=new THREE.Vector3(TR3.middPoint(C),0,TR3.middPoint(I)),D=TR3.extrudeFromShape2D(S,D);D.children[1].material.side=THREE.DoubleSide,TR3.scene.add(D)}}if(1==TR3.camera.visible&&"17"==e.keyCode&&(D=Math.round(16777215*Math.random()),D=new THREE.Mesh(new THREE.BoxGeometry(.12,.12,1),new THREE.MeshBasicMaterial({color:D})),o=new THREE.Vector3(1,-1,0).unproject(TR3.camera),D.position.copy(o),D.quaternion.copy(TR3.camera.quaternion),TR3.scene.add(D),m=TR3.getRayCaster(),D.pos=o,D.vector=m.ray.direction,D.cont=0,D.colision=!1,D.distFrames=!1,TR3.pscs.plasmaBalls.push(D)),1==TR3.camera.visible&&"66"==e.keyCode&&(D=(p=TR3.pscs.getPscsValues().ball).mass,t=p.size/2,R=2*p.impulse,t=new THREE.Mesh(new THREE.SphereGeometry(t,10,10),new THREE.MeshBasicMaterial({color:Math.round(16777215*Math.random())})),o=new THREE.Vector3(1,-1,0).unproject(TR3.camera),(m=TR3.getRayCaster()).ray.direction.multiplyScalar(R),TR3.scene.add(t),TR3.pscs.makePscObj({pos:o,dir:m.ray.direction,mesh:t,mass:D})),"16"==e.keyCode)if(TR3.camera.visible=!TR3.camera.visible,0==TR3.camera.visible){for(s=1;s<TR3.vGeom.build.length;s++)TR3.vGeom.build[s].material.side=0;for(s=0;s<TR3.pscs.plasmaBalls.length;s++)TR3.scene.remove(TR3.pscs.plasmaBalls[s]);TR3.pscs.plasmaBalls=[]}else for(s=1;s<TR3.vGeom.build.length;s++)TR3.vGeom.build[s].material.side=2},TR3.UpdateKeys3D=function(e){var t=new Array;t.keyCode=e,TR3.keyDown(t)},TR3.UpdateGeom3D=function(e){var t,o,a,n,r,s,i,l,c,d=TR3.transformControls.object;1==e?(a=+document.getElementById("Xpos3D").value,t=+document.getElementById("Ypos3D").value,o=+document.getElementById("Zpos3D").value,a=TR3.coordM2T(a,t,o,!0),d.position.set(a[0],a[1],a[2])):2==e?(t=document.getElementById("Width3D").value,o=document.getElementById("Height3D").value,a=document.getElementById("Depth3D").value,n=+(s=TR3.getSizeObj(d))[1][0]/TR3.adjustMapScale,i=t/(r=+s[0][0]/TR3.adjustMapScale),l=o/n,c=a/(s=+s[2][0]/TR3.adjustMapScale),document.getElementById("normalizeSize").checked&&(t/r!=1?i=l=c=i:o/n!=1?i=l=c=l:a/s!=1&&(i=l=c)),d.scale.x=d.scale.x*i,d.scale.y=d.scale.y*l,d.scale.z=d.scale.z*c):3==e&&(d.rotation.x=0,d.rotation.y=0,d.rotation.z=0,d.rotateX(THREE.MathUtils.degToRad(+document.getElementById("Wangle3D").value)),d.rotateY(THREE.MathUtils.degToRad(+document.getElementById("PHIangle3D").value)),d.rotateZ(THREE.MathUtils.degToRad(+document.getElementById("Kangle3D").value))),TR3.UpdateKeys3D(76)},TR3.keyUp=function(e){TR3.moveKey.is=!1,TR3.transformControls.enabled&&17===e.keyCode&&(TR3.transformControls.setTranslationSnap(null),TR3.transformControls.setRotationSnap(null))},TR3.keyScape=function(){var a,e=TR3.transformControls.object;e.clippingPlanes&&"boolean"==typeof e.clippingPlanes&&(TR3.controls.enableZoom=!0,a=new THREE.Plane(new THREE.Vector3(0,-1,0),1/0),e.traverse(function(e){if(e.isMesh){var t=e.material;if(t.length)for(var o=0;o<t.length;o++)t[o].clippingPlanes=[a];else t.clippingPlanes=[a]}}),e.clippingPlanes=!1),e.userData.physicsBody&&(TR3.pscs.physicsWorld.removeRigidBody(e.userData.physicsBody),e.userData.physicsBody=!1,e.TR3.mass=!1),e.transparentTC&&"boolean"==typeof e.transparentTC&&(e.transparentTC=!1,e.traverse(function(e){if(e.isMesh){var t=e.material;if(t.length)for(var o=0;o<t.length;o++){var a=t[o];a.transparentTC&&(a.opacity=a.transparentTC,a.transparent=!1)}else t.transparentTC&&(t.opacity=t.transparentTC,t.transparent=!1)}})),e.TR3.transformMesh&&"number"==typeof e.TR3.transformMesh&&(e.TR3.transformMesh=4,TR3.transformMeshByObj3d()),e.TR3.floorMesh&&(e.TR3.floorMesh=!1),"boolean"==typeof TR3.cloneObj&&(TR3.cloneObj=!1,TR3.canvasDest.style.cursor="default"),e.edgesTC&&"boolean"==typeof e.edgesTC&&(e.edgesTC=!1,e.traverse(function(e){"edges"==e.name&&e.parent.remove(e)})),e.visible=!0,TR3.transCtrlsEnabled(!1)},TR3.extrudeFromShape2D=function(e,t,o){o=o||Number(window.prompt("Prysm size:",""));for(var a=TR3.extrude2Dfeature(e,o||1,[t.x,t.z],!0),n=new THREE.Group,r=0;r<a.length-1;r++)a[r].position.set(0,0,0),n.add(a[r]);n.TR3=new Object,n.TR3.zFalse=!0,n.TR3.slctItem=!0;var s=TR3.getSizeObj(a[1]);return n.TR3.box=s[3],n.TR3.hitbox=s[4],n.TR3.extraData=new Object,n.TR3.extraData.changed=!0,n.TR3.source={vertex2D:e,center:t,sizePrysm:o},n.position.set(t.x,0,t.z),TR3.vGeom.obj3d.push(n),n},TR3.handleTexture=function(e){var t,i;TR3.sourceTexture=!1,e.target.files?(t=e.target.files[0],document.getElementById(e.target.id+"_fake").value=t.name,TR3.sourceTexture={blob:(window.URL||window.webkitURL).createObjectURL(t),src:t.name},3==(i=TR3.transformControls.object).children.length?(new THREE.TextureLoader).load(TR3.sourceTexture.blob,function(e){e.flipY=!1,e.wrapS=e.wrapT=THREE.RepeatWrapping;for(var t=i.TR3.hitbox.y/3*TR3.adjustMapScale,o=3*e.image.width*TR3.adjustMapScale/e.image.height,a=i.children[1].geometry.getAttribute("position"),n=a.array,r=0,s=0;s<a.count;s++)r+=Math.sqrt(Math.pow(n[s]-n[s+2],2)+Math.pow(n[s+3]-n[s+3+2],2));e.repeat.set(Math.floor(r/o),t);o=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide});i.children[1].material=o,document.getElementById("addTexture_fake").value="Explorar Imagen..."}):i.material&&i.TR3.source.geom?(new THREE.TextureLoader).load(TR3.sourceTexture.blob,function(e){e.flipY=!1,e.wrapS=e.wrapT=THREE.RepeatWrapping;var t=i.TR3.hitbox.y/3*TR3.adjustMapScale,o=3*e.image.width*TR3.adjustMapScale/e.image.height,a=Math.PI*((i.TR3.hitbox.x+i.TR3.hitbox.z)/2),a=(e.repeat.set(Math.floor(a/o),t),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide}));i.material=a,document.getElementById("addTexture_fake").value="Explorar Imagen..."}):(new THREE.TextureLoader).load(TR3.sourceTexture.blob,function(n){i.traverse(function(e){if(e.isMesh){var t=e.material,o=new THREE.MeshBasicMaterial({map:n,side:THREE.DoubleSide});if(t.length)for(var a=0;a<t.length;a++)t[a]=o;else e.material=o}})})):alert("Acción no soportada por su navegador, actualicese o utilice algún otro"),$("#advices").dialog("close")},TR3.getDist=function(e,t,o,a,n,r){for(var s,i,l=(r-o)/TR3.adjustMapScale,c=(TR3.distAlt+=l,s=TR3.formatMeasure(TR3.distAlt),TR3.getCoordsDistance([e,t],[a,n])),l=(TR3.dist2D+=c,i=TR3.formatMeasure(TR3.dist2D),TR3.dist3D+=Math.sqrt(Math.pow(c,2)+Math.pow(l,2)),c=TR3.formatMeasure(TR3.dist3D),TR3.setSegmentsByTerr(e,t,o,a,n,r,3)),d=l[1],T=new Array,R=0;R<d.length;R++)T.push(new THREE.Vector3(d[R][0],d[R][1],d[R][2]));e=TR3.makeVectFeat(T,"Line",{color:65280},{reload:!1});return TR3.scene.add(e),TR3.distTerr+=l[0],t=TR3.formatMeasure(TR3.distTerr),c={name:"Dist.3D",val:c[0],unit:c[1]},t={name:"Dist.terr",val:t[0],unit:t[1]},[{name:"Dist.2D",val:i[0],unit:i[1]},c,t,{name:"Dif.alt",val:s[0],unit:s[1]}]},TR3.getSurf=function(e,t){e.push(e[0]);for(var o=0,a=0,n=0,r=[],s=[],i=0,l=0;l<e.length-1;l++){for(var c=e[l][0],d=e[l][1],T=e[l][2],R=e[l+1][0],m=e[l+1][1],p=e[l+1][2],u=TR3.setSegmentsByTerr(c,d,T,R,m,p,3),g=0;g<u[1].length-1;g++)r.push(new THREE.Vector3(u[1][g][0],u[1][g][1],u[1][g][2])),s.push(new THREE.Vector2(u[1][g][0],u[1][g][2]));n+=u[0];for(var h,p=(p-T)/TR3.adjustMapScale,T=TR3.getCoordsDistance([c,d],[R,m]),y=(a+=T,o+=Math.sqrt(Math.pow(T,2)+Math.pow(p,2)),TR3.getSelectableObj()),g=0;g<y.length;g++)(h=y[g]).TR3&&h.TR3.floorMesh&&TR3.getCoordsByXYmod(e[l][0],e[l][1],[h],!0)[6]&&i++}if(i==e.length-1)M=h;else{for(var v=THREE.ShapeUtils.triangulateShape(s,[]),f=(new THREE.BufferGeometry).setFromPoints(r),b=[],l=0;l<v.length;l++)b.push(v[l][0],v[l][1],v[l][2]);f.setIndex(b);var E={color:"#777777",side:THREE.DoubleSide,transparent:!0,opacity:.75},M=TR3.makeMeshFeat(f,"Basic",E,{reload:!0})}TR3.scene.add(M);for(var x=t.geometry.getAttribute("position"),w=[],S=[],C=[],l=0;l<t.nPoint;l++){var I=TR3.coordM2T(x.getX(l),x.getY(l),x.getZ(l));w.push(new THREE.Vector2(I[0],I[1])),S.push(new THREE.Vector2(x.getX(l),x.getZ(l))),C.push(new THREE.Vector3(x.getX(l),x.getY(l),x.getZ(l)))}for(var E=TR3.formatMeasure(Math.abs(THREE.ShapeUtils.area(w)),"surf"),D=THREE.ShapeUtils.triangulateShape(S,[]),f=(new THREE.BufferGeometry).setFromPoints(C),b=[],k=0,z=0,P=0,l=0;l<D.length;l++){var H=D[l][0],B=D[l][1],G=D[l][2],x=(f.setIndex(b.push(H,B,G)),f.getAttribute("position")),H=new THREE.Vector3(x.getX(H),x.getY(H),x.getZ(H)),B=new THREE.Vector3(x.getX(B),x.getY(B),x.getZ(B)),G=new THREE.Vector3(x.getX(G),x.getY(G),x.getZ(G)),H=new THREE.Triangle(H,B,G),B=(k+=Math.abs(H.getArea()),TR3.makeSubTriangles([H],3)),G=TR3.get3dMetrics(B,M);z+=G[0],P+=G[1]}var O=TR3.formatMeasure(k,"surf"),j=TR3.formatMeasure(z,"surf"),A=TR3.formatMeasure(P,"vol"),a=TR3.formatMeasure(a),o=TR3.formatMeasure(o),n=TR3.formatMeasure(n);return[{name:"Per.2D",val:a[0],unit:a[1]},{name:"Per.3D",val:o[0],unit:o[1]},{name:"Per.terr",val:n[0],unit:n[1]},{name:"Surf.2D",val:E[0],unit:E[1]},{name:"Surf.3D",val:O[0],unit:O[1]},{name:"Surf.terr",val:j[0],unit:j[1]},P={name:"Vol.terr",val:A[0],unit:A[1]}]},TR3.makeSubTriangles=function(e,t){for(var t=t||1,o=TR3.tPixMesh*TR3.tPixMesh/2/t,a=0,n=new Array,a=0;a<e.length;a++){var r=e[a],s=new THREE.Vector3((r.a.x+r.b.x+r.c.x)/3,(r.a.y+r.b.y+r.c.y)/3,(r.a.z+r.b.z+r.c.z)/3),i=new Array;i.push(r.a,r.b,r.c,r.a);for(var l=0;l<i.length-1;l++){var c=s,d=i[l],T=i[l+1],R=new THREE.Vector3((d.x+T.x)/2,(d.y+T.y)/2,(d.z+T.z)/2),d=new THREE.Triangle(c,R,d),d=(n.push(d),new THREE.Triangle(c,R,T));n.push(d)}}return Math.abs(n[0].getArea())>o?TR3.makeSubTriangles(n,t):n},TR3.get3dMetrics=function(e,t){for(var o=0,a=0,n=TR3.makeMeshFeat("","Group","",{reload:!0}),r=0;r<e.length;r++){var s=[],i=TR3.getCoordsByXYmod(e[r].a.x,e[r].a.z,!1),i=(s.push(new THREE.Vector3(i[3],i[4],i[5])),TR3.getCoordsByXYmod(e[r].b.x,e[r].b.z,!1)),i=(s.push(new THREE.Vector3(i[3],i[4],i[5])),TR3.getCoordsByXYmod(e[r].c.x,e[r].c.z,!1)),i=(s.push(new THREE.Vector3(i[3],i[4],i[5])),(new THREE.BufferGeometry).setFromPoints(s)),l=new THREE.MeshBasicMaterial({color:"#00ff00",wireframe:!0}),i=new THREE.Mesh(i,l),l=(n.add(i),new THREE.Triangle(s[0],s[1],s[2])),i=Math.abs(l.getArea()),s=(o+=i,[]),l=(s.push(new THREE.Vector3(e[r].c.x,0,e[r].b.z)),s.push(new THREE.Vector3(e[r].c.x,0,e[r].b.z)),s.push(new THREE.Vector3(e[r].c.x,0,e[r].b.z)),new THREE.Triangle(s[0],s[1],s[2])),s=(Math.abs(l.getArea())+i)/2,l=new THREE.Vector2((e[r].a.x+e[r].b.x+e[r].c.x)/3,(e[r].a.z+e[r].b.z+e[r].c.z)/3),i=TR3.getCoordsByXYmod(l.x,l.y,!1),l=TR3.getCoordsByXYmod(l.x,l.y,[t]);a+=s*(i[2]-l[2])}return TR3.scene.add(n),[o,a]},TR3.setSegmentsByTerr=function(e,t,o,a,n,r,s,i){for(var l=new Array,c=new Array,o=(1==i&&(e=(i=TR3.coordM2T(e,t,o))[0],t=i[1],o=i[2],a=(i=TR3.coordM2T(a,n,r))[0],n=i[1],r=i[2]),Math.ceil(Math.abs((a-e)/TR3.tPixMesh))),i=Math.ceil(Math.abs((n-t)/TR3.tPixMesh)),d=Math.max(o,i)*s,T=0,R=(a-e)/d,m=(n-t)/d,p=0;p<d;p++){var u=TR3.getCoordsByXYmod(e+R*p,t+m*p,!1,!0);l.push([u[3],u[4],u[5]]),c.push([u[0],u[1],u[2]]);var g,h=(g=TR3.getCoordsByXYmod(e+R*(p+1),t+m*(p+1),!1,!0))[2]-u[2],u=TR3.getCoordsDistance([u[0],u[1]],[g[0],g[1]]);T+=Math.sqrt(Math.pow(u,2)+Math.pow(h,2))}return null!=g&&(l.push([g[3],g[4],g[5]]),c.push([g[0],g[1],g[2]])),[T,l,c]},TR3.getCoordsDistance=function(e,t){var o;return"undefined"!=typeof ol?(o=TR3.srsImg,e=ol.proj.toLonLat(e,o),t=ol.proj.toLonLat(t,o),ol.sphere.getDistance(e,t)):"undefined"!=typeof L?(o="EPSG:4326",e=L.latLng(proj4(proj4.defs(TR3.srsImg),proj4.defs(o),e)),t=L.latLng(proj4(proj4.defs(TR3.srsImg),proj4.defs(o),t)),e.distanceTo(t)):Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2))},TR3.getCoordsDistance3D=function(e,t){var o=(t[2]-e[2])/(TR3.adjustMapScale||1),e=TR3.getCoordsDistance([e[0],e[1]],[t[0],t[1]]);return Math.sqrt(Math.pow(e,2)+Math.pow(o,2))},TR3.formatMeasure=function(e,t){return e=e||1,t="surf"==t?1e6<Math.abs(e)?(e=(e/1e6).toFixed(3),"km2"):(e=e.toFixed(2),"m2"):"vol"==t?1e9<Math.abs(e)?(e=(e/1e9).toFixed(3),"km3"):(e=e.toFixed(2),"m3"):1e3<Math.abs(e)?(e=(e/1e3).toFixed(3),"km"):(e=e.toFixed(2),"m"),[e,t]},TR3.setCloneObj=function(e){var t=TR3.SkeletonUtilsClone(e),e=(t.TR3=JSON.parse(JSON.stringify(e.TR3)),t.TR3.blob=0,t.TR3.extraData&&(t.TR3.extraData.id="",t.TR3.extraData.changed=!0),new THREE.Vector3),e=(TR3.cursor.coordClick?(e.x=TR3.cursor.coordClick.x,e.y=TR3.cursor.coordClick.y,e.z=TR3.cursor.coordClick.z,e.y=TR3.operaValues(-1*t.TR3.box.min.y*t.scale.y,e.y,"suma")):console.log("fail position Clone"),t.position.set(e.x,e.y,e.z),t.TR3.aRotate);e&&("boolean"==typeof e[0]||"number"==typeof e[0]?"boolean"==typeof e[0]?TR3.rotate.push([t,.02]):t.rotation.y=e[0]:"boolean"==typeof e?TR3.rotate.push([t,.02]):t.rotation.y=e),TR3.vGeom.obj3d||(TR3.vGeom.obj3d=new Array(0)),TR3.vGeom.obj3d.push(t),TR3.scene.add(t)},TR3.makeMultiPos=function(e,t,o,a,n,r,s){for(var i=e.scene,l=1;l<t.length;l++){var c=t[l],d=o[l],T=n[l]||new Array,R=r[l],m=s[l],p=TR3.coordM2T(c[0],c[1],c[2],!0),u=new THREE.Vector3;u.x=p[0],u.y=p[1],u.z=p[2],u.w=c[2],TR3.makeClon(e,i,u,d,a,T,R,m)}},TR3.makeClon=function(e,t,o,a,n,r,s,i){var l=t.clone(),c=new Array;Object.assign(c,e),l.TR3=new Object,l.TR3=JSON.parse(JSON.stringify(t.TR3)),l.TR3.slctItem=s,l.TR3.aRotate=i,l.TR3.extraData=r,void 0!==t.TR3.mass&&"number"==typeof t.TR3.mass&&(TR3.pscs.physicsWorld?l.TR3.mass=t.TR3.mass:l.TR3.mass=t.TR3.mass.toString()),a&&(l.TR3.isPixSize?(e=l.TR3.hitbox,a[0]=TR3.pix2geo(a[0])/e.x,a[1]=TR3.pix2geo(a[1])/e.z,a[2]=TR3.pix2geo(a[2])/e.y):l.TR3.isRealSize&&(r=a[0]/l.TR3.hitbox.y,(a=new Array)[0]=r,a[1]=r,a[2]=r),l.scale.set(a[0],a[2],a[1])),i&&("boolean"==typeof i[0]||"number"==typeof i[0]?"boolean"==typeof i[0]&&!0===i[0]?TR3.rotate.push([l,.02]):"number"==typeof i[0]&&(l.rotation.y=i):"boolean"!=typeof i&&"number"!=typeof i||("boolean"==typeof i&&!0===i?TR3.rotate.push([l,.02]):"number"==typeof i&&(l.rotation.y=i))),0<c.animations.length&&n&&((t=new THREE.AnimationMixer(l)).clipAction(c.animations[l.TR3.animateAction]).play(),TR3.mixer.push(t)),0==o.w&&(o.y=TR3.operaValues(-1*l.TR3.box.min.y*l.scale.y,o.y,"suma")),l.position.set(o.x,o.y,o.z),c.scene=l,TR3.vGeom.obj3d||(TR3.vGeom.obj3d=new Array(0)),!1!==s&&TR3.vGeom.obj3d.push(c),TR3.loadedFiles.push(c)},TR3.handleFileSelect=function(e){var t,o;TR3.sourceFile=!1,e.target.files?(t=e.target.files[0],document.getElementById(e.target.id+"_fake").value=t.name,TR3.sourceFile={blob:(window.URL||window.webkitURL).createObjectURL(t),src:t.name},(o=new FileReader).onload=function(){for(var e=!0,t=0;t<TR3.blobs.length;t++)TR3.blobs[t].src==TR3.sourceFile.src&&(e=!1);!0===e&&TR3.blobs.push({src:TR3.sourceFile.src,blobText:o.result}),TR3.canvasDest.style.cursor="crosshair"},o.readAsDataURL(t)):alert("Acción no soportada por su navegador, actualicese o utilice algún otro")},TR3.loadFile=function(t){var e,o=$.Deferred(),a=!!(t=void 0===t?{}:t).hasOwnProperty("src")&&t.src,n=document.getElementById("size3dObj"),r=(n.innerHTML="","loaderGLTF");return a?e=(e=a.split("."))[e.length-1]:(e=TR3.sourceFile.src.split(".")[1].toLowerCase(),a=TR3.sourceFile.blob,t.src=TR3.sourceFile.src,t.slctItem=!0,t.persist2Scene=!0),"ifc"==e&&(t.isFloor=!0,r="loaderIFC"),t.ext=e,!a||"glb"!=e&&"ifc"!=e?console.log("error srcLoad or extension"):TR3[r].load(a,function(e){TR3.loaderGLTFsucces(e,o,t)},function(e){n.innerHTML=Math.round(e.loaded/e.total*100)+"% loaded"},function(e){n.innerHTML="error: "+e.message,console.log(e),TR3.unlock3d("obj3d")}),o.promise()},TR3.loaderGLTFsucces=function(e,t,o){var a=!!(o=void 0===o?{}:o).hasOwnProperty("pos")&&o.pos,n=!o.hasOwnProperty("animation")||o.animation,r=!!o.hasOwnProperty("scale")&&o.scale,s=!!o.hasOwnProperty("aRotate")&&o.aRotate,i=!!o.hasOwnProperty("apilator")&&o.apilator,l=!!o.hasOwnProperty("slctItem")&&o.slctItem,c=!!o.hasOwnProperty("isPixSize")&&o.isPixSize,d=!!o.hasOwnProperty("isRealSize")&&o.isRealSize,T=!!o.hasOwnProperty("isFloor")&&o.isFloor,R=!!o.hasOwnProperty("src")&&o.src,m=!!o.hasOwnProperty("ext")&&o.ext,p=!!o.hasOwnProperty("persist2Scene")&&o.persist2Scene,u=!!o.hasOwnProperty("mass")&&o.mass,g=o.hasOwnProperty("extraData")?o.extraData:new Array,h=o.hasOwnProperty("animateAction")?o.animateAction:0,p=(e.persist2Scene=p,e.scene||e),y=TR3.getSizeObj(p);p.TR3=new Object,p.TR3.box=y[3],p.TR3.hitbox=y[4],p.TR3.radius=y[5],p.TR3.srcLoad=R,p.TR3.isPixSize=c,p.TR3.isRealSize=d,p.TR3.aRotate=s,p.TR3.mass=u,p.TR3.animateAction=h,Array.isArray(l)?p.TR3.slctItem=l[0]:l&&(p.TR3.slctItem=l);document.getElementById("size3dObj").innerHTML="<b>X:</b>"+(y[0][0]/TR3.adjustMapScale).toFixed(2)+y[0][1]+" <b>Y:</b>"+(y[2][0]/TR3.adjustMapScale).toFixed(2)+y[2][1]+" <b>Z:</b>"+(y[1][0]/TR3.adjustMapScale).toFixed(2)+y[1][1];var v,R=!1,d=(e.animations&&0<e.animations.length&&n&&(R=!0,(c=new THREE.AnimationMixer(p)).clipAction(e.animations[h]).play(),TR3.mixer.push(c)),"object"==typeof g[0]?p.TR3.extraData=g[0]:g&&(p.TR3.extraData=g),p.TR3.source=JSON.parse(JSON.stringify(o)),!1),y=new THREE.Vector3,h=("object"==typeof a[0]?(0==a[0][2]&&(d=!0),v=TR3.coordM2T(a[0][0],a[0][1],a[0][2],!0),y.x=v[0],y.y=v[1],y.z=v[2]):a?(0==a[2]&&(d=!0),v=TR3.coordM2T(a[0],a[1],a[2],!0),y.x=v[0],y.y=v[1],y.z=v[2]):(d=!0,TR3.cursor.coordClick?(y.x=TR3.cursor.coordClick.x,y.y=TR3.cursor.coordClick.y,y.z=TR3.cursor.coordClick.z):console.log("fallo loaderGLTFsucces")),[1,1,1]);r&&(h="object"==typeof r[0]?JSON.parse(JSON.stringify(r[0])):JSON.parse(JSON.stringify(r)),p.TR3.isPixSize?(c=p.TR3.hitbox,h[0]=TR3.pix2geo(h[0])/c.x,h[1]=TR3.pix2geo(h[1])/c.z,h[2]=TR3.pix2geo(h[2])/c.y):p.TR3.isRealSize&&(o=h[0]/p.TR3.hitbox.y,h[0]=o,h[1]=o,h[2]=o),p.scale.set(h[0],h[2],h[1])),s&&("boolean"==typeof s[0]||"number"==typeof s[0]?"boolean"==typeof s[0]&&!0===s[0]?TR3.rotate.push([p,.02]):"number"==typeof s[0]&&(p.rotation.y=s):"boolean"!=typeof s&&"number"!=typeof s||("boolean"==typeof s&&!0===s?TR3.rotate.push([p,.02]):"number"==typeof s&&(p.rotation.y=s))),T&&(e.isFloor=T),m&&(e.ext=m),!0===d&&(y.y=TR3.operaValues(-1*p.TR3.box.min.y*p.scale.y,y.y,"suma"),p.TR3.zFalse=!0),p.position.set(y.x,y.y,y.z),void 0!==u&&"number"==typeof u&&(TR3.pscs.physicsWorld?p.TR3.mass=u:(p.TR3.mass=u.toString(),console.log("tooFast 2 physics"))),TR3.vGeom.obj3d||(TR3.vGeom.obj3d=new Array(0)),!1===l&&!R||TR3.vGeom.obj3d.push(e),TR3.sourceFile?(TR3.scene.add(p),TR3.transCtrlsEnabled(p)):(TR3.sourceFile="",document.getElementById("file_3d_fake").value="Explorar GLB/IFC..."),i&&!isNaN(i)&&TR3.makeApilator(e,r,i,n),"object"==typeof a[0]&&TR3.makeMultiPos(e,a,r,n,g,l,s),TR3.loadedFiles.push(e),TR3.onCompleteFilesEv(TR3.loadedFiles),t.resolve(TR3.loadedFiles),TR3.loadedFiles=new Array,document.getElementById("file_3d").value="",document.getElementById("file_3d_fake").value=" Explorar GLB/IFC... ",TR3.sourceFile=!1,TR3.canvasDest&&TR3.canvasDest.style&&(TR3.canvasDest.style.cursor="default")},TR3.pscs.physicsConf=function(){var e=new Ammo.btDefaultCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),o=new Ammo.btDbvtBroadphase,a=new Ammo.btSequentialImpulseConstraintSolver;TR3.pscs.physicsWorld=new Ammo.btDiscreteDynamicsWorld(t,o,a,e),TR3.pscs.physicsWorld.setGravity(new Ammo.btVector3(0,-9.8,0)),TR3.pscs.transformAux1=new Ammo.btTransform},TR3.pscs.setGround=function(){TR3.mesh.userData.physicsBody&&(TR3.pscs.physicsWorld.removeRigidBody(TR3.mesh.userData.physicsBody),TR3.mesh.userData.physicsBody=!1);var e=TR3.mesh.position,t=TR3.pscs.createTerrainShapePscs(),o=new Ammo.btTransform,e=(o.setIdentity(),o.setOrigin(new Ammo.btVector3(e.x,e.y,e.z)),new Ammo.btVector3(0,0,0)),o=new Ammo.btDefaultMotionState(o),o=new Ammo.btRigidBody(new Ammo.btRigidBodyConstructionInfo(0,o,t,e));TR3.pscs.physicsWorld.addRigidBody(o),TR3.mesh.userData.physicsBody=o},TR3.pscs.rainPhy=function(){for(var e=TR3.pscs.getPscsValues().zone,t=TR3.mesh.geometry.getAttribute("position"),o=TR3.reducMeshW,a=TR3.reducMeshH,n=0,r=Math.random(),s=r*TR3.formatMeasure(TR3.tPixMesh)[0]/10,i=new THREE.SphereGeometry(e.size,10,10),l=new THREE.MeshBasicMaterial({color:Math.round(16777215*r)}),c=1;n<a*o-2*+o;c++)for(var n=c*e.interval*o,d=1;d<o-1;){var T=new THREE.Vector3,R=(T.x=t.getX(n+d)+TR3.mesh.position.x+s,T.z=t.getZ(n+d)+TR3.mesh.position.z+s,T.y=1.1*TR3.zM2T(TR3.zMax,!0)+100,new THREE.Vector3(e.direction[0],e.direction[1],e.direction[2])),m=(R.multiplyScalar(e.impulse),new THREE.Mesh(i,l));TR3.pscs.rain.push(m),TR3.scene.add(m),TR3.pscs.makePscObj({pos:T,dir:R,mesh:m,mass:e.mass}),d+=e.interval}},TR3.pscs.createTerrainShapePscs=function(){for(var e=TR3.reducMeshW,t=TR3.reducMeshH,o=TR3.zone,a=TR3.mesh.geometry.getAttribute("position"),n=Ammo._malloc(4*e*t),r=0,s=0,i=0;i<t;i++)for(var l=0;l<e;l++){var c=a.getY(r);Ammo.HEAPF32[n+s>>2]=c,r++,s+=4}var d=new Ammo.btHeightfieldTerrainShape(e,t,n,1,TR3.zM2T(TR3.zMin,!0),TR3.zM2T(TR3.zMax,!0),1,"PHY_FLOAT",!1),T=(o[2]-o[0])/(e-1),o=(o[3]-o[1])/(t-1);return d.setLocalScaling(new Ammo.btVector3(T,1,o)),d.setMargin(.05),d},TR3.pscs.updatePhysics=function(e){TR3.pscs.physicsWorld&&TR3.pscs.physicsWorld.stepSimulation&&TR3.pscs.physicsWorld.stepSimulation(e,10);for(var t=0,o=TR3.pscs.dynamicObjects.length;t<o;t++){var a=TR3.pscs.dynamicObjects[t],n=!1,r=(a.TR3&&(n=a.TR3.TCactive),a.userData.physicsBody);!n&&r&&(n=r.getMotionState())&&(n.getWorldTransform(TR3.pscs.transformAux1),r=TR3.pscs.transformAux1.getOrigin(),n=TR3.pscs.transformAux1.getRotation(),a.position.set(r.x(),r.y(),r.z()),a.quaternion.set(n.x(),n.y(),n.z(),n.w()),a.userData.collided=!1)}},TR3.pscs.clearPscsObjs=function(){for(var e=0;e<TR3.pscs.rain.length;e++){var t=TR3.pscs.rain[e];TR3.pscs.physicsWorld.removeRigidBody(t.userData.physicsBody),TR3.scene.remove(t)}TR3.pscs.rain=[],TR3.transCtrlsEnabled(!1)},TR3.pscs.makePscObj=function(e){var t=!!(e=void 0===e?{}:e).hasOwnProperty("pos")&&e.pos,o=!!e.hasOwnProperty("dir")&&e.dir,a=!!e.hasOwnProperty("angVel")&&e.angVel,n=!!e.hasOwnProperty("mesh")&&e.mesh,r=!!e.hasOwnProperty("customShape")&&e.customShape,s=!!e.hasOwnProperty("mass")&&e.mass,e=!!e.hasOwnProperty("friction")&&e.friction,i=null,l=!1,c=(n.TR3&&n.TR3.hitbox&&!r&&(c=n.scale,d=n.TR3.hitbox,n.TR3.mass=s,d=new THREE.BoxGeometry(d.x*c.x,d.y*c.y,d.z*c.z),c=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.5,wireframe:!0}),(l=new THREE.Mesh(d,c)).position.set(t.x,t,t.z),d=n.quaternion,l.quaternion.set(d.x,d.y,d.z,d.w)),l||n),d=c.geometry.parameters,c=(r?i=TR3.pscs.createTriangleShapeByBufferGeometry(c):d.radius?i=new Ammo.btSphereShape(d.radius):d.depth&&(r=c.scale,i=new Ammo.btBoxShape(new Ammo.btVector3(.5*d.width*r.x,.5*d.height*r.y,.5*d.depth*r.z))),i.setMargin(.05),s),d=new Ammo.btVector3(0,0,0),r=(i.calculateLocalInertia(c,d),new Ammo.btTransform),s=(r.setIdentity(),r.setOrigin(new Ammo.btVector3(t.x,t.y,t.z)),n.quaternion),t=(r.setRotation(new Ammo.btQuaternion(s.x,s.y,s.z,s.w)),new Ammo.btDefaultMotionState(r)),s=new Ammo.btRigidBodyConstructionInfo(c,t,i,d),r=new Ammo.btRigidBody(s),e=e||.5;return r.setFriction(e),o&&r.setLinearVelocity(new Ammo.btVector3(o.x,o.y,o.z)),a&&r.setAngularVelocity(new Ammo.btVector3(a.x,a.y,a.z)),n.userData.physicsBody=r,n.userData.collided=!1,TR3.pscs.dynamicObjects.push(n),0<c&&r.setActivationState(4),TR3.pscs.physicsWorld.addRigidBody(r),[r,n,l]},TR3.pscs.createTriangleShapeByBufferGeometry=function(t){var e=t.geometry,o=new Ammo.btTriangleMesh,a=new Ammo.btVector3(0,0,0),n=new Ammo.btVector3(0,0,0),r=new Ammo.btVector3(0,0,0),s=e.getAttribute("position").array,i=[];for(let e=0;e<s.length;e+=3)i.push({x:s[e],y:s[e+1],z:s[e+2]});for(let e=0;e<i.length-3;e+=3)a.setX(i[e].x*t.scale.x),a.setY(i[e].y*t.scale.y),a.setZ(i[e].z*t.scale.z),n.setX(i[e+1].x*t.scale.x),n.setY(i[e+1].y*t.scale.y),n.setZ(i[e+1].z*t.scale.z),r.setX(i[e+2].x*t.scale.x),r.setY(i[e+2].y*t.scale.y),r.setZ(i[e+2].z*t.scale.z),o.addTriangle(a,n,r,!0);return Ammo.destroy(a),Ammo.destroy(n),Ammo.destroy(r),new Ammo.btConvexTriangleMeshShape(o,!0)},TR3.pscs.getPscsValues=function(){var e=new Object;return e.gravity=parseInt(-1*parseFloat(document.getElementById("gravityZone").value)),e.customShapes=document.getElementById("customShps").checked,e.zone=new Object,e.zone.interval=parseInt(document.getElementById("coverZone").value),e.zone.size=parseFloat(document.getElementById("sizePtlZone").value),e.zone.mass=parseFloat(document.getElementById("massPtlZone").value),e.zone.impulse=parseFloat(document.getElementById("impulsePtlZone").value),e.zone.direction=document.getElementById("dirPtlZone").value.split(",").map(parseFloat),e.emisor=new Object,e.emisor.many=parseInt(document.getElementById("manyPtlEmisor").value),e.emisor.impulse=parseFloat(document.getElementById("impulsePtlEmisor").value),e.emisor.size=parseFloat(document.getElementById("sizePtlEmisor").value),e.emisor.mass=parseFloat(document.getElementById("massPtlEmisor").value),e.ball=new Object,e.ball.impulse=parseFloat(document.getElementById("impulsePtlBall").value),e.ball.size=parseFloat(document.getElementById("sizePtlBall").value),e.ball.mass=parseFloat(document.getElementById("massPtlBall").value),TR3.pscs.physicsWorld&&TR3.pscs.physicsWorld.getGravity().y()!=e.gravity&&TR3.pscs.physicsWorld.setGravity(new Ammo.btVector3(0,e.gravity,0)),e},TR3.pscs.setEmisor=function(){var e=Math.random(),t=TR3.pscs.getPscsValues().emisor,o=new THREE.SphereGeometry(t.size,4,2),e=new THREE.MeshBasicMaterial({color:Math.round(16777215*e)}),e=new THREE.Mesh(o,e),a=new THREE.EdgesGeometry(o),n=new THREE.LineBasicMaterial({color:13421772}),a=new THREE.LineSegments(a,n),n=(e.add(a),o.getAttribute("position").array),a=new THREE.SphereGeometry(t.size/4,4,2),o=new THREE.MeshBasicMaterial({color:7829367}),a=new THREE.Mesh(a,o);if(e.add(a),a.position.set(n[0],n[1],n[2]),!TR3.cursor.coordClick)return console.log("fallo setEmisor"),!1;e.position.set(TR3.cursor.coordClick.x,TR3.cursor.coordClick.y+t.size,TR3.cursor.coordClick.z),e.userData.slctItem=!0,e.TR3=new Object,TR3.pscs.emiters||(TR3.pscs.emiters=new Array(0)),TR3.pscs.emiters.push(e),TR3.vGeom.obj3d||(TR3.vGeom.obj3d=new Array(0)),TR3.vGeom.obj3d.push(e),TR3.scene.add(e),TR3.transCtrlsEnabled(e)},TR3.pscs.goEmisor=function(){if(TR3.pscs.emiters){TR3.transCtrlsEnabled(!1);for(var e=TR3.pscs.getPscsValues().emisor,t=TR3.pscs.emiters,o=Math.random(),a=0;a<t.length;a++)for(var n=t[a],r=new THREE.Mesh(new THREE.SphereGeometry(e.size,10,10),new THREE.MeshBasicMaterial({color:Math.round(16777215*o)})),s=0;s<e.many;s++){var i=n.position,l=n.geometry.getAttribute("position").array,c=new THREE.Vector3,l=(c.x=l[0],c.y=l[1],c.z=l[2],c.applyMatrix4(n.matrixWorld),new THREE.Vector3);l.subVectors(i,c).normalize().negate(),l.multiplyScalar(e.impulse),TR3.scene.add(r),TR3.pscs.makePscObj({pos:n.position,dir:l,mesh:r,mass:e.mass})}}},TR3.pscs.removeEmisors=function(){if(TR3.pscs.emiters){TR3.transCtrlsEnabled(!1);for(var e=TR3.pscs.emiters,t=0;t<e.length;t++){var o=e[t];TR3.del3dObj(o,TR3.vGeom.obj3d),TR3.pscs.physicsWorld.removeRigidBody(o.userData.physicsBody)}TR3.pscs.emiters=[]}},TR3.clearMeshMap=function(e){var t=TR3.canvasDest,o=TR3.scene,a=TR3.renderer;if("evtOl"==e&&TR3.setFeatToOL(),t&&Detector.webgl){var n=function(e){e.dispose();for(var t=0,o=Object.keys(e);t<o.length;t++){var a=e[o[t]];a&&"object"==typeof a&&"minFilter"in a&&a.dispose()}};for(a.dispose(),o.traverse(function(e){if(e.isMesh)if(e.userData&&e.userData.physicsBody&&TR3.pscs.physicsWorld.removeRigidBody(e.userData.physicsBody),e.geometry.dispose(),e.material.isMaterial)n(e.material);else for(var t=0,o=e.material;t<o.length;t++){var a=o[t];n(a)}}),o.remove.apply(o,o.children);0<o.children.length;)o.remove(o.children[0]);TR3.canvasDest=null,t.remove()}else t&&Detector.canvas&&(t.getContext("2d").clearRect(0,0,t.width,t.height),t.remove());t&&(TR3.stopAnimation(),TWEEN.removeAll()),TR3.del_vGeom()},TR3.onCompleteEvMap=function(e){e=new CustomEvent("TR3-onCompleteEvMap",{detail:e});TR3.map.dispatchEvent(e)},TR3.onTransformEvTrue=function(e){e=new CustomEvent("TR3-onTransformEvTrue",{detail:e});TR3.map.dispatchEvent(e)},TR3.onSuprFnc=function(e){e=new CustomEvent("TR3-onSuprFnc",{detail:e});TR3.map.dispatchEvent(e)},TR3.onCreateItem=function(e){e=new CustomEvent("TR3-onCreateItem",{detail:e});TR3.map.dispatchEvent(e)},TR3.onCompleteFilesEv=function(e){e=new CustomEvent("TR3-onCompleteFiles",{detail:e});TR3.map.dispatchEvent(e)},TR3.intersectEvOver=function(e){e=new CustomEvent("TR3-onIntersectEvOver",{detail:e});TR3.map.dispatchEvent(e)},TR3.intersectEvClick=function(e){e=new CustomEvent("TR3-onIntersectEvClick",{detail:e});TR3.map.dispatchEvent(e)},TR3.CameraMoveEvEnd=function(e){e&&console.log(e);e=new CustomEvent("TR3-onCameraMoveEnd",{detail:"an event"});TR3.map.dispatchEvent(e)},TR3.VectorEvEnd=function(e){e&&console.log(e);e=new CustomEvent("TR3-onVectorEnd",{detail:"an event"});TR3.map.dispatchEvent(e)},TR3.MeasureEvEnd=function(e,t){e=new CustomEvent("TR3-onMeasureEnd",{detail:[e,t]});TR3.map.dispatchEvent(e)},TR3.setMeshMap=function(imgOri,dtmOri,bboxImgOri,optionsSet,valuesSet){var imgControl,cursor3d,anaglyph,magnification,autoRotate,wireframeMesh,tentative,terrain,txtSupportWebgl,txtSupportHTML5,hemispheric,moves,imgOrbitalMoves,moves,distRealXc,dostCoordXc,distRealXd,dostCoordXd,distRealXt,dostCoordXt,distRealYc,dostCoordYc,distRealYl,dostCoordYl,distRealYr,dostCoordYr;TR3.loadingDiv=document.getElementById("loadingTerrain"),TR3.imgOri=imgOri,TR3.dtmOri=dtmOri,document.getElementById("3doptions").style.display="none",TR3.bboxImgOri&&JSON.stringify(bboxImgOri)==JSON.stringify(TR3.bboxImgOri)&&TR3.loadingDiv&&TR3.canvasDest&&0==TR3.newMap?(TR3.setImageMesh(imgOri),document.getElementById("3doptions").style.display="block"):(TR3.newMeshMap=1,TR3.newMap=!1,TR3.clearMeshMap(),TR3.bboxImgOri=[eval(bboxImgOri[0]),eval(bboxImgOri[1]),eval(bboxImgOri[2]),eval(bboxImgOri[3])],"longlat"===proj4.Proj(TR3.srsImg).projName?TR3.geo2UTM=4e7/360:TR3.geo2UTM=1,TR3.zone=[TR3.bboxImgOri[0]*TR3.geo2UTM,TR3.bboxImgOri[1]*TR3.geo2UTM,TR3.bboxImgOri[2]*TR3.geo2UTM,TR3.bboxImgOri[3]*TR3.geo2UTM],TR3.centerZone=[(TR3.zone[0]+TR3.zone[2])/2,(TR3.zone[1]+TR3.zone[3])/2],imgControl=optionsSet.imgControl,cursor3d=optionsSet.cursor3d,anaglyph=optionsSet.anaglyph,autoRotate=optionsSet.autoRotate,wireframeMesh=optionsSet.wireframeMesh,tentative=optionsSet.tentative,terrain=optionsSet.terrain,magnification=valuesSet.magnification,TR3.lookAt=valuesSet.lookAt,TR3.divContainer(),TR3.divLoading(),TR3.setMagniValues(magnification),TR3.setMeshZone(),TR3.canvasDest=TR3.cvsDesty(),Detector.canvas?Detector.webgl?TR3.renderer=new THREE.WebGLRenderer({logarithmicDepthBuffer:!0,canvas:TR3.canvasDest,antialias:!0}):(TR3.renderer=new THREE.CanvasRenderer({canvas:TR3.canvasDest}),TR3.widthImg||(txtSupportWebgl="Su navegador parece no soportar WebGl. Por favor, actualice su versión o pruebe algún otro.",alert(txtSupportWebgl),pSupportWebgl=document.createElement("p"),pSupportWebgl.id="pSupportWebgl",pSupportWebgl.style.color="#ff0000",pSupportWebgl.innerHTML=txtSupportWebgl,document.getElementById("initDialog").appendChild(pSupportWebgl),document.getElementById("anaglyphCheck").style.display="none",document.getElementById("anaglyphType").style.display="none")):TR3.widthImg||(txtSupportHTML5="Su navegador parece no soportar HTML5. Por favor, actualice su versión o pruebe algún otro.",alert(txtSupportHTML5),pSupportHTML5=document.createElement("p"),pSupportHTML5.id="pSupportHTML5",pSupportHTML5.style.color="#ff0000",pSupportHTML5.innerHTML=txtSupportHTML5,document.getElementById("initDialog").appendChild(pSupportHTML5),document.getElementById("OptionsDialog").style.display="none"),TR3.renderer.localClippingEnabled=!0,TR3.renderer.physicallyCorrectLights=!0,TR3.renderer.setSize(TR3.canvasDestW,TR3.canvasDestH),TR3.anaglyphRenderer=new TR3.AnaglyphEffect(TR3.renderer,0),TR3.anaglyphRenderer.setSize(TR3.canvasDestW,TR3.canvasDestH),TR3.scene=new THREE.Scene,TR3.clock=new THREE.Clock,TR3.loaderGLTF=new TR3.GLTFLoader,TR3.loaderIFC=new TR3.IFCLoader,TR3.loaderIFC.ifcManager.setWasmPath("../TR3-pack/THREE/loaders/ifc/"),TR3.loaderIFC.ifcManager.applyWebIfcConfig({COORDINATE_TO_ORIGIN:!0,USE_FAST_BOOLS:!0}),TR3.loaderFONT=new TR3.FontLoader,TR3.sky=new TR3.Sky,TR3.sky.name="Sky",TR3.scene.add(TR3.sky),TR3.camera=new THREE.PerspectiveCamera(TR3.fov,TR3.canvasDestW/TR3.canvasDestH,1,13e5),TR3.scene.add(TR3.camera),TR3.camera.visible=!1,hemispheric=new THREE.HemisphereLight(16777215,16777215,2),TR3.scene.add(hemispheric),imgOrbitalMoves=document.getElementById("imgOrbitalMoves"),moves=imgControl?imgOrbitalMoves:TR3.canvasDest,TR3.controls=new TR3.OrbitControls(TR3.camera,moves),TR3.controls.listenToKeyEvents(window),TR3.controls.maxPolarAngle=Math.PI/2.25,TR3.controls.enableDamping=!0,TR3.controls.dampingFactor=.1,TR3.controls.screenSpacePanning=!1,TR3.transformControls=new TR3.TransformControls(TR3.camera,TR3.canvasDest),TR3.transformControls.name="TransformControls",TR3.transformControls.enabled=!1,TR3.scene.add(TR3.transformControls),TR3.transformControls.addEventListener("dragging-changed",function(e){TR3.controls.enabled=!e.value,TR3.CtrlDargClick=!0;var e=TR3.transformControls,t=document.getElementById("size3dObj");e.enabled&&(e=e.object)&&e.parent&&(e=TR3.getSizeObj(e),t.innerHTML="<b>X:</b>"+(e[0][0]/TR3.adjustMapScale).toFixed(2)+e[0][1]+" <b>Y:</b>"+(e[2][0]/TR3.adjustMapScale).toFixed(2)+e[2][1]+" <b>Z:</b>"+(e[1][0]/TR3.adjustMapScale).toFixed(2)+e[1][1])}),distRealXc=TR3.getCoordsDistance([TR3.zone[0],TR3.centerZone[1]],[TR3.zone[2],TR3.centerZone[1]]),dostCoordXc=Math.abs(TR3.zone[2]-TR3.zone[0]),distRealXd=TR3.getCoordsDistance([TR3.zone[0],TR3.zone[1]],[TR3.zone[2],TR3.zone[1]]),dostCoordXd=Math.abs(TR3.zone[0]-TR3.zone[2]),distRealXt=TR3.getCoordsDistance([TR3.zone[0],TR3.zone[3]],[TR3.zone[2],TR3.zone[3]]),dostCoordXt=Math.abs(TR3.zone[0]-TR3.zone[2]),distRealYc=TR3.getCoordsDistance([TR3.zone[1],TR3.centerZone[0]],[TR3.zone[3],TR3.centerZone[0]]),dostCoordYc=Math.abs(TR3.zone[3]-TR3.zone[1]),distRealYl=TR3.getCoordsDistance([TR3.zone[0],TR3.zone[1]],[TR3.zone[0],TR3.zone[3]]),dostCoordYl=Math.abs(TR3.zone[1]-TR3.zone[3]),distRealYr=TR3.getCoordsDistance([TR3.zone[2],TR3.zone[1]],[TR3.zone[2],TR3.zone[3]]),dostCoordYr=Math.abs(TR3.zone[1]-TR3.zone[3]),TR3.adjustMapScale=(dostCoordXc/distRealXc+dostCoordYc/distRealYc+dostCoordYl/distRealYl+dostCoordYr/distRealYr+dostCoordXd/distRealXd+dostCoordXt/distRealXt)/6,TR3.makeSteve(),TR3.makeWorld(imgOri),TR3.persist2Scene(),TR3.setOptions(imgControl,cursor3d,anaglyph,autoRotate,wireframeMesh,tentative,terrain)),0!=TR3.oneMeshMap&&(window.addEventListener("resize",TR3.onWindowResize,!1),TR3.map.addEventListener("mousemove",TR3.onIntersect,!1),TR3.map.addEventListener("contextmenu",TR3.setCoods2clip,!1),TR3.map.addEventListener("click",TR3.click_Obj3d,!1),TR3.map.addEventListener("mousedown",function(e){var t=TR3.getSelectableObj();TR3.cursor.mouseDownID=!1,0<t.length&&TR3.optionsSet.tentative&&(e=TR3.getRayCaster(e),(e=TR3.getIntersect(e,t))[0])&&(TR3.cursor.mouseDownID=e[0][0].object.uuid)},!1),TR3.map.addEventListener("touchstart",function(e){var t=TR3.getSelectableObj();TR3.cursor.mouseDownID=!1,0<t.length&&TR3.optionsSet.tentative&&(e=TR3.getRayCaster(e),(e=TR3.getIntersect(e,t))[0])&&(TR3.cursor.mouseDownID=e[0][0].object.uuid)},!1),TR3.map.addEventListener("touchend",function(e){TR3.click_Obj3d(e)},!1),TR3.map.addEventListener("wheel",TR3.onMouseWheel,!1),window.addEventListener("keydown",TR3.keyDown,!1),window.addEventListener("keyup",TR3.keyUp,!1),console.log("ammo"),TR3.oneMeshMap=0,Ammo().then(function(e){TR3.pscs.physicsConf(),TR3.animate()}))},TR3.onMouseWheel=function(e){var t,r=Math.max(-1,Math.min(1,-e.wheelDelta||e.detail||e.deltaY));TR3.cursor.helper.visible&&TR3.zCursor(r),1==TR3.moveKey.walk&&(e=r*TR3.controls.keyPanSpeed/5,TR3.controls.keyPanSpeed=TR3.controls.keyPanSpeed+e),1==TR3.optionsSet.anaglyph&&(e=TR3.getRayCaster(!1),0<(e=TR3.getIntersect(e,[TR3.mesh])).length)&&(t=TR3.camera.position,TR3.zeroParallax=t.distanceTo(e[0][0].point)),TR3.transformControls.enabled&&(t=TR3.transformControls.object).clippingPlanes&&t.traverse(function(e){if(e.isMesh){var t=e.material;if(t.length)for(var o=0;o<t.length;o++){var a=t[o],n=a.clippingPlanes[0].constant+r/60;a.clippingPlanes[0].constant=n}else{n=t.clippingPlanes[0].constant+r/3;t.clippingPlanes[0].constant=n}}})},TR3.onWindowResize=function(){TR3.map.offsetWidth&&(TR3.canvasDest.width=TR3.map.offsetWidth,TR3.canvasDest.height=TR3.map.offsetHeight,TR3.canvasDestW=TR3.map.offsetWidth,TR3.canvasDestH=TR3.map.offsetHeight,TR3.camera.aspect=TR3.canvasDestW/TR3.canvasDestH,TR3.camera.updateProjectionMatrix(),TR3.renderer.setSize(TR3.canvasDestW,TR3.canvasDestH))},TR3.onCompleteMap=function(){if(TR3.lookAt&&TR3.setLookAt(TR3.lookAt),!TR3.mesh.userData.physicsBody&&TR3.pscs.physicsWorld?TR3.pscs.setGround():setTimeout(function(){TR3.pscs.setGround()},1e3),TR3.scene&&TR3.scene.children)for(var e=0;e<TR3.scene.children.length;e++){var t,o,a,n=TR3.scene.children[e];n.TR3&&("string"==typeof n.position.y&&(a=(o=n.position.y.replaceAll("$","")).slice(-1),t=+o.slice(0,-1),t=o&&"T"==a?TR3.zM2T(t,!0):"P"==a?TR3.zM2T(TR3.pix2geo(t),!0)-TR3.zM2T(0,!0):o.replace(a,""),n.position.y=+t),1==n.TR3.zFalse&&(o=TR3.getCoordsByXYmod(n.position.x,n.position.z,!1),a=TR3.operaValues(-1*n.TR3.box.min.y*n.scale.y,o[4],"suma"),n.position.y=a),"string"==typeof n.TR3.mass)&&(n.TR3.mass=+n.TR3.mass,TR3.pscs.makePscObj({pos:n.position,mass:n.TR3.mass,mesh:n}))}setTimeout(function(){TR3.loadingDiv.style.display="none"},500),TR3.loadingDiv.style.display="block",TR3.dfd_setMap.resolve(TR3.mesh),document.getElementById("3doptions").style.display="block",(TR3.newMeshMap=0)<TR3.oneMeshMap&&TR3.oneMeshMap--,TR3.onCompleteEvMap()},TR3.persist2Scene=function(){if(TR3.vGeom.obj3d)for(var e=0;e<TR3.vGeom.obj3d.length;e++){var t=TR3.vGeom.obj3d[e];1==t.persist2Scene&&(t=t.scene||(t.parent&&t.parent.scene?t.parent.scene:t),TR3.scene.add(t))}},TR3.lock3d=function(e){TR3.cursor.causeLock+=e},TR3.unlock3d=function(e){-1<TR3.cursor.causeLock.indexOf(e)&&(e=TR3.cursor.causeLock.split(e),TR3.cursor.causeLock=e.toString().replace(/,/g,""))},TR3.rectaValue=function(e,t,o,a,n){return(n-e)/(o-e)*(a-t)+t},TR3.rectaValue3D=function(e,t,o,a,n,r,s){return[s,TR3.rectaValue(e,t,a,n,s),TR3.rectaValue(e,o,a,r,s)]},TR3.geo2pix=function(e){return+e/(TR3.tPixImg*TR3.geo2UTM)},TR3.pix2geo=function(e){return e*(TR3.tPixImg*TR3.geo2UTM)},TR3.getSizePix=function(){return((TR3.zone[2]-TR3.zone[0])/TR3.widthImg+(TR3.zone[3]-TR3.zone[1])/TR3.heightImg)/2},TR3.setAzAngle=function(e){var t=TR3.controls.getAzimuthalAngle(),e=e<=0?-e:2*Math.PI-e,t=t<=0?-t:2*Math.PI-t;e>2*Math.PI&&(e-=2*Math.PI),t>2*Math.PI&&(t-=2*Math.PI);t=0<(t=t-e)?2*Math.PI-t:Math.abs(t);"function"==typeof TR3.controls.rotateLeft&&TR3.controls.rotateLeft(t)},TR3.getOptModCoordCam=function(){for(var e=TR3.camera.position,t=-1e7,o=new Array,a=2*TR3.getSizePix(),n=TR3.controls.getAzimuthalAngle(),r=e.x+a*Math.sin(n),s=e.z-a*Math.cos(n),i=0;i<TR3.vGeom.obj3d.length;i++){var l=TR3.vGeom.obj3d[i];l.isFloor&&1==l.isFloor&&(l=TR3.getCoordsByXYmod(r,s,[l],!1,e.y))&&1==l[6]&&o.push(l)}o.push(TR3.getCoordsByXYmod(r,s,!1,!1,e.y));for(i=0;i<o.length;i++)o[i]&&t<o[i][4]&&(t=o[i][4]);return[e.x,t,e.z]},TR3.getCoordsByXYmod=function(e,t,o,a,n){var r,s,i,l,c,d,n=(n=n||!1)||TR3.zM2T(TR3.zMax+500,!0)*TR3.valuesSet.magnification*3,T=Math.abs(TR3.zM2T(TR3.zMin-500,!0)*TR3.valuesSet.magnification*3),o=o||[TR3.mesh],a=(a&&(e-=TR3.centerZone[0],t=-(t-TR3.centerZone[1])),new THREE.Vector3(e,n,t)),R=new THREE.Vector3(0,-1,0),a=TR3.getRayCaster([a,R],"point-vector",0,n+T),R=TR3.getIntersect(a,o)[0][0];return T=R?(n=R.point,r=TR3.centerZone[0]+n.x,s=TR3.centerZone[1]-n.z,i=TR3.zM2T(n.y,!1),l=n.x,c=n.y,d=n.z,!0):(r=e+TR3.centerZone[0],s=-t+TR3.centerZone[1],i=TR3.zMed,l=e,c=TR3.zM2T(TR3.zMed,!0),d=t,!1),[r,s,i,l,c,d,T]},TR3.translate2DbyXYmod=function(e,t,o){o=o?-(TR3.centerZone[0]-e):e+TR3.centerZone[0];e=TR3.centerZone[1]-t;return[o,e]},TR3.coordM2T=function(e,t,o,a){var n,r,s,i;if(a){if(!(i=TR3.getCoordsByXYmod(e,t,!1,!0)))return!1;o||0===o||(o=i&&i[2]?i[2]:TR3.zM2T(TR3.zMed,!0)),n=i[3],r=TR3.zM2T(o,a),s=i[5]}else{if(!(i=TR3.getCoordsByXYmod(e,o,!1)))return!1;t||0===t||(t=i&&i[5]?i[5]:TR3.zM2T(TR3.zMed)),n=i[0],r=i[1],s=TR3.zM2T(t=0===t?0:t,a)}return[n,r,s]},TR3.zM2T=function(e,t){var o=t?(e-TR3.zMed)*TR3.valuesSet.magnification:e/TR3.valuesSet.magnification+TR3.zMed;return"string"!=typeof e?t?"number"==typeof o&&!isNaN(o)||(o="$"+e+"$T"):"number"==typeof o&&!isNaN(o)||(o="$"+e+"$M"):o=e,o},TR3.makeVectFeat=function(e,t,o,a){var n=new THREE.BufferGeometry,r=Math.round(16777215*Math.random()),s=new Array;if(s.color=o.color||r,s.side=o.side||THREE.DoubleSide,s.transparent=o.transparent||!1,s.wireframe=o.wireframe||!1,s.opacity=o.opacity||1,"Circle"==t){for(var r=new THREE.CircleGeometry(e.w,20),i=(r.rotateX(Math.PI/2),r.vertices),l=0;l<i.length;l++){i[l].x=e.x+i[l].x,i[l].z=e.z+i[l].z;var c=TR3.getCoordsByXYmod(i[l].x,i[l].z,!1);c?i[l].y=c[4]:e.y?i[l].y=e.y:i[l].y=TR3.zMed}i.push(i[1]),i.shift(),n.setFromPoints(i);var d=new THREE.LineBasicMaterial({color:s.color}),T=new THREE.LineLoop(n,d)}else T=new("Point"==t?(n.setFromPoints(e),o=50*TR3.getSizePix(),d=new THREE.PointsMaterial({color:s.color,size:o}),THREE.Points):"Poligon"==t?(n.setFromPoints(e),d=new THREE.LineBasicMaterial({color:s.color}),THREE.LineLoop):(n.setFromPoints(e),d=new THREE.LineBasicMaterial({color:s.color}),THREE.Line))(n,d);return a&&(T.reload=a.reload||!1,T.magni=TR3.valuesSet.magnification,TR3.vGeom.item.unshift(T)),T},TR3.makeMeshFeat=function(e,t,o,a){var n,r=Math.round(16777215*Math.random()),s=new Array,r=(s.color=o.color||r,s.side=o.side||THREE.DoubleSide,s.transparent=o.transparent||!1,s.wireframe=o.wireframe||!1,s.opacity=o.opacity||1,new THREE.MeshBasicMaterial({color:s.color,side:s.side,transparent:s.transparent,wireframe:s.wireframe,opacity:s.opacity}));return"Basic"==t?n=new THREE.Mesh(e,r):"Group"==t&&(n=new THREE.Group),a&&(n.reload=a.reload||!1,n.magni=TR3.valuesSet.magnification,TR3.vGeom.item.unshift(n)),n},TR3.setLookAtini=function(e,t){var o=TR3.zone,o=TR3.coordM2T(o[2]-.1,o[1]+.1,0,!0),a=TR3.mesh.position.x,n=TR3.mesh.position.y,t=(("number"!=typeof e||isNaN(e)||e<5)&&(e=100),("number"!=typeof t||isNaN(t)||t<0)&&(t=4),TR3.cameraPositionFar*t/100),r=TR3.getCoordsDistance3D([a,n,0],[o[0],-o[2],t]),o=TR3.rectaValue3D(a,n,0,o[0],-o[2],t,a+e/100*r);TR3.setLookAt([a,0,n,o[0],t,o[1]])},TR3.setLookAt=function(e){var t,o={x:e[3],y:e[4],z:e[5]},a=new THREE.Vector3(e[0],e[1],e[2]);e[6]&&!0===e[6]&&(t=TR3.coordM2T(t[3],t[4],t[5],!0),e=TR3.coordM2T(t[0],t[1],t[2],!0),o={x:t[0],y:t[1],z:t[2]},a=new THREE.Vector3(e[0],e[1],e[2])),new TWEEN.Tween(TR3.camera.position).to(o,1e3).easing(TWEEN.Easing.Linear).on("start",function(){TR3.controls.target=a,TR3.controls.update(),TR3.lookAt=!1}).on("complete",function(){TR3.mesh.rotation.z=0,TR3.CameraMoveEvEnd()}).start()},TR3.goScenes=function(e){e=e||TR3.config.actual.loc;TR3.config.lookAt=e.look,TR3.setLookAt(TR3.config.lookAt,e),TR3.setOpts({autoRotate:!0})},TR3.oscillator=function(e,t,o,a,n){return Math.sin(e*t*Math.PI*2+a*Math.PI*2)*o+n},TR3.operaValues=function(e,t,o){var a,n,r;return"string"==typeof t?(n=(r=t.replaceAll("$","")).slice(-1),r=+r.slice(0,-1),"suma"==o&&(a="$"+(r+e)+"$"+n)):"suma"==o&&(a=t+e),a},TR3.del3dObj=function(e,t,o){var a,n;if(t&&0<t.length){if(e||TR3.transformControls.enabled){a=e||TR3.transformControls.object,TR3.transCtrlsEnabled(!1);for(var r=0;r<t.length;r++){var s=!1,i=t[r];i[0]&&(i=i[0],s=!0),i=(i.scene||i).uuid,a.uuid==i&&(s&&((a=new Array).push(t[r][0]),a.push(t[r][1])),n=r,r=t.length)}}if(void 0===n&&(n=t.length-1),a.scene)TR3.scene.remove(a.scene);else if(0<a.length)for(r=0;r<a.length;r++)TR3.scene.remove(a[r]);else TR3.scene.remove(a);t.splice(n,1),!0!==o&&TR3.onSuprFnc(a)}},TR3.transCtrlsEnabled=function(e){var t;if("object"==typeof e&&(TR3.transformControls.attach(e),e=!0),e)(t=TR3.transformControls.object)&&t.TR3&&(t.TR3.TCactive=!0),t.TR3.zFalse=!1,TR3.onTransformEvTrue(TR3.transformControls),TR3.lock3d("obj3d");else{if(TR3.unlock3d("obj3d"),t=TR3.transformControls.object){if(t.userData.physicsBody){TR3.pscs.physicsWorld.removeRigidBody(t.userData.physicsBody);for(var o=0;o<TR3.pscs.dynamicObjects.length;o++)TR3.pscs.dynamicObjects[o].uuid==t.uuid&&(TR3.pscs.dynamicObjects.splice(o,1),o=TR3.pscs.dynamicObjects.length);t.userData.physicsBody=new Object}TR3.transformMeshByObj3d(),t.TR3&&(t.TR3.TCactive=!1)}TR3.transformControls.detach(),TR3.controls.enableZoom=!0}TR3.transformControls.enabled=e,TR3.transformControls.showX=e,TR3.transformControls.showY=e,TR3.transformControls.showZ=e},TR3.getSizeObj=function(e){var t=new THREE.Vector3,e=(new THREE.Box3).setFromObject(e),o=(e.getSize(t),e.getBoundingSphere(new THREE.Sphere));return[TR3.formatMeasure(t.x),TR3.formatMeasure(t.y),TR3.formatMeasure(t.z),e,t,o.radius,o.center]},TR3.getIgridByXY=function(e,t){var o=TR3.reducMeshW;return!(o<=e)&&o*t+e},TR3.getXYgridByI=function(e){var t=TR3.reducMeshW,o=TR3.reducMeshH,a=(e/t-parseInt(e/t))*t,e=parseInt(e/t);return!(t<=a||o<=e)&&[a,e]},TR3.lonLat2google=function(e){for(var t=new Array,o=0;o<e.length;o++){var a=20037508.34*e[o][0]/180,n=Math.log(Math.tan((90+e[o][1])*Math.PI/360))/(Math.PI/180);t.push([a,20037508.34*n/180])}return t},TR3.getIndexMeshZoneFromObj3d=function(e){for(var t,o,a=e.position,n=TR3.getSizeObj(e)[4],e=e.scale,r=n.x*e.x/2,s=n.z*e.z/2,i=-n.x*e.x/2,n=-n.z*e.z/2,l=[a.x+i,a.z+n,a.x+r,a.z+s],c=!0,d=!0,T=TR3.mesh.geometry.getAttribute("position"),R=0;R<T.count;R++){var m=T.getX(R),p=T.getZ(R*TR3.reducMeshW);l[0]<m&&!0===c&&(t=R,c=!1),l[1]<p&&!0===d&&(o=R,d=!1),!1===c&&!1===d&&(R=T.count)}for(var u=Math.floor((l[2]-l[0])/TR3.tPixMesh),g=Math.floor((l[3]-l[1])/TR3.tPixMesh),h=new Array,R=0;R<g;R++)for(var y=0;y<u;y++)h.push(TR3.getIgridByXY(t+y,o+R));return h},TR3.transformMeshByObj3d=function(e){TR3.assignZmeshByIndex();var t=TR3.mesh.geometry.getAttribute("position"),o=new Array;e?o.push(e):o=TR3.getSelectableObj();for(var a=0;a<o.length;a++){var n=o[a],r=n;if(n.scene?r=n.scene:n.parent&&n.parent.scene&&(r=n.parent.scene),r.TR3&&r.TR3.transformMesh){var s=TR3.getIndexMeshZoneFromObj3d(r);switch(r.TR3.transformMesh){case 1:for(var i=0;i<s.length;i++){var l=(new THREE.Vector3).fromBufferAttribute(t,s[i]),c=TR3.getRayCaster([l,new THREE.Vector3(0,1,0)],"point-vector",0,!1),d=TR3.getIntersect(c,[r])[0][0],T=TR3.getRayCaster([l,new THREE.Vector3(0,-1,0)],"point-vector",0,!1),R=TR3.getIntersect(T,[r])[0][0];d&&R?d.distance<R.distance?t.setY(s[i],d.point.y):t.setY(s[i],R.point.y):d?t.setY(s[i],d.point.y):R&&t.setY(s[i],R.point.y)}break;case 2:for(i=0;i<s.length;i++){l=(new THREE.Vector3).fromBufferAttribute(t,s[i]),c=TR3.getRayCaster([l,new THREE.Vector3(0,1,0)],"point-vector",0,!1);(d=TR3.getIntersect(c,[r])[0][0])&&t.setY(s[i],d.point.y)}break;case 3:for(i=0;i<s.length;i++){l=(new THREE.Vector3).fromBufferAttribute(t,s[i]),T=TR3.getRayCaster([l,new THREE.Vector3(0,-1,0)],"point-vector",0,!1);(R=TR3.getIntersect(T,[r])[0][0])&&t.setY(s[i],R.point.y)}break;case 4:r.TR3.transformMesh=!1}t.needsUpdate=!0,TR3.mesh.geometry.computeVertexNormals()}}TR3.pscs.setGround()},TR3.middPoint=function(e){return(Math.max(...e)+Math.min(...e))/2},TR3.makeWorld=function(e){"object"==typeof e?TR3.makeObjects(e):-1==e.toUpperCase().indexOf("HTTP://")?TR3.obtainImageFromID(e):TR3.obtainImageFromPath(e)},TR3.obtainImageFromPath=function(e){var t=new Image,o=5;t.onload=function(){TR3.makeObjects(t)},t.onerror=function(){0<=o?(t.src=e,o--):(alert("can not load image correctly"),TR3.loadingDiv.style.display="none")},t.crossOrigin="anonymus",t.src=e},TR3.obtainImageFromID=function(e){e=document.getElementById(e);TR3.makeObjects(e)},TR3.makeScene=function(){var e=2*TR3.fov*Math.PI/360,t=TR3.zone,o=TR3.tPixMesh,o=TR3.rectaValue(2828,1e7,6,3e4,o),o=(TR3.controls.keyPanSpeed=o=o<5e3?5e3:o,TR3.controls.enableKeys=!1,TR3.moveKey.walk=!1,TR3.zeroParallax=TR3.cameraPositionFar=Math.cos(e/2)*(t[3]-t[1])/(2*Math.sin(e/2)),TR3.camera.position.set(0,TR3.cameraPositionFar/TR3.cameraDist,0),TR3.getCoordsByXYmod(t[0],t[1],!1,!0)),e=new THREE.DirectionalLight(16777215,1),o=(e.position.set(o[3],TR3.cameraPositionFar/4,o[5]),e.target.position.set(0,0,0),TR3.scene.add(e),TR3.scene.add(e.target),e.target.updateMatrixWorld(),TR3.getCoordsByXYmod(t[2],t[1],!1,!0));(e=new THREE.DirectionalLight(16777215,1)).position.set(o[3],TR3.cameraPositionFar/4,o[5]),e.target.position.set(0,0,0),TR3.scene.add(e),TR3.scene.add(e.target),e.target.updateMatrixWorld(),TR3.mesh.position.set(0,0,0),TR3.centerZone=[+TR3.centerZone[0],TR3.centerZone[1]- -0],TR3.controls.target.set(0,0,0),TR3.camera.near=1,TR3.camera.far=5e6,TR3.camera.fov=TR3.fov,TR3.cursor.helper.scale.set(1,1,1),TR3.renderScene(),TR3.initSky(0,0,0)},TR3.initSky=function(e,t,o){var a=TR3.scene.getObjectByName("Sky"),e=(a.scale.setScalar(13e5),a.position.set(e,t,o),a.rotation.y=Math.PI/2,new THREE.Vector3),t=0,o=.5,n=.005,r=.7,s=.49,i=.25,l=.5;(a=a.material.uniforms).turbidity.value=t,a.rayleigh.value=o,a.mieCoefficient.value=n,a.mieDirectionalG.value=r,t=Math.PI*-(s-.5),o=2*Math.PI*-(i-.5),e.x=Math.cos(o),e.y=Math.sin(o)*Math.sin(t),e.z=Math.sin(o)*Math.cos(t),a.sunPosition.value.copy(e),TR3.renderer.toneMappingExposure=l,TR3.renderer.render(TR3.scene,TR3.camera)},TR3.makeSteve=function(){var e=new THREE.Vector3(1,-1,0).unproject(TR3.camera),t=[.12,.12,1],o=new THREE.Mesh(new THREE.BoxGeometry(t[0],t[1],t[2]),new THREE.MeshBasicMaterial({color:14540253})),t=(o.position.copy(e),TR3.camera.add(o),new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(t[0],t[1],t[2])),new THREE.LineBasicMaterial({color:11184810}))),o=(o.add(t),new THREE.Object3D);o.position.copy(e),TR3.camera.add(o)},TR3.makeObjects=function(e){TR3.widthImg=e.width,TR3.heightImg=e.height;for(var t=TR3.zone,e=new THREE.Texture(e),e=(e.needsUpdate=!0,e.minFilter=THREE.LinearFilter,new THREE.MeshBasicMaterial({map:e})),o=89;TR3.reducMesh=(1-(o+=1)/100)/TR3.reducDTM,TR3.reducMeshW=Math.round(TR3.widthImg*TR3.reducMesh)+1,TR3.reducMeshH=Math.round(TR3.heightImg*TR3.reducMesh)+1,TR3.getSizePix()/TR3.reducMesh<TR3.maxResolMesh;);TR3.tPixImg=TR3.getSizePix(),TR3.tPixMesh=TR3.tPixImg/TR3.reducMesh;var a=new THREE.PlaneGeometry(t[2]-t[0],t[3]-t[1],TR3.reducMeshW-1,TR3.reducMeshH-1);a.rotateX(-Math.PI/2),TR3.mesh=new THREE.Mesh(a,e),TR3.mesh.geometry.dynamic=!0,TR3.mesh.name="mesh3d",TR3.scene.add(TR3.mesh);(a=new THREE.CylinderGeometry((t[2]-t[0])/200,0,(t[2]-t[0])/50,3)).applyMatrix4((new THREE.Matrix4).makeTranslation(0,(t[2]-t[0])/100,0)),TR3.cursor.helper=new THREE.Mesh(a,new THREE.MeshNormalMaterial),TR3.cursor.helper.name="cursor",TR3.cursor.helper.visible=!1,TR3.scene.add(TR3.cursor.helper),TR3.quaternion=new THREE.Quaternion,TR3.makeScene(),TR3.makeZmesh()},TR3.cvsDesty=function(){var e=document.getElementById("canvasDest");return e&&e.remove(),(e=TR3.canvasDest)||((e=document.createElement("CANVAS")).id="canvasDest",TR3.map.insertAdjacentElement("afterbegin",e)),e},TR3.divLoading=function(e){var e=e||"Map",t=document.getElementById("infoGeo3d"),t=(t||((t=document.createElement("div")).id="infoGeo3d",t.style.position="absolute",t.style.fontSize="10px",t.style.margin="25px",t.style.backgroundColor="#fff",t.style.top="10px",t.style.zIndex="999",TR3.map.appendChild(t)),TR3.loadingDiv);t?(t.innerHTML="&nbsp;&nbsp;&nbsp;Loading ...&nbsp;"+e+"&nbsp;&nbsp;&nbsp;",t.style.display="block"):((t=document.createElement("div")).id="loadingTerrain",t.style.position="absolute",t.style.top="0px",t.style.marginTop=TR3.canvasDestH/2+"px",t.style.marginLeft=TR3.canvasDestW/2.5+"px",t.style.fontSize="20px",t.style.backgroundColor="lightskyblue",t.style.border="solid coral",t.style.color="white",t.innerHTML="&nbsp;&nbsp;&nbsp;Loading ...&nbsp;"+e+"&nbsp;&nbsp;&nbsp;",TR3.map.appendChild(t)),TR3.loadingDiv=t},TR3.divContainer=function(){"object"!=typeof TR3.map&&(TR3.map=document.getElementById(TR3.map)),TR3.canvasDestW=TR3.map.clientWidth||parseInt(TR3.map.style.width)||document.documentElement.offsetWidth,TR3.canvasDestH=TR3.map.clientHeight||parseInt(TR3.map.style.height)||document.documentElement.offsetHeight},TR3.setImageMesh=function(e){e=new THREE.Texture(e);e.needsUpdate=!0,e.minFilter=THREE.LinearFilter,TR3.mesh.material.map=e},TR3.setMeshZone=function(){0==TR3.newMeshMap&&TR3.widthImg&&(TR3.loadingDiv.style.display="block",TR3.makeScene())},TR3.assignZmesh=function(){for(var e=TR3.arrayZ,t=(TR3.zMed=(TR3.zMax+TR3.zMin)/2,TR3.mesh.geometry.getAttribute("position")),o=0;o<e.length;o++)t.setY(o,(e[o]-TR3.zMed)*TR3.valuesSet.magnification);TR3.renderScene(),t.needsUpdate=!0,TR3.mesh.geometry.computeVertexNormals(),setTimeout(function(){TR3.onCompleteMap()},1500)},TR3.assignZmeshByIndex=function(e){var t=TR3.arrayZ,o=TR3.mesh.geometry.getAttribute("position");if(e)for(var a=0;a<e.length;a++)o.setY(e[a],(t[e[a]]-TR3.zMed)*TR3.valuesSet.magnification);else for(a=0;a<t.length;a++)o.setY(a,(t[a]-TR3.zMed)*TR3.valuesSet.magnification);o.needsUpdate=!0,TR3.mesh.geometry.computeVertexNormals()},TR3.obtainZmeshWCS=function(t,o,a,n,r,s,i,e){!e&&TR3.timeoutReq&&TR3.timeoutReq[0]&&clearTimeout(TR3.timeoutReq[0]),TR3.requestDTMwcs&&TR3.requestDTMwcs.abort(),TR3.requestDTMwcs=new XMLHttpRequest;var e=TR3.tPixMesh,l=1e3,e=(1e3<e||(l=e<1e3&&500<=e?1e3:e<500&&200<=e?200:e<200&&25<=e?25:5),proj4(proj4.defs(TR3.srsImg),proj4.defs("EPSG:4326"),[a,n])),c="Elevacion25830_";(e[0]<-13||e[1]<29.5)&&(c="Elevacion4083_"),TR3.requestDTMwcs.open("GET","https://servicios.idee.es/wcs-inspire/mdt?SERVICE=WCS&REQUEST=GetCoverage&VERSION=1.0.0&interpolationMethod=bilinear&FORMAT=ArcGrid&CRS="+i+"&BBOX="+a+","+n+","+r+","+s+"&WIDTH="+t+"&HEIGHT="+o+"&COVERAGE="+c+l),TR3.requestDTMwcs.onload=function(){var e=TR3.requestDTMwcs.responseText;e&&-1!=e.indexOf("\n ")?TR3.readWCS(e,t,o,a,n,r,s,i):TR3.errorDTMwcs(t,o,a,n,r,s,i),TR3.requestDTMwcs=!1},TR3.requestDTMwcs.onerror=function(e){TR3.errorDTMwcs(t,o,a,n,r,s,i)},TR3.requestDTMwcs.send()},TR3.errorDTMwcs=function(e,t,o,a,n,r,s){for(var i=e*t,l=0;l<i;l++)TR3.arrayZ[l]=0;TR3.assignZmesh(),TR3.timeoutReq[1]<3?(TR3.timeoutReq[1]++,TR3.timeoutReq[0]=setTimeout(function(){TR3.obtainZmeshWCS(e,t,o,a,n,r,s,!0)},3e3)):(TR3.timeoutReq[1]=0,clearTimeout(TR3.timeoutReq[0]))},TR3.readWCS=function(txtDTMwcs,widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM){var str="\n ",zConteint=txtDTMwcs.slice(txtDTMwcs.indexOf(str)+str.length),sinSalto=zConteint.replace(/\r\n/g," "),sinFin=sinSalto.slice(0,sinSalto.length-1),arrayZ=sinFin.split(" "),lengthDTM=widthDTM*heightDTM,evalZ,zMin=+arrayZ[0],zMax=+arrayZ[0];if(arrayZ.length<100)TR3.errorDTMwcs(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM);else{for(var i=0;i<lengthDTM;i++)TR3.arrayZ[i]=evalZ=eval(arrayZ[i])/TR3.adjustMapScale,(evalZ<-1e3||4e3<evalZ)&&(TR3.arrayZ[i]=0),TR3.arrayZ[i]<zMin&&(zMin=TR3.arrayZ[i]),TR3.arrayZ[i]>zMax&&(zMax=TR3.arrayZ[i]);TR3.zMin=zMin,TR3.zMax=zMax,TR3.assignZmesh()}},TR3.makeZmesh=function(){var widthDTM=TR3.reducMeshW,heightDTM=TR3.reducMeshH,bboxDTM0=eval(TR3.zone[0])-TR3.tPixMesh/2,bboxDTM1=eval(TR3.zone[1])-TR3.tPixMesh/2,bboxDTM2=eval(TR3.zone[2])+TR3.tPixMesh/2,bboxDTM3=eval(TR3.zone[3])+TR3.tPixMesh/2,srsDTM=TR3.srsImg;TR3.arrayZ=Array(widthDTM*heightDTM).fill(0),TR3.zMin=0,TR3.zMax=0,1==TR3.optionsSet.terrain?(document.getElementById("loadingTerrain").style.display="block",TR3.dtmOri?fetch(TR3.dtmOri).then(e=>e.text()).then(e=>{TR3.readWCS(e,widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM)}):TR3.obtainZmeshWCS(widthDTM,heightDTM,bboxDTM0,bboxDTM1,bboxDTM2,bboxDTM3,srsDTM)):TR3.assignZmesh()},TR3.setMagniValues=function(e){var t,o,a,n,r,s=TR3.valuesSet.magnification;return isNaN(parseFloat(e))?TR3.tPixMesh?(t=TR3.tPixMesh,o=Math.round(TR3.rectaValue(7e3,11,5,1,t)),a=Math.abs(TR3.zMax-TR3.zMin),(0<(n=Math.abs(TR3.zone[2]-TR3.zone[0]))-(r=Math.abs(TR3.zone[3]-TR3.zone[1]))?n:r)/a<=25&&(o/=4),TR3.valuesSet.magnification=o=15<(o=t<90||o<1?1:o)?15:o):TR3.valuesSet.magnification=1:TR3.valuesSet.magnification=Math.round(e),s!=e&&0==TR3.newMeshMap&&TR3.widthImg&&(TR3.assignZmesh(),TR3.assignZgeometries(),TR3.newDraw=-1),TR3.valuesSet.magnification};